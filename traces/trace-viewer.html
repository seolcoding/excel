<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Trace Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --text-primary: #eee;
            --text-muted: #8892b0;
            --accent: #64ffda;
            --user-msg: #3b82f6;
            --assistant-msg: #10b981;
            --system-msg: #f59e0b;
            --tool-msg: #8b5cf6;
        }

        body {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header */
        .trace-header {
            background: var(--primary-gradient);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .trace-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .trace-header .back-link {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
        }

        .trace-header .back-link:hover {
            color: white;
        }

        /* Trace Info */
        .trace-info {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .trace-info .stat {
            text-align: center;
            padding: 10px;
        }

        .trace-info .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent);
        }

        .trace-info .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Agent Timeline */
        .agent-section {
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .agent-header {
            background: rgba(100, 255, 218, 0.1);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .agent-header:hover {
            background: rgba(100, 255, 218, 0.15);
        }

        .agent-name {
            font-weight: 600;
            color: var(--accent);
        }

        .agent-body {
            padding: 20px;
        }

        /* Messages */
        .message {
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
        }

        .message-header {
            padding: 8px 15px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-body {
            padding: 15px;
            background: rgba(0,0,0,0.2);
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 0.9rem;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }

        .message-body.collapsed {
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }

        .message-body.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(transparent, rgba(0,0,0,0.5));
        }

        .message.system .message-header { background: var(--system-msg); color: #000; }
        .message.user .message-header { background: var(--user-msg); }
        .message.assistant .message-header { background: var(--assistant-msg); color: #000; }
        .message.tool .message-header { background: var(--tool-msg); }

        /* Tool Calls */
        .tool-call {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .tool-call-header {
            background: rgba(139, 92, 246, 0.2);
            padding: 10px 15px;
            font-weight: 600;
            color: #c4b5fd;
        }

        .tool-call-body {
            padding: 15px;
        }

        .tool-input, .tool-output {
            margin-bottom: 10px;
        }

        .tool-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .tool-content {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Expand/Collapse */
        .expand-btn {
            background: none;
            border: 1px solid var(--text-muted);
            color: var(--text-muted);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .expand-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Duration Badge */
        .duration-badge {
            background: rgba(255,255,255,0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* No Data */
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--accent);
        }

        /* Footer */
        footer {
            background: rgba(0,0,0,0.3);
            padding: 20px 0;
            margin-top: 40px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        footer a {
            color: var(--accent);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="trace-header">
        <div class="container">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">
                    <a href="../index.html" class="back-link">
                        <i class="bi bi-arrow-left"></i> 목록
                    </a>
                    <h1 id="trace-title">Agent Trace Viewer</h1>
                </div>
                <div class="d-flex gap-2">
                    <a href="#" id="demo-link" class="btn btn-sm btn-light">
                        <i class="bi bi-play-circle"></i> 데모 보기
                    </a>
                    <a href="#" id="download-link" class="btn btn-sm btn-outline-light">
                        <i class="bi bi-download"></i> Excel
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="container py-4">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Trace 데이터 로딩 중...</p>
        </div>

        <!-- No Data State -->
        <div id="no-data" class="no-data" style="display: none;">
            <i class="bi bi-exclamation-triangle"></i>
            <h4>Trace 데이터가 없습니다</h4>
            <p>이 데모에 대한 Agent trace 정보를 찾을 수 없습니다.</p>
        </div>

        <!-- Trace Content -->
        <div id="trace-content" style="display: none;">
            <!-- Stats -->
            <div class="trace-info">
                <div class="row">
                    <div class="col-md-3 stat">
                        <div class="stat-value" id="stat-agents">-</div>
                        <div class="stat-label">Agents</div>
                    </div>
                    <div class="col-md-3 stat">
                        <div class="stat-value" id="stat-llm-calls">-</div>
                        <div class="stat-label">LLM Calls</div>
                    </div>
                    <div class="col-md-3 stat">
                        <div class="stat-value" id="stat-tokens">-</div>
                        <div class="stat-label">Total Tokens</div>
                    </div>
                    <div class="col-md-3 stat">
                        <div class="stat-value" id="stat-duration">-</div>
                        <div class="stat-label">Duration</div>
                    </div>
                </div>
            </div>

            <!-- LLM Calls Timeline -->
            <div id="llm-calls-container"></div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>2026 - Excel → WebApp Converter | <a href="https://github.com/seolcoding/excel" target="_blank">GitHub</a></p>
        </div>
    </footer>

    <script>
        // Get trace ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const traceId = urlParams.get('id');
        const demoNum = urlParams.get('demo');

        // Demo metadata
        const demos = {
            '01': { name: '간이영수증', file: '01-receipt.html', excel: '엑셀 간이영수증 표준 양식 v2.0.xlsx' },
            '02': { name: '종합소득세 계산기', file: '02-income-tax.html', excel: '종합소득세 엑셀 간이 계산기 v2.1.xlsx' },
            '03': { name: '4대보험 자동계산기', file: '03-insurance.html', excel: '4대보험_자동계산기_엑셀템플릿.xlsx' },
            '04': { name: '거래명세표 (자동계산)', file: '04-invoice-auto.html', excel: '거래명세표(자동계산)/3.xlsx' },
            '05': { name: '계산서', file: '05-statement.html', excel: '계산서/계산서.xlsx' },
            '06': { name: '인사기록카드', file: '06-hr-record.html', excel: '인사기록카드(외국인근로자관리)/3.xlsx' },
            '07': { name: '거래명세표', file: '07-invoice.html', excel: '거래명세표1/거래명세표1.xlsx' },
            '08': { name: '자금집행품의서', file: '08-fund-request.html', excel: '자금집행품의서외/3.xlsx' },
            '09': { name: 'CPM 공정표', file: '09-construction.html', excel: 'CPM공정표(네트워크)/1.xlsx' },
            '10': { name: '가계부 (자동화)', file: '10-household.html', excel: '가계부(자동화엑셀)/3.xlsx' }
        };

        // Set up links
        if (demoNum && demos[demoNum]) {
            const demo = demos[demoNum];
            document.getElementById('trace-title').textContent = `${demo.name} - Agent Trace`;
            document.getElementById('demo-link').href = `../demos/${demo.file}`;
            document.getElementById('download-link').href = `../excel_files/${demo.excel}`;
            document.title = `${demo.name} - Agent Trace`;
        }

        // Load trace data
        async function loadTrace() {
            const loadingEl = document.getElementById('loading');
            const noDataEl = document.getElementById('no-data');
            const contentEl = document.getElementById('trace-content');

            try {
                // Try to load trace data
                const traceFile = demoNum ? `${demoNum}-trace.json` : `${traceId}.json`;
                const response = await fetch(traceFile);

                if (!response.ok) throw new Error('Trace not found');

                const trace = await response.json();
                renderTrace(trace);

                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            } catch (e) {
                console.error('Failed to load trace:', e);
                loadingEl.style.display = 'none';
                noDataEl.style.display = 'block';
            }
        }

        function renderTrace(trace) {
            // Stats
            const agents = trace.agents_used || [];
            const llmCalls = trace.llm_calls || [];
            const tokens = trace.total_tokens || 0;

            document.getElementById('stat-agents').textContent = agents.length;
            document.getElementById('stat-llm-calls').textContent = llmCalls.length;
            document.getElementById('stat-tokens').textContent = tokens.toLocaleString();

            // Calculate duration
            if (trace.started_at && trace.ended_at) {
                const start = new Date(trace.started_at);
                const end = new Date(trace.ended_at);
                const durationMs = end - start;
                const durationSec = (durationMs / 1000).toFixed(1);
                document.getElementById('stat-duration').textContent = `${durationSec}s`;
            }

            // Render LLM calls
            const container = document.getElementById('llm-calls-container');
            container.innerHTML = '';

            llmCalls.forEach((call, idx) => {
                const section = document.createElement('div');
                section.className = 'agent-section';
                section.innerHTML = `
                    <div class="agent-header" onclick="toggleSection(this)">
                        <div>
                            <span class="agent-name">${call.agent_name || 'Unknown Agent'}</span>
                            <span class="duration-badge ms-2">${call.duration_ms ? (call.duration_ms/1000).toFixed(1) + 's' : ''}</span>
                        </div>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <div class="agent-body">
                        ${renderSystemPrompt(call.system_prompt)}
                        ${renderMessages(call.input_messages)}
                        ${renderOutput(call.output_content, call.output_tool_calls)}
                    </div>
                `;
                container.appendChild(section);
            });

            // Also render tool calls from the trace if available
            if (trace.tool_calls && trace.tool_calls.length > 0) {
                const toolSection = document.createElement('div');
                toolSection.className = 'agent-section';
                toolSection.innerHTML = `
                    <div class="agent-header" onclick="toggleSection(this)">
                        <div>
                            <span class="agent-name">Tool Calls</span>
                            <span class="badge bg-secondary ms-2">${trace.tool_calls.length}</span>
                        </div>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <div class="agent-body">
                        ${trace.tool_calls.map(tc => renderToolCall(tc)).join('')}
                    </div>
                `;
                container.appendChild(toolSection);
            }
        }

        function renderSystemPrompt(prompt) {
            if (!prompt) return '';
            return `
                <div class="message system">
                    <div class="message-header">
                        <span><i class="bi bi-gear"></i> System Prompt</span>
                        <button class="expand-btn" onclick="toggleExpand(this)">펼치기</button>
                    </div>
                    <div class="message-body collapsed">${escapeHtml(prompt)}</div>
                </div>
            `;
        }

        function renderMessages(messages) {
            if (!messages || messages.length === 0) return '';
            return messages.map(msg => {
                const role = msg.role || msg.type || 'unknown';
                const content = msg.content || '';
                return `
                    <div class="message ${role}">
                        <div class="message-header">
                            <span><i class="bi bi-${role === 'user' ? 'person' : 'robot'}"></i> ${role.toUpperCase()}</span>
                            <button class="expand-btn" onclick="toggleExpand(this)">펼치기</button>
                        </div>
                        <div class="message-body collapsed">${escapeHtml(content)}</div>
                    </div>
                `;
            }).join('');
        }

        function renderOutput(content, toolCalls) {
            let html = '';

            if (content) {
                html += `
                    <div class="message assistant">
                        <div class="message-header">
                            <span><i class="bi bi-robot"></i> ASSISTANT</span>
                            <button class="expand-btn" onclick="toggleExpand(this)">펼치기</button>
                        </div>
                        <div class="message-body collapsed">${escapeHtml(content)}</div>
                    </div>
                `;
            }

            if (toolCalls && toolCalls.length > 0) {
                html += toolCalls.map(tc => `
                    <div class="tool-call">
                        <div class="tool-call-header">
                            <i class="bi bi-tools"></i> ${tc.name || 'Tool Call'}
                        </div>
                        <div class="tool-call-body">
                            <div class="tool-input">
                                <div class="tool-label">Arguments</div>
                                <div class="tool-content">${escapeHtml(tc.arguments || '{}')}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            return html;
        }

        function renderToolCall(tc) {
            return `
                <div class="tool-call">
                    <div class="tool-call-header">
                        <i class="bi bi-tools"></i> ${tc.name}
                        <span class="duration-badge ms-2">${tc.duration_ms ? (tc.duration_ms/1000).toFixed(2) + 's' : ''}</span>
                    </div>
                    <div class="tool-call-body">
                        <div class="tool-input">
                            <div class="tool-label">Input</div>
                            <div class="tool-content">${escapeHtml(tc.input || '')}</div>
                        </div>
                        <div class="tool-output">
                            <div class="tool-label">Output</div>
                            <div class="tool-content">${escapeHtml(tc.output || '')}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleSection(header) {
            const body = header.nextElementSibling;
            const icon = header.querySelector('i');
            body.style.display = body.style.display === 'none' ? 'block' : 'none';
            icon.className = body.style.display === 'none' ? 'bi bi-chevron-right' : 'bi bi-chevron-down';
        }

        function toggleExpand(btn) {
            const body = btn.closest('.message, .tool-call').querySelector('.message-body, .tool-content');
            if (body.classList.contains('collapsed')) {
                body.classList.remove('collapsed');
                btn.textContent = '접기';
            } else {
                body.classList.add('collapsed');
                btn.textContent = '펼치기';
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Load on page ready
        loadTrace();
    </script>
</body>
</html>
