<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê±°ë˜ëª…ì„¸í‘œ ì‘ì„±/ì¶œë ¥</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    :root{
      --app-max-width: 1100px;
      --excel-border: #111;
      --muted: #6c757d;
      --bg-soft: #f8f9fa;
      --font-ko: "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo", "Malgun Gothic", Arial, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    html, body { font-family: var(--font-ko); }
    .app-wrap{ max-width: var(--app-max-width); }

    .section-title{
      font-weight: 700;
      font-size: 1.05rem;
      margin: 0;
    }
    .section-sub{
      color: var(--muted);
      font-size: .9rem;
    }

    .card-like{
      background: #fff;
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 12px;
      box-shadow: 0 1px 10px rgba(0,0,0,.03);
    }

    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    .table-excel{
      border: 1px solid var(--excel-border);
    }
    .table-excel th,
    .table-excel td{
      border: 1px solid var(--excel-border) !important;
      vertical-align: middle;
    }
    .table-excel thead th{
      background: #f2f2f2;
      font-weight: 700;
      text-align: center;
      white-space: nowrap;
    }

    .num{
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    input.num{ text-align: right; }

    .help-text{ color: var(--muted); font-size: .85rem; }

    .error-summary{
      border: 1px solid #f1aeb5;
      background: #f8d7da;
      color: #842029;
      border-radius: 10px;
      padding: 12px;
    }

    /* Print Area (WYSIWYG) */
    #printArea{
      background: #fff;
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 12px;
      padding: 14px;
    }
    .print-sheet{
      width: 100%;
      border: 1px solid var(--excel-border);
      padding: 10mm 9mm 10mm 19mm; /* approximate screen preview margin */
      box-sizing: border-box;
    }
    .print-title{
      text-align: center;
      font-size: 18pt;
      font-weight: 800;
      letter-spacing: .2em;
      margin: 0 0 6mm 0;
    }
    .print-meta{
      display: flex;
      justify-content: space-between;
      gap: 8mm;
      font-size: 10.5pt;
      margin-bottom: 4mm;
    }
    .print-grid{
      width: 100%;
      border-collapse: collapse;
      font-size: 10.5pt;
    }
    .print-grid td, .print-grid th{
      border: 1px solid var(--excel-border);
      padding: 2.2mm 2mm;
      vertical-align: middle;
    }
    .print-grid th{
      background: #f2f2f2;
      text-align: center;
      font-weight: 700;
      white-space: nowrap;
    }
    .print-label{
      background: #f2f2f2;
      width: 18%;
      font-weight: 700;
      white-space: nowrap;
    }
    .print-value{ width: 32%; }
    .print-value span{ display: inline-block; min-height: 1em; }

    .print-items td{ white-space: nowrap; }
    .print-items td.name{ white-space: normal; }

    .print-totals{
      width: 100%;
      border-collapse: collapse;
      font-size: 10.5pt;
      margin-top: 3mm;
    }
    .print-totals td{
      border: 1px solid var(--excel-border);
      padding: 2.2mm 2mm;
    }

    .print-footer{
      margin-top: 3mm;
      font-size: 10.5pt;
    }

    /* Print rules */
    @media print {
      @page {
        size: A4 portrait;
        margin: 10mm 9mm 10mm 19mm;
      }
      body{ background: #fff !important; }
      .no-print{ display: none !important; }
      .container, .app-wrap{ max-width: none !important; }
      #printArea{ border: none !important; padding: 0 !important; }
      .print-sheet{ border: none !important; padding: 0 !important; }
      a[href]:after { content: ""; }
    }
  </style>
</head>
<body>
  <div class="container py-4 app-wrap" x-data="appData()" x-init="init()">

    <!-- Header -->
    <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
      <div>
        <h1 class="h3 mb-1">ê±°ë˜ëª…ì„¸í‘œ ì‘ì„±</h1>
        <div class="text-secondary">ì…ë ¥ â†’ ìë™ê³„ì‚°(í•©ê³„/ë¶€ê°€ì„¸/ì´ì•¡) â†’ A4 ì¶œë ¥</div>
      </div>
      <div class="d-flex gap-2 no-print">
        <button type="button" class="btn btn-outline-secondary" @click="resetAll()">ìƒˆë¡œì‘ì„±</button>
        <button type="button" class="btn btn-primary" @click="print()">PDF/ì¸ì‡„</button>
        <button type="button" class="btn btn-outline-primary" @click="save()">ì €ì¥</button>
      </div>
    </div>

    <!-- Error Summary (aria-live) -->
    <div class="mb-3" aria-live="polite">
      <template x-if="errors.summary.length">
        <div class="error-summary">
          <div class="fw-bold mb-1">ì…ë ¥ ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤.</div>
          <ul class="mb-0">
            <template x-for="(msg, idx) in errors.summary" :key="idx">
              <li x-text="msg"></li>
            </template>
          </ul>
        </div>
      </template>
    </div>

    <div class="row g-3">
      <!-- Left: Forms -->
      <div class="col-12 col-lg-7">
        <form class="card-like p-3" @submit.prevent>

          <!-- Section 1: Parties -->
          <section class="mb-4">
            <div class="d-flex align-items-end justify-content-between mb-2">
              <div>
                <p class="section-title">ê³µê¸‰ì/ê³µê¸‰ë°›ëŠ”ì ì •ë³´</p>
                <p class="section-sub mb-0">ì‘ì„±ì¼ìÂ·ë¬¸ì„œë²ˆí˜¸ ë° ê±°ë˜ ë‹¹ì‚¬ì ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
              </div>
              <div class="help-text no-print">ì…€ ë§¤í•‘(ê°€ì •): Sheet1!B3, V3, B6~B12, N6~N10</div>
            </div>
            <hr class="my-2" />

            <div class="row g-2">
              <div class="col-12 col-md-6">
                <label class="form-label" for="issue_date">ì‘ì„±ì¼ì</label>
                <input class="form-control" type="date" id="issue_date" x-model="header.issue_date" @change="calculate()" aria-required="true">
                <div class="invalid-feedback d-block" x-show="errors.fields.issue_date" x-text="errors.fields.issue_date"></div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="document_no">ë¬¸ì„œë²ˆí˜¸</label>
                <input class="form-control" type="text" id="document_no" x-model.trim="header.document_no" @input="calculate()" placeholder="ì˜ˆ: 2025-0001">
              </div>

              <div class="col-12">
                <div class="row g-2">
                  <div class="col-12 col-md-6">
                    <div class="p-2 rounded" style="background: var(--bg-soft);">
                      <div class="fw-bold mb-2">ê³µê¸‰ì</div>
                      <div class="mb-2">
                        <label class="form-label" for="supplier_company">ìƒí˜¸(ë²•ì¸ëª…)</label>
                        <input class="form-control" type="text" id="supplier_company" x-model.trim="supplier.company" @input="calculate()" aria-required="true">
                        <div class="invalid-feedback d-block" x-show="errors.fields.supplier_company" x-text="errors.fields.supplier_company"></div>
                      </div>
                      <div class="mb-2">
                        <label class="form-label" for="supplier_ceo">ëŒ€í‘œì</label>
                        <input class="form-control" type="text" id="supplier_ceo" x-model.trim="supplier.ceo" @input="calculate()">
                      </div>
                      <div class="mb-2">
                        <label class="form-label" for="supplier_business_no">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label>
                        <input class="form-control" type="text" id="supplier_business_no" x-model.trim="supplier.businessNo" @input="onBusinessNoInput('supplier')" placeholder="123-45-67890">
                        <div class="invalid-feedback d-block" x-show="errors.fields.supplier_business_no" x-text="errors.fields.supplier_business_no"></div>
                      </div>
                      <div class="mb-2">
                        <label class="form-label" for="supplier_address">ì£¼ì†Œ</label>
                        <input class="form-control" type="text" id="supplier_address" x-model.trim="supplier.address" @input="calculate()">
                      </div>
                      <div>
                        <label class="form-label" for="supplier_tel">ì „í™”</label>
                        <input class="form-control" type="text" id="supplier_tel" x-model.trim="supplier.tel" @input="calculate()" placeholder="02-1234-5678">
                      </div>
                    </div>
                  </div>

                  <div class="col-12 col-md-6">
                    <div class="p-2 rounded" style="background: var(--bg-soft);">
                      <div class="fw-bold mb-2">ê³µê¸‰ë°›ëŠ”ì</div>
                      <div class="mb-2">
                        <label class="form-label" for="buyer_company">ìƒí˜¸(ë²•ì¸ëª…)</label>
                        <input class="form-control" type="text" id="buyer_company" x-model.trim="buyer.company" @input="calculate()" aria-required="true">
                        <div class="invalid-feedback d-block" x-show="errors.fields.buyer_company" x-text="errors.fields.buyer_company"></div>
                      </div>
                      <div class="mb-2">
                        <label class="form-label" for="buyer_ceo">ëŒ€í‘œì</label>
                        <input class="form-control" type="text" id="buyer_ceo" x-model.trim="buyer.ceo" @input="calculate()">
                      </div>
                      <div class="mb-2">
                        <label class="form-label" for="buyer_business_no">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label>
                        <input class="form-control" type="text" id="buyer_business_no" x-model.trim="buyer.businessNo" @input="onBusinessNoInput('buyer')" placeholder="123-45-67890">
                        <div class="invalid-feedback d-block" x-show="errors.fields.buyer_business_no" x-text="errors.fields.buyer_business_no"></div>
                      </div>
                      <div class="mb-2">
                        <label class="form-label" for="buyer_address">ì£¼ì†Œ</label>
                        <input class="form-control" type="text" id="buyer_address" x-model.trim="buyer.address" @input="calculate()">
                      </div>
                      <div>
                        <label class="form-label" for="buyer_tel">ì „í™”</label>
                        <input class="form-control" type="text" id="buyer_tel" x-model.trim="buyer.tel" @input="calculate()" placeholder="010-0000-0000">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label" for="tax_mode">ë¶€ê°€ì„¸ ì ìš©</label>
                <select class="form-select" id="tax_mode" x-model="taxMode" @change="calculate()" aria-label="ë¶€ê°€ì„¸ ì ìš©">
                  <option value="TAX_10">ê³¼ì„¸(10%)</option>
                  <option value="ZERO">ì˜ì„¸(0%)</option>
                  <option value="EXEMPT">ë©´ì„¸</option>
                  <option value="INCLUSIVE">ë¶€ê°€ì„¸ í¬í•¨(ì—­ì‚°)</option>
                </select>
                <div class="help-text">ë¶€ê°€ì„¸ í¬í•¨(ì—­ì‚°): ê¸ˆì•¡ ì…ë ¥ì¹¸ì„ â€˜ë¶€ê°€ì„¸ í¬í•¨ê¸ˆì•¡â€™ìœ¼ë¡œ ë³´ê³  ê³µê¸‰ê°€ì•¡/ë¶€ê°€ì„¸ë¥¼ ì—­ì‚°í•©ë‹ˆë‹¤.</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="notes_header">ë¹„ê³ (ìƒë‹¨)</label>
                <input class="form-control" type="text" id="notes_header" x-model.trim="header.notes" @input="calculate()" placeholder="ì˜ˆ: ë‚©ê¸°/í”„ë¡œì íŠ¸ëª… ë“±">
              </div>
            </div>
          </section>

          <!-- Section 2: Items -->
          <section class="mb-4">
            <div class="d-flex align-items-end justify-content-between mb-2">
              <div>
                <p class="section-title">í’ˆëª© ë‚´ì—­</p>
                <p class="section-sub mb-0">í’ˆëª… ì…ë ¥ ì‹œ ìˆ˜ëŸ‰Ã—ë‹¨ê°€ ë˜ëŠ” ê¸ˆì•¡ ì§ì ‘ì…ë ¥ ì¤‘ í•˜ë‚˜ëŠ” í•„ìš”í•©ë‹ˆë‹¤.</p>
              </div>
              <div class="d-flex align-items-center gap-2 no-print">
                <button type="button" class="btn btn-sm btn-outline-primary" @click="addRow()">í–‰ ì¶”ê°€</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" @click="fillSample()">ìƒ˜í”Œ</button>
              </div>
            </div>
            <hr class="my-2" />

            <div class="table-responsive">
              <table class="table table-sm table-excel align-middle mb-2">
                <thead>
                  <tr>
                    <th style="width: 90px;">ì¼ì</th>
                    <th>í’ˆëª…</th>
                    <th style="width: 110px;">ê·œê²©</th>
                    <th style="width: 85px;">ìˆ˜ëŸ‰</th>
                    <th style="width: 110px;">ë‹¨ê°€</th>
                    <th style="width: 130px;">ê¸ˆì•¡(ì…ë ¥)</th>
                    <th style="width: 120px;">ê³µê¸‰ê°€ì•¡</th>
                    <th style="width: 110px;">ë¶€ê°€ì„¸</th>
                    <th style="width: 120px;">í•©ê³„</th>
                    <th class="no-print" style="width: 60px;">ì‚­ì œ</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(row, idx) in items" :key="row.id">
                    <tr>
                      <td>
                        <label class="sr-only" :for="`item_date_${row.id}`">í’ˆëª© ì¼ì</label>
                        <input class="form-control form-control-sm" type="date" :id="`item_date_${row.id}`" x-model="row.date" @change="calculate()" :aria-label="`í’ˆëª© ${idx+1} ì¼ì`">
                      </td>
                      <td>
                        <label class="sr-only" :for="`item_name_${row.id}`">í’ˆëª…</label>
                        <input class="form-control form-control-sm" type="text" :id="`item_name_${row.id}`" x-model.trim="row.name" @input="calculate()" :aria-label="`í’ˆëª© ${idx+1} í’ˆëª…`" placeholder="ì˜ˆ: ì»¨ì„¤íŒ… ìš©ì—­">
                      </td>
                      <td>
                        <label class="sr-only" :for="`item_spec_${row.id}`">ê·œê²©</label>
                        <input class="form-control form-control-sm" type="text" :id="`item_spec_${row.id}`" x-model.trim="row.spec" @input="calculate()" :aria-label="`í’ˆëª© ${idx+1} ê·œê²©`" placeholder="ì˜ˆ: 1ì‹">
                      </td>
                      <td>
                        <label class="sr-only" :for="`item_qty_${row.id}`">ìˆ˜ëŸ‰</label>
                        <input class="form-control form-control-sm num" inputmode="decimal" :id="`item_qty_${row.id}`" x-model="row.qty" @input="onNumberInput(row,'qty',$event); calculate()" :aria-label="`í’ˆëª© ${idx+1} ìˆ˜ëŸ‰`" placeholder="0">
                      </td>
                      <td>
                        <label class="sr-only" :for="`item_unit_${row.id}`">ë‹¨ê°€</label>
                        <input class="form-control form-control-sm num" inputmode="decimal" :id="`item_unit_${row.id}`" x-model="row.unitPrice" @input="onNumberInput(row,'unitPrice',$event); calculate()" :aria-label="`í’ˆëª© ${idx+1} ë‹¨ê°€`" placeholder="0">
                      </td>
                      <td>
                        <label class="sr-only" :for="`item_input_${row.id}`">ê¸ˆì•¡(ì§ì ‘ì…ë ¥)</label>
                        <input class="form-control form-control-sm num" inputmode="numeric" :id="`item_input_${row.id}`" x-model="row.amountInput" @input="onNumberInput(row,'amountInput',$event); calculate()" :aria-label="`í’ˆëª© ${idx+1} ê¸ˆì•¡ ì§ì ‘ì…ë ¥`" placeholder="(ì„ íƒ)">
                        <div class="help-text">ìˆ˜ëŸ‰Ã—ë‹¨ê°€ê°€ ìˆìœ¼ë©´ ìš°ì„ </div>
                      </td>
                      <td class="num">
                        <span x-text="formatNumberSafe(row.supplyAmount)"></span>
                      </td>
                      <td class="num">
                        <span x-text="formatNumberSafe(row.vatAmount)"></span>
                      </td>
                      <td class="num">
                        <span x-text="formatNumberSafe(row.totalAmount)"></span>
                      </td>
                      <td class="no-print text-center">
                        <button type="button" class="btn btn-sm btn-outline-danger" @click="removeRow(idx)" aria-label="í–‰ ì‚­ì œ">ì‚­ì œ</button>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <div class="row g-2">
              <div class="col-12 col-md-4">
                <div class="p-2 rounded border">
                  <div class="text-secondary">ê³µê¸‰ê°€ì•¡ í•©ê³„</div>
                  <div class="h5 mb-0 num" x-text="formatCurrencySafe(totals.subtotal_supply_amount)"></div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="p-2 rounded border">
                  <div class="text-secondary">ë¶€ê°€ì„¸ í•©ê³„</div>
                  <div class="h5 mb-0 num" x-text="formatCurrencySafe(totals.subtotal_vat_amount)"></div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="p-2 rounded border">
                  <div class="text-secondary">í•©ê³„ê¸ˆì•¡</div>
                  <div class="h5 mb-0 num" x-text="formatCurrencySafe(totals.grand_total)"></div>
                </div>
              </div>
            </div>

            <div class="mt-2">
              <div class="text-secondary">ê¸ˆì•¡(í•œê¸€í‘œê¸°)</div>
              <div class="fw-semibold" x-text="totals.amount_in_korean"></div>
            </div>

          </section>

          <!-- Section 3: Payment/Notes -->
          <section>
            <div class="d-flex align-items-end justify-content-between mb-2">
              <div>
                <p class="section-title">ê²°ì œ/ë¹„ê³  ë° ì¶œë ¥</p>
                <p class="section-sub mb-0">ê²°ì œì •ë³´ì™€ í•˜ë‹¨ ë¹„ê³ ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</p>
              </div>
              <div class="help-text no-print">ì…€ ë§¤í•‘(ê°€ì •): Sheet1!B36, H36, N36, V36, B38</div>
            </div>
            <hr class="my-2" />

            <div class="row g-2">
              <div class="col-12 col-md-4">
                <label class="form-label" for="payment_method">ê²°ì œìˆ˜ë‹¨</label>
                <select class="form-select" id="payment_method" x-model="footer.payment_method" @change="calculate()">
                  <option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option>
                  <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                  <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                  <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="bank_name">ì€í–‰</label>
                <input class="form-control" type="text" id="bank_name" x-model.trim="footer.bank_name" @input="calculate()" placeholder="ì˜ˆ: êµ­ë¯¼ì€í–‰">
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="account_no">ê³„ì¢Œë²ˆí˜¸</label>
                <input class="form-control" type="text" id="account_no" x-model.trim="footer.account_no" @input="calculate()" placeholder="ì˜ˆ: 000-00-000000">
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="account_holder">ì˜ˆê¸ˆì£¼</label>
                <input class="form-control" type="text" id="account_holder" x-model.trim="footer.account_holder" @input="calculate()" placeholder="ì˜ˆ: í™ê¸¸ë™">
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="notes_footer">ë¹„ê³ (í•˜ë‹¨)</label>
                <input class="form-control" type="text" id="notes_footer" x-model.trim="footer.notes" @input="calculate()" placeholder="ì˜ˆ: ì…ê¸ˆê¸°í•œ, ë‹´ë‹¹ì ë“±">
              </div>
            </div>
          </section>

        </form>

        <div class="mt-3 no-print text-secondary small">
          <div class="fw-semibold">êµ¬í˜„ ì°¸ê³ </div>
          <ul class="mb-0">
            <li>ë³¸ ì•±ì€ â€˜í‘œì¤€ ê±°ë˜ëª…ì„¸í‘œâ€™ êµ¬ì„±ìœ¼ë¡œ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. ì‹¤ì œ ì—‘ì…€ í…œí”Œë¦¿ì˜ ë¼ë²¨/ì¢Œí‘œ í™•ì¸ í›„ ì…€ ë§¤í•‘ì„ í™•ì •í•˜ì„¸ìš”.</li>
            <li>ë¶€ê°€ì„¸ í¬í•¨(ì—­ì‚°) ëª¨ë“œì—ì„œëŠ” ê° í–‰ì˜ â€˜ê¸ˆì•¡(ì…ë ¥)â€™ì„ <span class="fw-semibold">ë¶€ê°€ì„¸ í¬í•¨ê¸ˆì•¡</span>ìœ¼ë¡œ ê°„ì£¼í•´ ê³µê¸‰ê°€ì•¡/ë¶€ê°€ì„¸ë¥¼ ì—­ì‚°í•©ë‹ˆë‹¤.</li>
          </ul>
        </div>

      </div>

      <!-- Right: Print Preview -->
      <div class="col-12 col-lg-5">
        <div class="card-like p-3">
          <div class="d-flex align-items-end justify-content-between mb-2">
            <div>
              <p class="section-title">ì¶œë ¥ ë¯¸ë¦¬ë³´ê¸°</p>
              <p class="section-sub mb-0">ì¸ì‡„ ì‹œ ì•„ë˜ ì˜ì—­ì´ A4ë¡œ ì¶œë ¥ë©ë‹ˆë‹¤.</p>
            </div>
            <div class="no-print">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="compactSwitch" x-model="ui.compactPreview">
                <label class="form-check-label" for="compactSwitch">ë¯¸ë¦¬ë³´ê¸° ì¶•ì†Œ</label>
              </div>
            </div>
          </div>

          <div id="printArea" :style="ui.compactPreview ? 'transform: scale(.86); transform-origin: top left; width: 116%;' : ''">
            <div class="print-sheet">
              <div class="print-title">ê±° ë˜ ëª… ì„¸ í‘œ</div>

              <div class="print-meta">
                <div>ì‘ì„±ì¼ì: <span x-text="formatDateKorean(header.issue_date)"></span></div>
                <div>ë¬¸ì„œë²ˆí˜¸: <span x-text="header.document_no || '-'" style="font-family: var(--mono);"></span></div>
              </div>

              <table class="print-grid" aria-label="ê³µê¸‰ì/ê³µê¸‰ë°›ëŠ”ì ì •ë³´">
                <tr>
                  <td class="print-label">ê³µê¸‰ì ìƒí˜¸</td>
                  <td class="print-value"><span x-text="supplier.company || ''"></span></td>
                  <td class="print-label">ê³µê¸‰ë°›ëŠ”ì ìƒí˜¸</td>
                  <td class="print-value"><span x-text="buyer.company || ''"></span></td>
                </tr>
                <tr>
                  <td class="print-label">ëŒ€í‘œì</td>
                  <td class="print-value"><span x-text="supplier.ceo || ''"></span></td>
                  <td class="print-label">ëŒ€í‘œì</td>
                  <td class="print-value"><span x-text="buyer.ceo || ''"></span></td>
                </tr>
                <tr>
                  <td class="print-label">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</td>
                  <td class="print-value"><span x-text="supplier.businessNo || ''"></span></td>
                  <td class="print-label">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</td>
                  <td class="print-value"><span x-text="buyer.businessNo || ''"></span></td>
                </tr>
                <tr>
                  <td class="print-label">ì£¼ì†Œ</td>
                  <td class="print-value"><span x-text="supplier.address || ''"></span></td>
                  <td class="print-label">ì£¼ì†Œ</td>
                  <td class="print-value"><span x-text="buyer.address || ''"></span></td>
                </tr>
                <tr>
                  <td class="print-label">ì „í™”</td>
                  <td class="print-value"><span x-text="supplier.tel || ''"></span></td>
                  <td class="print-label">ì „í™”</td>
                  <td class="print-value"><span x-text="buyer.tel || ''"></span></td>
                </tr>
                <tr>
                  <td class="print-label">ë¶€ê°€ì„¸</td>
                  <td class="print-value"><span x-text="taxModeLabel(taxMode)"></span></td>
                  <td class="print-label">ë¹„ê³ (ìƒë‹¨)</td>
                  <td class="print-value"><span x-text="header.notes || ''"></span></td>
                </tr>
              </table>

              <table class="print-grid print-items mt-2" aria-label="í’ˆëª© ë‚´ì—­">
                <thead>
                  <tr>
                    <th style="width: 15%;">ì¼ì</th>
                    <th>í’ˆëª…</th>
                    <th style="width: 14%;">ê·œê²©</th>
                    <th style="width: 9%;">ìˆ˜ëŸ‰</th>
                    <th style="width: 14%;">ë‹¨ê°€</th>
                    <th style="width: 16%;">ê³µê¸‰ê°€ì•¡</th>
                    <th style="width: 12%;">ë¶€ê°€ì„¸</th>
                    <th style="width: 16%;">í•©ê³„</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(row, idx) in printableItems" :key="row.id">
                    <tr>
                      <td><span x-text="formatDateShort(row.date)"></span></td>
                      <td class="name"><span x-text="row.name"></span></td>
                      <td><span x-text="row.spec"></span></td>
                      <td class="num"><span x-text="formatNumberSafe(row.qty)"></span></td>
                      <td class="num"><span x-text="formatNumberSafe(row.unitPrice)"></span></td>
                      <td class="num"><span x-text="formatNumberSafe(row.supplyAmount)"></span></td>
                      <td class="num"><span x-text="formatNumberSafe(row.vatAmount)"></span></td>
                      <td class="num"><span x-text="formatNumberSafe(row.totalAmount)"></span></td>
                    </tr>
                  </template>
                </tbody>
              </table>

              <table class="print-totals" aria-label="í•©ê³„">
                <tr>
                  <td style="width: 20%;" class="print-label">ê³µê¸‰ê°€ì•¡ í•©ê³„</td>
                  <td class="num" style="width: 30%;"><span x-text="formatNumberSafe(totals.subtotal_supply_amount)"></span></td>
                  <td style="width: 20%;" class="print-label">ë¶€ê°€ì„¸ í•©ê³„</td>
                  <td class="num" style="width: 30%;"><span x-text="formatNumberSafe(totals.subtotal_vat_amount)"></span></td>
                </tr>
                <tr>
                  <td class="print-label">í•©ê³„ê¸ˆì•¡</td>
                  <td class="num"><span x-text="formatNumberSafe(totals.grand_total)"></span></td>
                  <td class="print-label">ê¸ˆì•¡(í•œê¸€)</td>
                  <td><span x-text="totals.amount_in_korean"></span></td>
                </tr>
              </table>

              <div class="print-footer">
                <table class="print-grid" aria-label="ê²°ì œ ì •ë³´">
                  <tr>
                    <td class="print-label">ê²°ì œìˆ˜ë‹¨</td>
                    <td class="print-value"><span x-text="footer.payment_method || ''"></span></td>
                    <td class="print-label">ì€í–‰</td>
                    <td class="print-value"><span x-text="footer.bank_name || ''"></span></td>
                  </tr>
                  <tr>
                    <td class="print-label">ê³„ì¢Œë²ˆí˜¸</td>
                    <td class="print-value"><span x-text="footer.account_no || ''"></span></td>
                    <td class="print-label">ì˜ˆê¸ˆì£¼</td>
                    <td class="print-value"><span x-text="footer.account_holder || ''"></span></td>
                  </tr>
                  <tr>
                    <td class="print-label">ë¹„ê³ (í•˜ë‹¨)</td>
                    <td colspan="3"><span x-text="footer.notes || ''"></span></td>
                  </tr>
                </table>
              </div>

            </div>
          </div>

          <div class="mt-2 no-print text-secondary small">
            ì¸ì‡„ëŠ” ë¸Œë¼ìš°ì €ì˜ â€œëŒ€ìƒ: PDFë¡œ ì €ì¥â€ì„ ì„ íƒí•˜ë©´ PDF ìƒì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    /* ===== Excel formula helper functions (provided) ===== */
    function _sum(...args) {
        return args.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
    }

    function _sumRange(rangeData) {
        if (Array.isArray(rangeData)) {
            return rangeData.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
        }
        return parseFloat(rangeData) || 0;
    }

    function _average(...args) {
        const flat = args.flat().filter(x => x !== null && x !== '' && !isNaN(x));
        return flat.length ? _sum(...flat) / flat.length : 0;
    }

    function _averageRange(rangeData) {
        if (Array.isArray(rangeData)) {
            const flat = rangeData.flat().filter(x => x !== null && x !== '' && !isNaN(x));
            return flat.length ? _sumRange(flat) / flat.length : 0;
        }
        return parseFloat(rangeData) || 0;
    }

    function _count(...args) {
        return args.flat().filter(x => typeof x === 'number' && !isNaN(x)).length;
    }

    function _counta(...args) {
        return args.flat().filter(x => x !== null && x !== '' && x !== undefined).length;
    }

    function _and(...args) {
        return args.every(x => Boolean(x));
    }

    function _or(...args) {
        return args.some(x => Boolean(x));
    }

    function _round(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.round(num * factor) / factor;
    }

    function _roundUp(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.ceil(num * factor) / factor;
    }

    function _roundDown(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.floor(num * factor) / factor;
    }

    function _len(text) {
        return String(text).length;
    }

    function _left(text, numChars = 1) {
        return String(text).substring(0, numChars);
    }

    function _right(text, numChars = 1) {
        const str = String(text);
        return str.substring(str.length - numChars);
    }

    function _mid(text, startNum, numChars) {
        return String(text).substring(startNum - 1, startNum - 1 + numChars);
    }

    function _trim(text) {
        return String(text).trim();
    }

    function _upper(text) {
        return String(text).toUpperCase();
    }

    function _lower(text) {
        return String(text).toLowerCase();
    }

    function _concat(...args) {
        return args.join('');
    }

    // Number formatting
    function formatNumber(num, decimals = 0) {
        return new Intl.NumberFormat('ko-KR', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(num);
    }

    function formatCurrency(num) {
        return new Intl.NumberFormat('ko-KR', {
            style: 'currency',
            currency: 'KRW',
            maximumFractionDigits: 0
        }).format(num);
    }

    function formatPercent(num, decimals = 1) {
        return new Intl.NumberFormat('ko-KR', {
            style: 'percent',
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(num / 100);
    }

    /* ===== App logic ===== */
    function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

    function coerceNumber(v){
      if (v === null || v === undefined) return 0;
      if (typeof v === 'number') return isFinite(v) ? v : 0;
      const s = String(v).replace(/[^0-9.-]/g,'');
      const n = parseFloat(s);
      return isFinite(n) ? n : 0;
    }

    // ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ ê²€ì¦ (í˜•ì‹ + ì²´í¬ì„¬)
    function validateBusinessNo(businessNo){
      if (!businessNo) return { ok: true, message: '' }; // optional
      const v = String(businessNo).trim();
      if (!/^\d{3}-\d{2}-\d{5}$/.test(v)){
        return { ok:false, message:'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ í˜•ì‹ì€ 123-45-67890 ì…ë‹ˆë‹¤.' };
      }
      const digits = v.replace(/-/g,'').split('').map(Number);
      const key = [1,3,7,1,3,7,1,3,5];
      let sum = 0;
      for (let i=0;i<9;i++) sum += digits[i]*key[i];
      sum += Math.floor((digits[8]*5)/10);
      const check = (10 - (sum % 10)) % 10;
      const ok = check === digits[9];
      return ok ? { ok:true, message:'' } : { ok:false, message:'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ ì²´í¬ì„¬ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' };
    }

    // í•œê¸€ ê¸ˆì•¡ ë³€í™˜
    function amountToKorean(amount){
      const n = Math.floor(coerceNumber(amount));
      if (!n) return 'ì˜ì›';

      const numKor = ['', 'ì¼', 'ì´', 'ì‚¼', 'ì‚¬', 'ì˜¤', 'ìœ¡', 'ì¹ ', 'íŒ”', 'êµ¬'];
      const unitSmall = ['', 'ì‹­', 'ë°±', 'ì²œ'];
      const unitBig = ['', 'ë§Œ', 'ì–µ', 'ì¡°', 'ê²½'];

      function chunkToKor(chunk){ // 0..9999
        let out = '';
        const s = chunk.toString().padStart(4,'0').split('').map(Number);
        for (let i=0;i<4;i++){
          const d = s[i];
          const pos = 3 - i;
          if (d === 0) continue;
          // "ì¼ì‹­" ê´€ìš© ì²˜ë¦¬: ì¼ì€ ìƒëµ ê°€ëŠ¥í•˜ì§€ë§Œ, ë¬¸ì„œ ê¸ˆì•¡ì€ ë³´í†µ ìƒëµ
          const digitKor = (d === 1 && pos > 0) ? '' : numKor[d];
          out += digitKor + unitSmall[pos];
        }
        return out;
      }

      let rest = n;
      let bigIdx = 0;
      let result = '';
      while (rest > 0){
        const chunk = rest % 10000;
        if (chunk !== 0){
          const part = chunkToKor(chunk) + unitBig[bigIdx];
          result = part + result;
        }
        rest = Math.floor(rest / 10000);
        bigIdx++;
      }
      return result + 'ì›';
    }

    // í’ˆëª© 1í–‰ ê³„ì‚°
    function calculateLineAmounts(qty, unitPrice, supplyAmountInput, taxMode){
      const q = coerceNumber(qty);
      const u = coerceNumber(unitPrice);
      const input = coerceNumber(supplyAmountInput);

      // ìš°ì„ ìˆœìœ„: ìˆ˜ëŸ‰Ã—ë‹¨ê°€ê°€ ìœ íš¨(ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ 0ì´ë©´ ê³„ì‚°ì€ ë˜ì§€ë§Œ, ì…ë ¥ ì˜ë„ ê³ ë ¤)
      let base;
      const hasQtyUnit = (q !== 0 && u !== 0);
      if (hasQtyUnit){
        base = q * u;
      } else {
        base = input;
      }

      base = Math.max(0, base);

      let supply = base;
      let vat = 0;
      let total = 0;

      if (taxMode === 'TAX_10'){
        vat = Math.round(supply * 0.1);
        total = supply + vat;
      } else if (taxMode === 'INCLUSIVE'){
        // baseë¥¼ 'ë¶€ê°€ì„¸ í¬í•¨ê¸ˆì•¡'ìœ¼ë¡œ ë³´ê³  ì—­ì‚°
        total = supply;
        supply = Math.round(total / 1.1);
        vat = total - supply;
      } else {
        // ZERO, EXEMPT
        vat = 0;
        total = supply;
      }

      return {
        supplyAmount: Math.round(supply),
        vatAmount: Math.round(vat),
        totalAmount: Math.round(total)
      };
    }

    // í•©ê³„ ê³„ì‚°
    function calculateTotals(items, taxMode){
      let supplySum = 0;
      let vatSum = 0;
      let totalSum = 0;

      for (const it of items){
        supplySum += coerceNumber(it.supplyAmount);
        vatSum += coerceNumber(it.vatAmount);
        totalSum += coerceNumber(it.totalAmount);
      }

      // taxModeê°€ ZERO/EXEMPTì¸ ê²½ìš° vatSumì€ 0ì´ì–´ì•¼ í•¨ (ì•ˆì „)
      if (taxMode === 'ZERO' || taxMode === 'EXEMPT') vatSum = 0;

      return {
        subtotal_supply_amount: Math.round(supplySum),
        subtotal_vat_amount: Math.round(vatSum),
        grand_total: Math.round(totalSum)
      };
    }

    function appData(){
      return {
        ui: {
          compactPreview: false,
        },
        header: {
          issue_date: '',
          document_no: '',
          notes: ''
        },
        supplier: {
          company: '',
          ceo: '',
          businessNo: '',
          address: '',
          tel: ''
        },
        buyer: {
          company: '',
          ceo: '',
          businessNo: '',
          address: '',
          tel: ''
        },
        taxMode: 'TAX_10',
        items: [],
        footer: {
          payment_method: 'ê³„ì¢Œì´ì²´',
          bank_name: '',
          account_no: '',
          account_holder: '',
          notes: ''
        },
        totals: {
          subtotal_supply_amount: 0,
          subtotal_vat_amount: 0,
          grand_total: 0,
          amount_in_korean: 'ì˜ì›'
        },
        errors: {
          fields: {},
          summary: []
        },

        get printableItems(){
          // ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸°ëŠ” 10ì¤„ ì •ë„ë¥¼ í‘œì¤€ìœ¼ë¡œ, ë¹„ì–´ìˆëŠ” í–‰ë„ ë³´ì—¬ì£¼ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ë¥¼ ìˆ˜ì •
          const filled = this.items.filter(r => (r.name && r.name.trim().length) || coerceNumber(r.totalAmount) > 0);
          const maxRows = 10;
          const rows = filled.slice(0, maxRows);
          while (rows.length < maxRows){
            rows.push({ id: 'blank_' + rows.length, date:'', name:'', spec:'', qty:'', unitPrice:'', supplyAmount:'', vatAmount:'', totalAmount:'' });
          }
          return rows;
        },

        init(){
          this.load();
          if (!this.items.length) {
            for (let i=0;i<5;i++) this.addRow();
          }
          // default issue date: today
          if (!this.header.issue_date){
            const d = new Date();
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth()+1).padStart(2,'0');
            const dd = String(d.getDate()).padStart(2,'0');
            this.header.issue_date = `${yyyy}-${mm}-${dd}`;
          }
          this.calculate();
        },

        taxModeLabel(v){
          return ({
            TAX_10: 'ê³¼ì„¸(10%)',
            ZERO: 'ì˜ì„¸(0%)',
            EXEMPT: 'ë©´ì„¸',
            INCLUSIVE: 'ë¶€ê°€ì„¸ í¬í•¨(ì—­ì‚°)'
          })[v] || v;
        },

        formatNumberSafe(v){
          const n = coerceNumber(v);
          if (!n) return (String(v).trim() === '' ? '' : '0');
          return formatNumber(n, 0);
        },
        formatCurrencySafe(v){
          const n = coerceNumber(v);
          return formatCurrency(n);
        },
        formatDateKorean(iso){
          if (!iso) return '';
          const d = new Date(iso);
          if (isNaN(d.getTime())) return '';
          return `${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼`;
        },
        formatDateShort(iso){
          if (!iso) return '';
          const d = new Date(iso);
          if (isNaN(d.getTime())) return '';
          return `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        },

        onNumberInput(row, key, evt){
          // allow typing commas; store raw string in model for UX
          row[key] = evt.target.value;
        },

        onBusinessNoInput(who){
          // auto-format while typing (simple)
          const target = who === 'supplier' ? this.supplier : this.buyer;
          let v = (target.businessNo || '').replace(/[^0-9]/g,'').slice(0,10);
          if (v.length >= 4) v = v.slice(0,3) + '-' + v.slice(3);
          if (v.length >= 7) v = v.slice(0,6) + '-' + v.slice(6);
          target.businessNo = v;
          this.calculate();
        },

        addRow(){
          this.items.push({
            id: uid(),
            date: this.header.issue_date || '',
            name: '',
            spec: '',
            qty: '',
            unitPrice: '',
            amountInput: '',
            supplyAmount: 0,
            vatAmount: 0,
            totalAmount: 0,
            remark: ''
          });
          this.calculate();
        },

        removeRow(idx){
          this.items.splice(idx, 1);
          if (!this.items.length) this.addRow();
          this.calculate();
        },

        fillSample(){
          this.supplier.company = 'ê³µê¸‰ì(ì£¼)';
          this.supplier.ceo = 'í™ê¸¸ë™';
          this.supplier.businessNo = '123-45-67890';
          this.supplier.address = 'ì„œìš¸íŠ¹ë³„ì‹œ ...';
          this.supplier.tel = '02-1234-5678';

          this.buyer.company = 'ê³µê¸‰ë°›ëŠ”ì(ì£¼)';
          this.buyer.ceo = 'ê¹€ì² ìˆ˜';
          this.buyer.businessNo = '220-81-62517';
          this.buyer.address = 'ë¶€ì‚°ê´‘ì—­ì‹œ ...';
          this.buyer.tel = '051-000-0000';

          this.header.document_no = '2025-0001';
          this.header.notes = 'í”„ë¡œì íŠ¸: ì›¹ ì „í™˜';
          this.footer.payment_method = 'ê³„ì¢Œì´ì²´';
          this.footer.bank_name = 'êµ­ë¯¼ì€í–‰';
          this.footer.account_no = '123-45-67890';
          this.footer.account_holder = 'ê³µê¸‰ì(ì£¼)';
          this.footer.notes = 'ì…ê¸ˆê¸°í•œ: 7ì¼ ì´ë‚´';

          if (this.items.length < 3) while(this.items.length < 3) this.addRow();
          this.items[0].name = 'ì»¨ì„¤íŒ… ìš©ì—­';
          this.items[0].spec = '1ì‹';
          this.items[0].qty = '1';
          this.items[0].unitPrice = '1000000';
          this.items[1].name = 'ê°œë°œë¹„';
          this.items[1].spec = '1ì‹';
          this.items[1].amountInput = '500000';
          this.items[2].name = 'ìœ ì§€ë³´ìˆ˜';
          this.items[2].qty = '2';
          this.items[2].unitPrice = '150000';

          this.calculate();
        },

        resetAll(){
          if (!confirm('ëª¨ë“  ì…ë ¥ì„ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
          localStorage.removeItem('invoice_spec_v1');
          this.header = { issue_date: '', document_no: '', notes: '' };
          this.supplier = { company:'', ceo:'', businessNo:'', address:'', tel:'' };
          this.buyer = { company:'', ceo:'', businessNo:'', address:'', tel:'' };
          this.taxMode = 'TAX_10';
          this.items = [];
          this.footer = { payment_method:'ê³„ì¢Œì´ì²´', bank_name:'', account_no:'', account_holder:'', notes:'' };
          this.totals = { subtotal_supply_amount:0, subtotal_vat_amount:0, grand_total:0, amount_in_korean:'ì˜ì›' };
          this.errors = { fields:{}, summary:[] };
          this.init();
        },

        save(){
          const payload = {
            header: this.header,
            supplier: this.supplier,
            buyer: this.buyer,
            taxMode: this.taxMode,
            items: this.items,
            footer: this.footer
          };
          localStorage.setItem('invoice_spec_v1', JSON.stringify(payload));
          alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤(ë¸Œë¼ìš°ì € ë¡œì»¬ ì €ì¥).');
        },

        load(){
          try {
            const raw = localStorage.getItem('invoice_spec_v1');
            if (!raw) return;
            const payload = JSON.parse(raw);
            if (payload.header) this.header = payload.header;
            if (payload.supplier) this.supplier = payload.supplier;
            if (payload.buyer) this.buyer = payload.buyer;
            if (payload.taxMode) this.taxMode = payload.taxMode;
            if (Array.isArray(payload.items)) this.items = payload.items;
            if (payload.footer) this.footer = payload.footer;
          } catch(e){
            console.warn('load failed', e);
          }
        },

        validate(){
          const fields = {};
          const summary = [];

          // required basics
          if (!this.header.issue_date) {
            fields.issue_date = 'ì‘ì„±ì¼ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
            summary.push('ì‘ì„±ì¼ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
          }
          if (!this.supplier.company){
            fields.supplier_company = 'ê³µê¸‰ì ìƒí˜¸(ë²•ì¸ëª…)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
            summary.push('ê³µê¸‰ì ìƒí˜¸(ë²•ì¸ëª…)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
          }
          if (!this.buyer.company){
            fields.buyer_company = 'ê³µê¸‰ë°›ëŠ”ì ìƒí˜¸(ë²•ì¸ëª…)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
            summary.push('ê³µê¸‰ë°›ëŠ”ì ìƒí˜¸(ë²•ì¸ëª…)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
          }

          // business no
          const sv = validateBusinessNo(this.supplier.businessNo);
          if (!sv.ok){
            fields.supplier_business_no = sv.message;
            summary.push('ê³µê¸‰ì ' + sv.message);
          }
          const bv = validateBusinessNo(this.buyer.businessNo);
          if (!bv.ok){
            fields.buyer_business_no = bv.message;
            summary.push('ê³µê¸‰ë°›ëŠ”ì ' + bv.message);
          }

          // item row validation (soft)
          const rowErrors = [];
          this.items.forEach((r, idx) => {
            if (r.name && r.name.trim()){
              const q = coerceNumber(r.qty);
              const u = coerceNumber(r.unitPrice);
              const ai = coerceNumber(r.amountInput);
              const ok = ((q !== 0 && u !== 0) || ai !== 0);
              if (!ok) rowErrors.push(`${idx+1}í–‰: í’ˆëª… ì…ë ¥ ì‹œ ìˆ˜ëŸ‰Ã—ë‹¨ê°€ ë˜ëŠ” ê¸ˆì•¡(ì§ì ‘ì…ë ¥)ì´ í•„ìš”í•©ë‹ˆë‹¤.`);
            }
          });
          summary.push(...rowErrors);

          this.errors = { fields, summary };
          return summary.length === 0;
        },

        // ë©”ì¸ ê³„ì‚° ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜
        calculate(){
          // 1) per line
          for (const r of this.items){
            const out = calculateLineAmounts(r.qty, r.unitPrice, r.amountInput, this.taxMode);
            r.supplyAmount = out.supplyAmount;
            r.vatAmount = out.vatAmount;
            r.totalAmount = out.totalAmount;
          }

          // 2) totals
          const t = calculateTotals(this.items, this.taxMode);
          this.totals.subtotal_supply_amount = t.subtotal_supply_amount;
          this.totals.subtotal_vat_amount = t.subtotal_vat_amount;
          this.totals.grand_total = t.grand_total;

          // 3) korean amount
          this.totals.amount_in_korean = amountToKorean(this.totals.grand_total);

          // 4) validate (non-blocking; still show errors)
          this.validate();
        },

        print(){
          // Recalculate right before printing
          this.calculate();
          window.print();
        }
      }
    }
  </script>

<!-- í•´ì»¤í†¤ ì„ ì • ì •ë³´ -->
<div id="selection-banner" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 14px;
    z-index: 10000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
">
    <div>
        <strong>ğŸ“Š ê±°ë˜ëª…ì„¸í‘œ</strong>
        <span style="margin-left: 10px; opacity: 0.9;">| ê±°ë˜/B2B</span>
    </div>
    <div style="display: flex; align-items: center; gap: 15px;">
        <span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 12px;">
            0ê°œ ìˆ˜ì‹
        </span>
        <button onclick="document.getElementById('selection-info').style.display='block'"
                style="background: white; color: #667eea; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 500;">
            ì„ ì • ì´ìœ  ë³´ê¸°
        </button>
    </div>
</div>

<div id="selection-info" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 10001;
    display: none;
    justify-content: center;
    align-items: center;
" onclick="this.style.display='none'">
    <div style="
        background: white;
        padding: 30px;
        border-radius: 16px;
        max-width: 500px;
        margin: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    " onclick="event.stopPropagation()">
        <h2 style="margin: 0 0 15px; color: #333;">ğŸ† í•´ì»¤í†¤ ì„ ì • ì´ìœ </h2>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <strong style="color: #667eea;">ê±°ë˜/B2B</strong>
            <p style="margin: 10px 0 0; color: #555; line-height: 1.6;">B2B ê±°ë˜ ì–‘ì‹ - ì¼ë°˜ ë¹„ì¦ˆë‹ˆìŠ¤ í™œìš©</p>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            
        </div>
        <button onclick="document.getElementById('selection-info').style.display='none'"
                style="margin-top: 20px; width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
            ë‹«ê¸°
        </button>
    </div>
</div>

<style>
body { padding-top: 56px !important; }
</style>
</body>
</html>
