<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í•­ëª©ë³„ ê¸ˆì•¡/ë¶€ê°€ì„¸ ê³„ì‚°ê¸°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    :root{
      --app-max-width: 1100px;
      --grid-gap: 12px;
      --border-color: #d9d9d9;
      --header-bg: #f3f4f6;
      --result-bg: #f7f7f7;
      --danger: #dc3545;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    body{
      font-family: "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      color: #111;
      background: #fff;
    }

    .app-wrap{ max-width: var(--app-max-width); margin: 0 auto; }

    .excel-like{
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
    }

    .excel-like .card-header{
      background: var(--header-bg);
      border-bottom: 1px solid var(--border-color);
    }

    table.table{
      margin-bottom: 0;
    }

    .table thead th{
      background: var(--header-bg);
      border-bottom: 1px solid var(--border-color) !important;
      font-weight: 700;
      vertical-align: middle;
      white-space: nowrap;
    }

    .table td, .table th{
      border-color: var(--border-color) !important;
      vertical-align: middle;
    }

    .num, .num input{
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-family: var(--mono);
    }

    .input-num{
      width: 140px;
      min-width: 120px;
    }

    .result-cell{
      background: var(--result-bg);
      font-weight: 700;
    }

    .hint{
      font-size: 0.875rem;
      color: #6c757d;
    }

    .error-text{
      color: var(--danger);
      font-size: 0.875rem;
    }

    .invalid input{
      border-color: var(--danger) !important;
      box-shadow: 0 0 0 0.2rem rgba(220,53,69,.15);
    }

    .sr-live{
      position: relative;
      min-height: 1.25rem;
    }

    @media print{
      @page{
        size: A4 portrait;
        margin: 25mm 19mm 25mm 19mm;
      }

      body{ background:#fff; }
      .no-print{ display:none !important; }
      .app-wrap{ max-width: none; }

      .excel-like{ border-radius: 0; }

      /* ì…ë ¥ì€ ì¸ì‡„ì‹œ í…Œë‘ë¦¬/ë°°ê²½ ì œê±°í•˜ì—¬ ì—‘ì…€ ëŠë‚Œ ìœ ì§€ */
      input.form-control{
        border: 0 !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        background: transparent !important;
        box-shadow: none !important;
      }

      table{ break-inside: avoid; }
      tr{ break-inside: avoid; }
    }
  </style>
</head>
<body>
  <div class="container py-4" x-data="appData()" x-init="init()">
    <div class="app-wrap">
      <header class="mb-3">
        <h1 class="h4 mb-1">í•­ëª©ë³„ ê¸ˆì•¡/ë¶€ê°€ì„¸ ê³„ì‚°ê¸°</h1>
        <p class="text-muted mb-0">ë‹¨ê°€Ã—ìˆ˜ëŸ‰ìœ¼ë¡œ ê³µê¸‰ê°€ì•¡ì„ ê³„ì‚°í•˜ê³ , ë¶€ê°€ì„¸(10%) ë° í•©ê³„ë¥¼ ì‚°ì¶œí•©ë‹ˆë‹¤.</p>
      </header>

      <main class="d-grid" style="gap: var(--grid-gap);">

        <!-- í•­ëª© ì…ë ¥ í…Œì´ë¸” -->
        <section class="excel-like" aria-labelledby="sec-items">
          <div class="card-header px-3 py-2">
            <h2 id="sec-items" class="h6 mb-0">í•­ëª© ì…ë ¥(ë‹¨ê°€/ìˆ˜ëŸ‰)</h2>
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th scope="col" style="width:90px;">í–‰</th>
                  <th scope="col" class="num">ë‹¨ê°€(M)</th>
                  <th scope="col" class="num">ìˆ˜ëŸ‰(O)</th>
                  <th scope="col" class="num">ê³µê¸‰ê°€ì•¡(T)</th>
                  <th scope="col" class="num">ë¶€ê°€ì„¸(Z, 10%)</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="line in lines" :key="line.row">
                  <tr :class="(line.errors.unitPrice || line.errors.quantity) ? 'invalid' : ''">
                    <th scope="row">#<span x-text="line.row"></span></th>

                    <td class="num">
                      <label class="visually-hidden" :for="'unitPrice-'+line.row">ë‹¨ê°€ (í–‰ <span x-text="line.row"></span>)</label>
                      <input
                        class="form-control form-control-sm input-num num"
                        type="number" inputmode="decimal" step="1" min="0"
                        :id="'unitPrice-'+line.row"
                        :aria-label="'ë‹¨ê°€ (í–‰ '+line.row+')'"
                        x-model="line.unitPrice"
                        @input.debounce.120ms="calculate()"
                      />
                      <div class="error-text" x-show="!!line.errors.unitPrice" x-text="line.errors.unitPrice"></div>
                    </td>

                    <td class="num">
                      <label class="visually-hidden" :for="'quantity-'+line.row">ìˆ˜ëŸ‰ (í–‰ <span x-text="line.row"></span>)</label>
                      <input
                        class="form-control form-control-sm input-num num"
                        type="number" inputmode="decimal" step="1" min="0"
                        :id="'quantity-'+line.row"
                        :aria-label="'ìˆ˜ëŸ‰ (í–‰ '+line.row+')'"
                        x-model="line.quantity"
                        @input.debounce.120ms="calculate()"
                      />
                      <div class="error-text" x-show="!!line.errors.quantity" x-text="line.errors.quantity"></div>
                    </td>

                    <td class="num result-cell">
                      <span x-text="formatNumber(line.supply, { decimals: 0 })"></span>
                    </td>

                    <td class="num result-cell">
                      <span x-text="formatNumber(line.vat, { decimals: 0 })"></span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>

          <div class="px-3 py-2 hint">
            â€» ì…ë ¥ì´ ë¹„ì–´ìˆìœ¼ë©´ 0ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤. ìŒìˆ˜ëŠ” í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          </div>
        </section>

        <!-- í•©ê³„/ìš”ì•½ -->
        <section class="excel-like" aria-labelledby="sec-summary">
          <div class="card-header px-3 py-2 d-flex justify-content-between align-items-center">
            <h2 id="sec-summary" class="h6 mb-0">í•©ê³„/ìš”ì•½ ê²°ê³¼</h2>
            <div class="text-muted small">(ì—‘ì…€ í•˜ë‹¨ ì…€: C30 / J30 / P30)</div>
          </div>

          <div class="p-3">
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <div class="p-3 border rounded-3 h-100" style="background: var(--result-bg);">
                  <div class="text-muted small">í•©ê³„ (C30)</div>
                  <div class="h5 mb-0 num" x-text="formatNumber(totals.C30, { decimals: 0 })"></div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="p-3 border rounded-3 h-100" style="background: var(--result-bg);">
                  <div class="text-muted small">í•©ê³„ (J30)</div>
                  <div class="h5 mb-0 num" x-text="formatNumber(totals.J30, { decimals: 0 })"></div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="p-3 border rounded-3 h-100" style="background: var(--result-bg);">
                  <div class="text-muted small">í•©ê³„ (P30)</div>
                  <div class="h5 mb-0 num" x-text="formatNumber(totals.P30, { decimals: 0 })"></div>
                </div>
              </div>
            </div>

            <div class="sr-live mt-2" aria-live="polite">
              <div class="error-text" x-show="globalError" x-text="globalError"></div>
              <div class="text-warning small" x-show="globalWarning" x-text="globalWarning"></div>
            </div>
          </div>
        </section>

        <!-- ë²„íŠ¼ ì˜ì—­ -->
        <section class="no-print d-flex flex-wrap gap-2">
          <button type="button" class="btn btn-outline-secondary" @click="reset()">ì´ˆê¸°í™”</button>
          <button type="button" class="btn btn-primary" @click="print()">A4 ì¸ì‡„</button>
          <button type="button" class="btn btn-outline-primary" @click="exportCSV()">CSV ë‚´ë³´ë‚´ê¸°</button>
        </section>

      </main>
    </div>
  </div>

  <script>
    // ===== Excel formula helper functions (from get_js_helpers) =====
    function _sum(...args) {
        return args.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
    }

    function _sumRange(rangeData) {
        if (Array.isArray(rangeData)) {
            return rangeData.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
        }
        return parseFloat(rangeData) || 0;
    }

    function _average(...args) {
        const flat = args.flat().filter(x => x !== null && x !== '' && !isNaN(x));
        return flat.length ? _sum(...flat) / flat.length : 0;
    }

    function _averageRange(rangeData) {
        if (Array.isArray(rangeData)) {
            const flat = rangeData.flat().filter(x => x !== null && x !== '' && !isNaN(x));
            return flat.length ? _sumRange(flat) / flat.length : 0;
        }
        return parseFloat(rangeData) || 0;
    }

    function _count(...args) {
        return args.flat().filter(x => typeof x === 'number' && !isNaN(x)).length;
    }

    function _counta(...args) {
        return args.flat().filter(x => x !== null && x !== '' && x !== undefined).length;
    }

    function _and(...args) {
        return args.every(x => Boolean(x));
    }

    function _or(...args) {
        return args.some(x => Boolean(x));
    }

    function _round(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.round(num * factor) / factor;
    }

    function _roundUp(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.ceil(num * factor) / factor;
    }

    function _roundDown(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.floor(num * factor) / factor;
    }

    function _len(text) {
        return String(text).length;
    }

    function _left(text, numChars = 1) {
        return String(text).substring(0, numChars);
    }

    function _right(text, numChars = 1) {
        const str = String(text);
        return str.substring(str.length - numChars);
    }

    function _mid(text, startNum, numChars) {
        return String(text).substring(startNum - 1, startNum - 1 + numChars);
    }

    function _trim(text) {
        return String(text).trim();
    }

    function _upper(text) {
        return String(text).toUpperCase();
    }

    function _lower(text) {
        return String(text).toLowerCase();
    }

    function _concat(...args) {
        return args.join('');
    }

    // Number formatting
    function formatNumber(num, decimals = 0) {
        return new Intl.NumberFormat('ko-KR', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(num);
    }

    function formatCurrency(num) {
        return new Intl.NumberFormat('ko-KR', {
            style: 'currency',
            currency: 'KRW',
            maximumFractionDigits: 0
        }).format(num);
    }

    function formatPercent(num, decimals = 1) {
        return new Intl.NumberFormat('ko-KR', {
            style: 'percent',
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(num / 100);
    }

    // ===== App logic =====
    function appData(){
      return {
        vatRate: 0.1,
        lines: [],
        totals: { C30: 0, J30: 0, P30: 0 },
        globalError: '',
        globalWarning: '',

        init(){
          // rows 12~21
          this.lines = Array.from({length: 10}, (_, i) => {
            const row = 12 + i;
            return {
              row,
              unitPrice: '',
              quantity: '',
              supply: 0,
              vat: 0,
              errors: { unitPrice: '', quantity: '' }
            };
          });
          this.calculate();
        },

        // í™”ë©´/ì¸ì‡„ìš© í¬ë§·(ìš”êµ¬ì‚¬í•­: formatNumber(value, options))
        formatNumber(value, options = {}){
          const decimals = Number.isFinite(options.decimals) ? options.decimals : 0;
          const n = (typeof value === 'number' && Number.isFinite(value)) ? value : 0;
          return formatNumber(n, decimals);
        },

        // ì…ë ¥ê°’ ì •ê·œí™”
        toNumber(v){
          if (v === null || v === undefined || v === '') return 0;
          const n = Number(v);
          return Number.isFinite(n) ? n : 0;
        },

        validateLine(line){
          line.errors.unitPrice = '';
          line.errors.quantity = '';

          const up = this.toNumber(line.unitPrice);
          const qty = this.toNumber(line.quantity);

          if (up < 0) line.errors.unitPrice = 'ë‹¨ê°€ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
          if (qty < 0) line.errors.quantity = 'ìˆ˜ëŸ‰ì€ 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';

          // ë§¤ìš° í° ê°’ ê²½ê³ (ìš”êµ¬ì‚¬í•­)
          const absMax = 1e12;
          if (Math.abs(up) > absMax || Math.abs(qty) > absMax){
            this.globalWarning = 'ì…ë ¥ê°’ì´ ë§¤ìš° í½ë‹ˆë‹¤(1e12 ì´ˆê³¼). ê³„ì‚° ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
          }
        },

        // calculateLine(unitPrice, quantity, vatRate)
        calculateLine(unitPrice, quantity, vatRate){
          // Excel: T(row)=M(row)*O(row), Z(row)=T(row)*0.1
          // convert_formula ê²°ê³¼ë¥¼ ì½”ë“œì— ë°˜ì˜(ì…€ ì°¸ì¡° ëŒ€ì‹  ë§¤ê°œë³€ìˆ˜ ì‚¬ìš©)
          const supply = (unitPrice * quantity); // from =M12*O12
          const vat = (supply * vatRate);        // from =T12*0.1
          return { supply, vat };
        },

        // calculateTotals(lines)
        calculateTotals(lines){
          const sumSupply = lines.reduce((acc, l) => acc + (Number(l.supply) || 0), 0);
          const sumVat = lines.reduce((acc, l) => acc + (Number(l.vat) || 0), 0);
          const sumTotal = sumSupply + sumVat;

          // ì—‘ì…€ì˜ C30/J30/P30 ì •í™•í•œ ë§¤í•‘ì´ ë¯¸í™•ì •ì¸ ìƒíƒœì—ì„œ,
          // ì¼ë°˜ì ì¸ ìš”ì•½(ê³µê¸‰ê°€ì•¡/ë¶€ê°€ì„¸/í•©ê³„)ë¡œ ì œê³µ
          return {
            C30: sumSupply,
            J30: sumVat,
            P30: sumTotal
          };
        },

        // calculate(state): ë©”ì¸ ê³„ì‚° í•¨ìˆ˜
        calculate(){
          this.globalError = '';
          this.globalWarning = '';

          try{
            for (const line of this.lines){
              this.validateLine(line);

              const unitPrice = this.toNumber(line.unitPrice);
              const quantity  = this.toNumber(line.quantity);

              // ê²€ì¦ ì˜¤ë¥˜ê°€ ìˆì–´ë„ ê³„ì‚°ì€ 0 ì´ìƒì¼ ë•Œë§Œ ë°˜ì˜(ìŒìˆ˜ë©´ 0 ì²˜ë¦¬)
              const safeUP = unitPrice < 0 ? 0 : unitPrice;
              const safeQ  = quantity < 0 ? 0 : quantity;

              const r = this.calculateLine(safeUP, safeQ, this.vatRate);

              // VAT ì›ë‹¨ìœ„ ë°˜ì˜¬ë¦¼(ê¸°ë³¸: 0ìë¦¬ ë°˜ì˜¬ë¦¼)
              line.supply = _round(r.supply, 0);
              line.vat = _round(r.vat, 0);
            }

            this.totals = this.calculateTotals(this.lines);
            // í•©ê³„ë„ ì›ë‹¨ìœ„
            this.totals.C30 = _round(this.totals.C30, 0);
            this.totals.J30 = _round(this.totals.J30, 0);
            this.totals.P30 = _round(this.totals.P30, 0);

          }catch(err){
            console.error(err);
            this.globalError = 'ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì…ë ¥ê°’ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.';
          }
        },

        reset(){
          for (const line of this.lines){
            line.unitPrice = '';
            line.quantity = '';
            line.supply = 0;
            line.vat = 0;
            line.errors.unitPrice = '';
            line.errors.quantity = '';
          }
          this.totals = { C30: 0, J30: 0, P30: 0 };
          this.globalError = '';
          this.globalWarning = '';
        },

        print(){
          window.print();
        },

        exportCSV(){
          // í˜„ì¬ í…Œì´ë¸” linesë¥¼ CSV ì§ë ¬í™”
          const header = ['row','unitPrice','quantity','supply(T)','vat(Z)'];
          const rows = this.lines.map(l => [
            l.row,
            this.toNumber(l.unitPrice),
            this.toNumber(l.quantity),
            Number(l.supply)||0,
            Number(l.vat)||0
          ]);

          const csv = [header, ...rows]
            .map(r => r.map(v => {
              const s = String(v);
              return (s.includes(',') || s.includes('"') || s.includes('\n'))
                ? '"' + s.replaceAll('"','""') + '"'
                : s;
            }).join(','))
            .join('\n');

          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'í•­ëª©ë³„_ê¸ˆì•¡_ë¶€ê°€ì„¸_ê³„ì‚°ê¸°.csv';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }
      };
    }
  </script>

<!-- í•´ì»¤í†¤ ì„ ì • ì •ë³´ -->
<div id="selection-banner" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 14px;
    z-index: 10000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
">
    <div>
        <strong>ğŸ“Š ê±°ë˜ëª…ì„¸í‘œ (ìë™ê³„ì‚°)</strong>
        <span style="margin-left: 10px; opacity: 0.9;">| ìë™í™”</span>
    </div>
    <div style="display: flex; align-items: center; gap: 15px;">
        <span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 12px;">
            0ê°œ ìˆ˜ì‹
        </span>
        <button onclick="document.getElementById('selection-info').style.display='block'"
                style="background: white; color: #667eea; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 500;">
            ì„ ì • ì´ìœ  ë³´ê¸°
        </button>
    </div>
</div>

<div id="selection-info" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 10001;
    display: none;
    justify-content: center;
    align-items: center;
" onclick="this.style.display='none'">
    <div style="
        background: white;
        padding: 30px;
        border-radius: 16px;
        max-width: 500px;
        margin: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    " onclick="event.stopPropagation()">
        <h2 style="margin: 0 0 15px; color: #333;">ğŸ† í•´ì»¤í†¤ ì„ ì • ì´ìœ </h2>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <strong style="color: #667eea;">ìë™í™”</strong>
            <p style="margin: 10px 0 0; color: #555; line-height: 1.6;">ë™ì  ê³„ì‚° ë¡œì§ í¬í•¨ - ìë™í™” ê¸°ëŠ¥ ì‹œì—°</p>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <span style="background: #e3e8ff; color: #4c5fd5; padding: 4px 10px; border-radius: 12px; font-size: 12px;">ìë™ê³„ì‚°</span>
        </div>
        <button onclick="document.getElementById('selection-info').style.display='none'"
                style="margin-top: 20px; width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
            ë‹«ê¸°
        </button>
    </div>
</div>

<style>
body { padding-top: 56px !important; }
</style>
</body>
</html>
