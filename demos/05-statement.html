<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê³„ì‚°ì„œ ì‘ì„±Â·ì¶œë ¥ ì›¹ì•±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
  :root{
    --font-sans: "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
    --paper-w: 210mm;
    --paper-h: 297mm;
    --paper-mt: 10mm;
    --paper-mb: 10mm;
    --paper-ml: 19mm;
    --paper-mr: 4mm;

    --line: #1f2937;
    --muted: #6b7280;
    --bg: #ffffff;
    --card: #ffffff;
    --soft: #f8fafc;
  }

  html, body { height: 100%; }
  body{
    font-family: var(--font-sans);
    background: #f3f4f6;
    color: #111827;
  }

  .app-title{ letter-spacing: -0.2px; }

  .card{ border: 1px solid rgba(17,24,39,0.08); box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
  .card-header{ background: var(--soft); font-weight: 700; }

  .form-label{ font-weight: 600; }

  .num{ font-variant-numeric: tabular-nums; text-align: right; }
  input.num{ text-align: right; }

  .help-text{ color: var(--muted); font-size: .875rem; }
  .required::after{ content: " *"; color: #dc2626; font-weight: 700; }

  .table-excel{
    border-collapse: collapse;
    width: 100%;
    background: #fff;
  }
  .table-excel th, .table-excel td{
    border: 1px solid rgba(31,41,55,0.35);
    padding: 6px 6px;
    vertical-align: middle;
  }
  .table-excel th{ background: #f3f4f6; font-weight: 700; white-space: nowrap; }
  .table-excel input, .table-excel textarea{
    border: 1px solid rgba(31,41,55,0.15);
    border-radius: 6px;
    padding: 6px 8px;
    width: 100%;
    background: #fff;
  }
  .table-excel textarea{ resize: vertical; min-height: 34px; }

  .sticky-actions{
    position: sticky;
    bottom: 0;
    z-index: 10;
    background: linear-gradient(to top, rgba(243,244,246,0.96), rgba(243,244,246,0.70));
    padding-top: 10px;
    margin-top: 8px;
  }

  /* Preview */
  .preview-wrap{
    position: sticky;
    top: 1rem;
  }

  .preview-shell{
    background: #e5e7eb;
    padding: 12px;
    border-radius: 12px;
  }

  .a4{
    width: var(--paper-w);
    min-height: var(--paper-h);
    background: var(--bg);
    color: #111827;
    box-shadow: 0 6px 24px rgba(0,0,0,0.12);
    margin: 0 auto;
    position: relative;
    overflow: hidden;
  }

  .a4-inner{
    padding: 0;
  }

  /* Print area typographic */
  #print-area{
    width: var(--paper-w);
    min-height: var(--paper-h);
    padding: var(--paper-mt) var(--paper-mr) var(--paper-mb) var(--paper-ml);
  }

  .print-title{
    font-size: 20px;
    font-weight: 800;
    text-align: center;
    margin: 2mm 0 4mm;
  }

  .print-meta{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2mm;
    font-size: 12px;
  }

  .box{
    border: 1px solid var(--line);
    padding: 2.5mm;
  }

  .kv{
    display: grid;
    grid-template-columns: 34mm 1fr;
    gap: 1.5mm;
    align-items: center;
    margin: 0.8mm 0;
  }
  .kv .k{ color: #111827; font-weight: 700; }
  .kv .v{ border-bottom: 1px dotted rgba(31,41,55,0.45); min-height: 5mm; padding: 0 1mm; }

  .items-table{
    width: 100%;
    border-collapse: collapse;
    margin-top: 3mm;
    font-size: 11.5px;
  }
  .items-table th, .items-table td{
    border: 1px solid var(--line);
    padding: 1.8mm 1.5mm;
    vertical-align: middle;
  }
  .items-table th{ background: #f3f4f6; font-weight: 800; }

  .right{ text-align: right; }
  .center{ text-align: center; }

  .summary-grid{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2mm;
    margin-top: 3mm;
    font-size: 12px;
  }

  .summary-table{
    width: 100%;
    border-collapse: collapse;
  }
  .summary-table td{
    border: 1px solid var(--line);
    padding: 2mm 2mm;
  }
  .summary-table .label{ background: #f3f4f6; font-weight: 800; width: 42%; }

  .note-box{ margin-top: 3mm; }
  .note-text{ min-height: 12mm; white-space: pre-wrap; }

  /* Mobile: preview full width */
  @media (max-width: 991.98px){
    .preview-wrap{ position: static; }
    .a4{ width: 100%; min-height: auto; }
    #print-area{ width: 100%; min-height: auto; padding: 12px; }
  }

  /* Print */
  @page{
    size: A4 portrait;
    margin: var(--paper-mt) var(--paper-mr) var(--paper-mb) var(--paper-ml);
  }

  @media print{
    body{ background: #fff; }
    .container, .container-fluid{ max-width: none !important; }

    .no-print, .no-print *{ display: none !important; }

    /* Only print preview */
    #print-host{ display: block !important; }
    #print-area{
      box-shadow: none !important;
      margin: 0 !important;
      padding: 0 !important; /* @page margin is used */
      width: auto !important;
      min-height: auto !important;
    }

    .a4, .preview-shell{ box-shadow: none !important; background: transparent !important; padding: 0 !important; }
  }
  </style>
</head>
<body>
  <div class="container-fluid py-3" x-data="appData()" x-init="init()">
    <header class="mb-3 no-print">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div>
          <h1 class="h4 mb-0 app-title">ê³„ì‚°ì„œ ì‘ì„±Â·ì¶œë ¥ ì›¹ì•±</h1>
          <div class="help-text">ì—‘ì…€ â€˜ê³„ì‚°ì„œ.xlsxâ€™ ë ˆì´ì•„ì›ƒì„ ì°¸ê³ í•œ í‘œì¤€ ê³„ì‚°ì„œ ì…ë ¥/ë¯¸ë¦¬ë³´ê¸°/A4 ì¶œë ¥</div>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <button type="button" class="btn btn-outline-secondary" @click="resetAll()">ì´ˆê¸°í™”</button>
          <button type="button" class="btn btn-primary" @click="print()">ì¸ì‡„</button>
        </div>
      </div>
      <hr class="mt-3 mb-0" />
    </header>

    <main class="row g-3 align-items-start">
      <!-- Left: Inputs -->
      <div class="col-12 col-lg-6 no-print">
        <!-- Basic info -->
        <section class="card" aria-labelledby="basic-info">
          <div class="card-header" id="basic-info">ê¸°ë³¸ì •ë³´(ê³µê¸‰ì/ê³µê¸‰ë°›ëŠ”ì/ë¬¸ì„œì •ë³´)</div>
          <div class="card-body">
            <form class="row g-3" @submit.prevent>
              <div class="col-md-6">
                <label class="form-label required" for="issueDate">ì‘ì„±ì¼ì</label>
                <input class="form-control" id="issueDate" type="date" x-model="state.issueDate" @change="calculate()" required />
              </div>
              <div class="col-md-6">
                <label class="form-label" for="invoiceNo">ê³„ì‚°ì„œ(ë¬¸ì„œ)ë²ˆí˜¸</label>
                <input class="form-control" id="invoiceNo" type="text" x-model.trim="state.invoiceNo" @input="calculate()" placeholder="ì˜ˆ: 2025-0001" />
              </div>

              <div class="col-12"><hr class="my-1" /></div>

              <div class="col-12">
                <div class="fw-bold mb-2">ê³µê¸‰ì</div>
              </div>
              <div class="col-md-6">
                <label class="form-label required" for="supplierName">ìƒí˜¸(ì„±ëª…)</label>
                <input class="form-control" id="supplierName" type="text" x-model.trim="state.supplierName" @input="calculate()" required />
              </div>
              <div class="col-md-6">
                <label class="form-label required" for="supplierBizNo">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label>
                <input class="form-control" id="supplierBizNo" type="text" x-model.trim="state.supplierBizNo" @input="onBizNoInput('supplierBizNo')" placeholder="ì˜ˆ: 123-45-67890" required
                  :class="{ 'is-invalid': state.supplierBizNo && !validateBusinessNumber(state.supplierBizNo) }"
                  aria-describedby="supplierBizNoHelp supplierBizNoInvalid" />
                <div class="help-text" id="supplierBizNoHelp">í•˜ì´í”ˆ(-)ì€ ìë™ìœ¼ë¡œ ë¬´ì‹œë©ë‹ˆë‹¤.</div>
                <div class="invalid-feedback" id="supplierBizNoInvalid">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ëŠ” ìˆ«ì 10ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.</div>
              </div>
              <div class="col-12">
                <label class="form-label" for="supplierAddress">ì£¼ì†Œ</label>
                <input class="form-control" id="supplierAddress" type="text" x-model.trim="state.supplierAddress" @input="calculate()" />
              </div>
              <div class="col-md-6">
                <label class="form-label" for="supplierBizType">ì—…íƒœ</label>
                <input class="form-control" id="supplierBizType" type="text" x-model.trim="state.supplierBizType" @input="calculate()" />
              </div>
              <div class="col-md-6">
                <label class="form-label" for="supplierBizItem">ì¢…ëª©</label>
                <input class="form-control" id="supplierBizItem" type="text" x-model.trim="state.supplierBizItem" @input="calculate()" />
              </div>
              <div class="col-12">
                <label class="form-label" for="supplierContact">ë‹´ë‹¹ì/ì—°ë½ì²˜</label>
                <input class="form-control" id="supplierContact" type="text" x-model.trim="state.supplierContact" @input="calculate()" placeholder="ì˜ˆ: í™ê¸¸ë™ / 010-0000-0000" />
              </div>

              <div class="col-12"><hr class="my-1" /></div>

              <div class="col-12">
                <div class="fw-bold mb-2">ê³µê¸‰ë°›ëŠ”ì</div>
              </div>
              <div class="col-md-6">
                <label class="form-label required" for="buyerName">ìƒí˜¸(ì„±ëª…)</label>
                <input class="form-control" id="buyerName" type="text" x-model.trim="state.buyerName" @input="calculate()" required />
              </div>
              <div class="col-md-6">
                <label class="form-label required" for="buyerBizNo">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label>
                <input class="form-control" id="buyerBizNo" type="text" x-model.trim="state.buyerBizNo" @input="onBizNoInput('buyerBizNo')" placeholder="ì˜ˆ: 123-45-67890" required
                  :class="{ 'is-invalid': state.buyerBizNo && !validateBusinessNumber(state.buyerBizNo) }"
                  aria-describedby="buyerBizNoHelp buyerBizNoInvalid" />
                <div class="help-text" id="buyerBizNoHelp">í•˜ì´í”ˆ(-)ì€ ìë™ìœ¼ë¡œ ë¬´ì‹œë©ë‹ˆë‹¤.</div>
                <div class="invalid-feedback" id="buyerBizNoInvalid">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ëŠ” ìˆ«ì 10ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.</div>
              </div>
              <div class="col-12">
                <label class="form-label" for="buyerAddress">ì£¼ì†Œ</label>
                <input class="form-control" id="buyerAddress" type="text" x-model.trim="state.buyerAddress" @input="calculate()" />
              </div>
              <div class="col-12">
                <label class="form-label" for="buyerContact">ë‹´ë‹¹ì/ì—°ë½ì²˜</label>
                <input class="form-control" id="buyerContact" type="text" x-model.trim="state.buyerContact" @input="calculate()" placeholder="ì˜ˆ: ê¹€ë‹´ë‹¹ / 02-000-0000" />
              </div>

              <div class="col-12"><hr class="my-1" /></div>

              <div class="col-md-4">
                <label class="form-label" for="taxMode">ê³¼ì„¸ êµ¬ë¶„</label>
                <select class="form-select" id="taxMode" x-model="state.taxMode" @change="calculate()">
                  <option value="ê³¼ì„¸">ê³¼ì„¸</option>
                  <option value="ë©´ì„¸">ë©´ì„¸</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label" for="vatRate">ë¶€ê°€ì„¸ìœ¨(%)</label>
                <input class="form-control num" id="vatRate" type="number" min="0" max="100" step="0.1" x-model.number="state.vatRate" @input="calculate()"
                  :disabled="state.taxMode === 'ë©´ì„¸'" />
                <div class="help-text">ë©´ì„¸ ì„ íƒ ì‹œ ë¶€ê°€ì„¸ìœ¨ì€ ë¬´ì‹œë©ë‹ˆë‹¤.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label" for="notes">ë¹„ê³ </label>
                <input class="form-control" id="notes" type="text" x-model.trim="state.notes" @input="calculate()" />
              </div>
            </form>
          </div>
        </section>

        <!-- Items -->
        <section class="card mt-3" aria-labelledby="items">
          <div class="card-header d-flex align-items-center justify-content-between" id="items">
            <span>í’ˆëª© ë‚´ì—­</span>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-outline-primary" @click="addRow()">í–‰ ì¶”ê°€</button>
              <button type="button" class="btn btn-sm btn-outline-secondary" @click="addSampleRows()">ìƒ˜í”Œ</button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table-excel" aria-label="í’ˆëª© ë‚´ì—­ í…Œì´ë¸”">
                <thead>
                  <tr>
                    <th style="width: 92px;">ì¼ì</th>
                    <th>í’ˆëª©ëª…</th>
                    <th style="width: 120px;">ê·œê²©</th>
                    <th style="width: 84px;" class="right">ìˆ˜ëŸ‰</th>
                    <th style="width: 120px;" class="right">ë‹¨ê°€</th>
                    <th style="width: 140px;" class="right">ê³µê¸‰ê°€ì•¡</th>
                    <th style="width: 120px;" class="right">ë¶€ê°€ì„¸</th>
                    <th style="width: 140px;" class="right">í•©ê³„</th>
                    <th style="width: 160px;">ë¹„ê³ </th>
                    <th style="width: 70px;" class="center">ì‚­ì œ</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(row, idx) in state.lineItems" :key="row._id">
                    <tr>
                      <td>
                        <input type="date" x-model="row.date" @change="calculate()" :aria-label="`í’ˆëª© ${idx+1} ì¼ì`" />
                      </td>
                      <td>
                        <input type="text" x-model.trim="row.name" @input="calculate()" :aria-label="`í’ˆëª© ${idx+1} í’ˆëª©ëª…`" placeholder="ì˜ˆ: ìƒí’ˆ/ìš©ì—­ëª…" />
                      </td>
                      <td>
                        <input type="text" x-model.trim="row.spec" @input="calculate()" :aria-label="`í’ˆëª© ${idx+1} ê·œê²©`" placeholder="ì˜ˆ: EA" />
                      </td>
                      <td>
                        <input class="num" type="number" min="0" step="0.01" x-model.number="row.qty" @input="calculate()" :aria-label="`í’ˆëª© ${idx+1} ìˆ˜ëŸ‰`" />
                      </td>
                      <td>
                        <input class="num" type="number" min="0" step="1" x-model.number="row.unitPrice" @input="calculate()" :aria-label="`í’ˆëª© ${idx+1} ë‹¨ê°€`" />
                      </td>
                      <td class="num" x-text="formatCurrencyKRW(row.supplyAmount)"></td>
                      <td class="num" x-text="formatCurrencyKRW(row.vatAmount)"></td>
                      <td class="num" x-text="formatCurrencyKRW(row.totalAmount)"></td>
                      <td>
                        <input type="text" x-model.trim="row.note" @input="calculate()" :aria-label="`í’ˆëª© ${idx+1} ë¹„ê³ `" />
                      </td>
                      <td class="center">
                        <button type="button" class="btn btn-sm btn-outline-danger" @click="removeRow(idx)" :aria-label="`í’ˆëª© ${idx+1} ì‚­ì œ`">ì‚­ì œ</button>
                      </td>
                    </tr>
                  </template>

                  <tr x-show="state.lineItems.length === 0">
                    <td colspan="10" class="text-center text-muted">í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤. â€œí–‰ ì¶”ê°€â€ë¥¼ ëˆŒëŸ¬ ì…ë ¥í•˜ì„¸ìš”.</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="row g-2 mt-3">
              <div class="col-12 col-md-4">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="fw-bold">ê³µê¸‰ê°€ì•¡(í’ˆëª©í•©ê³„)</div>
                  <div class="num" x-text="formatCurrencyKRW(state.itemsSupplyAmount)"></div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="fw-bold">ë¶€ê°€ì„¸(í’ˆëª©í•©ê³„)</div>
                  <div class="num" x-text="formatCurrencyKRW(state.itemsVatAmount)"></div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="fw-bold">í•©ê³„ê¸ˆì•¡(í’ˆëª©í•©ê³„)</div>
                  <div class="num" x-text="formatCurrencyKRW(state.itemsTotalAmount)"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Totals/Payment -->
        <section class="card mt-3" aria-labelledby="totals">
          <div class="card-header" id="totals">í•©ê³„/ê²°ì œì •ë³´</div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label" for="discountAmount">í• ì¸ê¸ˆì•¡</label>
                <input class="form-control num" id="discountAmount" type="number" min="0" step="1" x-model.number="state.discountAmount" @input="calculate()" />
              </div>
              <div class="col-md-6">
                <label class="form-label" for="extraFee">ì¶”ê°€ë¹„ìš©(ë°°ì†¡ë¹„ ë“±)</label>
                <input class="form-control num" id="extraFee" type="number" min="0" step="1" x-model.number="state.extraFee" @input="calculate()" />
              </div>

              <div class="col-md-6">
                <label class="form-label" for="paymentDueDate">ì§€ê¸‰ê¸°í•œ</label>
                <input class="form-control" id="paymentDueDate" type="date" x-model="state.paymentDueDate" @change="calculate()" />
              </div>
              <div class="col-md-6">
                <label class="form-label" for="paymentMethod">ê²°ì œìˆ˜ë‹¨</label>
                <select class="form-select" id="paymentMethod" x-model="state.paymentMethod" @change="calculate()">
                  <option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option>
                  <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                  <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                  <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label" for="bankInfo">ì…ê¸ˆê³„ì¢Œ/ì•ˆë‚´</label>
                <input class="form-control" id="bankInfo" type="text" x-model.trim="state.bankInfo" @input="calculate()" placeholder="ì˜ˆ: OOì€í–‰ 123-456-7890 (ì˜ˆê¸ˆì£¼: í™ê¸¸ë™)" />
              </div>

              <div class="col-12"><hr class="my-1" /></div>

              <div class="col-md-4">
                <div class="d-flex justify-content-between">
                  <div class="fw-bold">ìµœì¢… ê³µê¸‰ê°€ì•¡</div>
                  <div class="num" x-text="formatCurrencyKRW(state.finalSupplyAmount)"></div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="d-flex justify-content-between">
                  <div class="fw-bold">ìµœì¢… ë¶€ê°€ì„¸</div>
                  <div class="num" x-text="formatCurrencyKRW(state.finalVatAmount)"></div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="d-flex justify-content-between">
                  <div class="fw-bold">ìµœì¢… í•©ê³„ê¸ˆì•¡</div>
                  <div class="num" x-text="formatCurrencyKRW(state.finalTotalAmount)"></div>
                </div>
              </div>

              <div class="col-12">
                <div class="alert alert-warning mb-0" role="alert" x-show="!isFormValid" x-transition>
                  í•„ìˆ˜ ì…ë ¥ ë˜ëŠ” ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (ì¸ì‡„ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ ë¬¸ì„œ ì™„ì„±ë„ë¥¼ ìœ„í•´ ì ê²€ ê¶Œì¥)
                </div>
              </div>
            </div>

            <div class="sticky-actions mt-3">
              <div class="d-flex gap-2 justify-content-end">
                <button type="button" class="btn btn-outline-secondary" @click="calculate()">ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ </button>
                <button type="button" class="btn btn-primary" @click="print()">ì¸ì‡„</button>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Right: Preview -->
      <div class="col-12 col-lg-6" id="print-host">
        <section class="preview-wrap" aria-labelledby="preview">
          <div class="d-flex align-items-center justify-content-between mb-2 no-print">
            <div>
              <div class="fw-bold" id="preview">ë¯¸ë¦¬ë³´ê¸°/ì¶œë ¥</div>
              <div class="help-text">ì¸ì‡„ ì‹œ ì´ ì˜ì—­ë§Œ A4ë¡œ ì¶œë ¥ë©ë‹ˆë‹¤.</div>
            </div>
            <div class="d-flex gap-2 no-print">
              <button type="button" class="btn btn-sm btn-outline-secondary" @click="downloadJson()">JSON ì €ì¥</button>
              <label class="btn btn-sm btn-outline-secondary mb-0" for="jsonFile">JSON ë¶ˆëŸ¬ì˜¤ê¸°</label>
              <input id="jsonFile" type="file" accept="application/json" class="d-none" @change="importJson($event)" />
            </div>
          </div>

          <div class="preview-shell">
            <div class="a4">
              <div class="a4-inner" id="print-area" x-html="state.printPreviewHtml"></div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
  /* ===== Excel formula helper functions (provided) ===== */
  function _sum(...args) {
      return args.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
  }
  function _sumRange(rangeData) {
      if (Array.isArray(rangeData)) {
          return rangeData.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
      }
      return parseFloat(rangeData) || 0;
  }
  function _average(...args) {
      const flat = args.flat().filter(x => x !== null && x !== '' && !isNaN(x));
      return flat.length ? _sum(...flat) / flat.length : 0;
  }
  function _averageRange(rangeData) {
      if (Array.isArray(rangeData)) {
          const flat = rangeData.flat().filter(x => x !== null && x !== '' && !isNaN(x));
          return flat.length ? _sumRange(flat) / flat.length : 0;
      }
      return parseFloat(rangeData) || 0;
  }
  function _count(...args) {
      return args.flat().filter(x => typeof x === 'number' && !isNaN(x)).length;
  }
  function _counta(...args) {
      return args.flat().filter(x => x !== null && x !== '' && x !== undefined).length;
  }
  function _and(...args) {
      return args.every(x => Boolean(x));
  }
  function _or(...args) {
      return args.some(x => Boolean(x));
  }
  function _round(num, digits = 0) {
      const factor = Math.pow(10, digits);
      return Math.round(num * factor) / factor;
  }
  function _roundUp(num, digits = 0) {
      const factor = Math.pow(10, digits);
      return Math.ceil(num * factor) / factor;
  }
  function _roundDown(num, digits = 0) {
      const factor = Math.pow(10, digits);
      return Math.floor(num * factor) / factor;
  }
  function _len(text) {
      return String(text).length;
  }
  function _left(text, numChars = 1) {
      return String(text).substring(0, numChars);
  }
  function _right(text, numChars = 1) {
      const str = String(text);
      return str.substring(str.length - numChars);
  }
  function _mid(text, startNum, numChars) {
      return String(text).substring(startNum - 1, startNum - 1 + numChars);
  }
  function _trim(text) {
      return String(text).trim();
  }
  function _upper(text) {
      return String(text).toUpperCase();
  }
  function _lower(text) {
      return String(text).toLowerCase();
  }
  function _concat(...args) {
      return args.join('');
  }
  function formatNumber(num, decimals = 0) {
      return new Intl.NumberFormat('ko-KR', {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals
      }).format(num);
  }
  function formatCurrency(num) {
      return new Intl.NumberFormat('ko-KR', {
          style: 'currency',
          currency: 'KRW',
          maximumFractionDigits: 0
      }).format(num);
  }
  function formatPercent(num, decimals = 1) {
      return new Intl.NumberFormat('ko-KR', {
          style: 'percent',
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals
      }).format(num / 100);
  }

  /* ===== App logic ===== */
  function uid() {
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function toNumber(v) {
    const n = (typeof v === 'string') ? v.replace(/,/g, '') : v;
    const out = Number(n);
    return Number.isFinite(out) ? out : 0;
  }

  function safeText(v) {
    return (v ?? '').toString();
  }

  function escapeHtml(str) {
    return safeText(str)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  function formatDateKR(dateStr){
    if(!dateStr) return '';
    // keep ISO date as YYYY-MM-DD, but show KR style
    const d = new Date(dateStr);
    if (Number.isNaN(d.getTime())) return escapeHtml(dateStr);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }

  function formatCurrencyKRW(value){
    const n = toNumber(value);
    // â€œì›â€ suffix to match typical invoice style
    return new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(Math.round(n)) + 'ì›';
  }

  function validateBusinessNumber(bizNo){
    const digits = safeText(bizNo).replace(/[^0-9]/g,'');
    return digits.length === 10;
  }

  function calculateLineItemAmounts(lineItems, taxMode, vatRate){
    const rate = (taxMode === 'ê³¼ì„¸') ? (toNumber(vatRate) / 100) : 0;

    const normalized = (lineItems || []).map((r) => {
      const qty = Math.max(0, toNumber(r.qty));
      const unitPrice = Math.max(0, toNumber(r.unitPrice));
      const supplyAmount = Math.round(qty * unitPrice);
      const vatAmount = (taxMode === 'ê³¼ì„¸') ? Math.round(supplyAmount * rate) : 0;
      const totalAmount = supplyAmount + vatAmount;

      return {
        ...r,
        qty,
        unitPrice,
        supplyAmount,
        vatAmount,
        totalAmount
      };
    });

    return normalized;
  }

  function calculateTotals(itemsSupplyAmount, itemsVatAmount, discountAmount, extraFee, taxMode, vatRate){
    // Standard logic:
    // - discount reduces supply amount
    // - extraFee increases supply amount
    // - VAT is recalculated on adjusted supply if taxable
    const supply0 = Math.max(0, toNumber(itemsSupplyAmount));
    const vat0 = Math.max(0, toNumber(itemsVatAmount));

    const discount = Math.max(0, toNumber(discountAmount));
    const extra = Math.max(0, toNumber(extraFee));

    const adjustedSupply = Math.max(0, Math.round(supply0 - discount + extra));

    if (taxMode === 'ë©´ì„¸') {
      return {
        finalSupplyAmount: adjustedSupply,
        finalVatAmount: 0,
        finalTotalAmount: adjustedSupply
      };
    }

    const rate = Math.max(0, toNumber(vatRate)) / 100;
    // Prefer recalculation on adjusted supply for consistency with discount/fee.
    const finalVatAmount = Math.round(adjustedSupply * rate);
    const finalTotalAmount = adjustedSupply + finalVatAmount;

    return {
      finalSupplyAmount: adjustedSupply,
      finalVatAmount,
      finalTotalAmount
    };
  }

  function renderPrintTemplate(state){
    const s = state;

    const supplierBizDigits = safeText(s.supplierBizNo).replace(/[^0-9]/g,'');
    const buyerBizDigits = safeText(s.buyerBizNo).replace(/[^0-9]/g,'');

    const items = (s.lineItems || []).filter(r => {
      // show non-empty rows (name or amounts)
      return safeText(r.name).trim() !== '' || toNumber(r.qty) > 0 || toNumber(r.unitPrice) > 0;
    });

    // pad to stable height (prevents page wobble)
    const targetRows = 20;
    const padded = items.slice(0, targetRows);
    while (padded.length < targetRows) {
      padded.push({ date:'', name:'', spec:'', qty:'', unitPrice:'', supplyAmount:'', vatAmount:'', totalAmount:'', note:'' });
    }

    const taxLabel = (s.taxMode === 'ë©´ì„¸') ? 'ë©´ì„¸' : `ê³¼ì„¸ (${formatPercent(toNumber(s.vatRate), 1)})`;

    const rowsHtml = padded.map((r) => {
      const qty = (r.qty === '' || r.qty === null || r.qty === undefined) ? '' : formatNumber(toNumber(r.qty), 2);
      const unitPrice = (r.unitPrice === '' || r.unitPrice === null || r.unitPrice === undefined) ? '' : formatNumber(Math.round(toNumber(r.unitPrice)), 0);

      const supply = (r.supplyAmount === '' || r.supplyAmount === null || r.supplyAmount === undefined) ? '' : formatNumber(Math.round(toNumber(r.supplyAmount)), 0);
      const vat = (r.vatAmount === '' || r.vatAmount === null || r.vatAmount === undefined) ? '' : formatNumber(Math.round(toNumber(r.vatAmount)), 0);
      const total = (r.totalAmount === '' || r.totalAmount === null || r.totalAmount === undefined) ? '' : formatNumber(Math.round(toNumber(r.totalAmount)), 0);

      return `
        <tr>
          <td class="center">${escapeHtml(formatDateKR(r.date))}</td>
          <td>${escapeHtml(r.name)}</td>
          <td class="center">${escapeHtml(r.spec)}</td>
          <td class="right">${escapeHtml(qty)}</td>
          <td class="right">${escapeHtml(unitPrice)}</td>
          <td class="right">${escapeHtml(supply)}</td>
          <td class="right">${escapeHtml(vat)}</td>
          <td class="right">${escapeHtml(total)}</td>
          <td>${escapeHtml(r.note)}</td>
        </tr>`;
    }).join('');

    return `
      <div class="print-title">ê³„ì‚°ì„œ</div>

      <div class="print-meta">
        <div class="box">
          <div class="fw-bold mb-1">ê³µê¸‰ì</div>
          <div class="kv"><div class="k">ìƒí˜¸(ì„±ëª…)</div><div class="v">${escapeHtml(s.supplierName)}</div></div>
          <div class="kv"><div class="k">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</div><div class="v">${escapeHtml(supplierBizDigits)}</div></div>
          <div class="kv"><div class="k">ì£¼ì†Œ</div><div class="v">${escapeHtml(s.supplierAddress)}</div></div>
          <div class="kv"><div class="k">ì—…íƒœ</div><div class="v">${escapeHtml(s.supplierBizType)}</div></div>
          <div class="kv"><div class="k">ì¢…ëª©</div><div class="v">${escapeHtml(s.supplierBizItem)}</div></div>
          <div class="kv"><div class="k">ë‹´ë‹¹ì/ì—°ë½ì²˜</div><div class="v">${escapeHtml(s.supplierContact)}</div></div>
        </div>

        <div class="box">
          <div class="fw-bold mb-1">ê³µê¸‰ë°›ëŠ”ì</div>
          <div class="kv"><div class="k">ìƒí˜¸(ì„±ëª…)</div><div class="v">${escapeHtml(s.buyerName)}</div></div>
          <div class="kv"><div class="k">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</div><div class="v">${escapeHtml(buyerBizDigits)}</div></div>
          <div class="kv"><div class="k">ì£¼ì†Œ</div><div class="v">${escapeHtml(s.buyerAddress)}</div></div>
          <div class="kv"><div class="k">ë‹´ë‹¹ì/ì—°ë½ì²˜</div><div class="v">${escapeHtml(s.buyerContact)}</div></div>
          <div class="kv"><div class="k">ì‘ì„±ì¼ì</div><div class="v">${escapeHtml(formatDateKR(s.issueDate))}</div></div>
          <div class="kv"><div class="k">ë¬¸ì„œë²ˆí˜¸</div><div class="v">${escapeHtml(s.invoiceNo)}</div></div>
          <div class="kv"><div class="k">ê³¼ì„¸êµ¬ë¶„</div><div class="v">${escapeHtml(taxLabel)}</div></div>
        </div>
      </div>

      <table class="items-table" aria-label="ì¸ì‡„ìš© í’ˆëª© í…Œì´ë¸”">
        <thead>
          <tr>
            <th style="width: 20mm;" class="center">ì¼ì</th>
            <th>í’ˆëª©ëª…</th>
            <th style="width: 18mm;" class="center">ê·œê²©</th>
            <th style="width: 16mm;" class="right">ìˆ˜ëŸ‰</th>
            <th style="width: 22mm;" class="right">ë‹¨ê°€</th>
            <th style="width: 24mm;" class="right">ê³µê¸‰ê°€ì•¡</th>
            <th style="width: 20mm;" class="right">ë¶€ê°€ì„¸</th>
            <th style="width: 24mm;" class="right">í•©ê³„</th>
            <th style="width: 26mm;">ë¹„ê³ </th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}
        </tbody>
      </table>

      <div class="summary-grid">
        <div class="box">
          <div class="fw-bold mb-2">í•©ê³„</div>
          <table class="summary-table" aria-label="ì¸ì‡„ìš© í•©ê³„ í…Œì´ë¸”">
            <tr><td class="label">í’ˆëª© ê³µê¸‰ê°€ì•¡</td><td class="right">${escapeHtml(formatCurrencyKRW(s.itemsSupplyAmount))}</td></tr>
            <tr><td class="label">í’ˆëª© ë¶€ê°€ì„¸</td><td class="right">${escapeHtml(formatCurrencyKRW(s.itemsVatAmount))}</td></tr>
            <tr><td class="label">í’ˆëª© í•©ê³„</td><td class="right">${escapeHtml(formatCurrencyKRW(s.itemsTotalAmount))}</td></tr>
            <tr><td class="label">í• ì¸ê¸ˆì•¡</td><td class="right">${escapeHtml(formatCurrencyKRW(s.discountAmount))}</td></tr>
            <tr><td class="label">ì¶”ê°€ë¹„ìš©</td><td class="right">${escapeHtml(formatCurrencyKRW(s.extraFee))}</td></tr>
            <tr><td class="label">ìµœì¢… ê³µê¸‰ê°€ì•¡</td><td class="right">${escapeHtml(formatCurrencyKRW(s.finalSupplyAmount))}</td></tr>
            <tr><td class="label">ìµœì¢… ë¶€ê°€ì„¸</td><td class="right">${escapeHtml(formatCurrencyKRW(s.finalVatAmount))}</td></tr>
            <tr><td class="label">ìµœì¢… í•©ê³„ê¸ˆì•¡</td><td class="right fw-bold">${escapeHtml(formatCurrencyKRW(s.finalTotalAmount))}</td></tr>
          </table>
        </div>

        <div>
          <div class="box">
            <div class="fw-bold mb-1">ê²°ì œì •ë³´</div>
            <div class="kv"><div class="k">ì§€ê¸‰ê¸°í•œ</div><div class="v">${escapeHtml(formatDateKR(s.paymentDueDate))}</div></div>
            <div class="kv"><div class="k">ê²°ì œìˆ˜ë‹¨</div><div class="v">${escapeHtml(s.paymentMethod)}</div></div>
            <div class="kv"><div class="k">ì…ê¸ˆê³„ì¢Œ/ì•ˆë‚´</div><div class="v">${escapeHtml(s.bankInfo)}</div></div>
          </div>

          <div class="box note-box">
            <div class="fw-bold mb-1">ë¹„ê³ </div>
            <div class="note-text">${escapeHtml(s.notes)}</div>
          </div>
        </div>
      </div>
    `;
  }

  function appData(){
    return {
      state: {
        // basic
        issueDate: '',
        invoiceNo: '',
        supplierName: '',
        supplierBizNo: '',
        supplierAddress: '',
        supplierBizType: '',
        supplierBizItem: '',
        supplierContact: '',
        buyerName: '',
        buyerBizNo: '',
        buyerAddress: '',
        buyerContact: '',
        notes: '',
        taxMode: 'ê³¼ì„¸',
        vatRate: 10,

        // items
        lineItems: [],

        // totals
        itemsSupplyAmount: 0,
        itemsVatAmount: 0,
        itemsTotalAmount: 0,

        discountAmount: 0,
        extraFee: 0,
        paymentDueDate: '',
        paymentMethod: 'ê³„ì¢Œì´ì²´',
        bankInfo: '',

        finalSupplyAmount: 0,
        finalVatAmount: 0,
        finalTotalAmount: 0,

        // preview html
        printPreviewHtml: ''
      },

      init(){
        // default date
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth()+1).padStart(2,'0');
        const d = String(today.getDate()).padStart(2,'0');
        this.state.issueDate = `${y}-${m}-${d}`;
        // initial rows
        this.state.lineItems = [this.newRow(), this.newRow(), this.newRow()];
        this.calculate();
      },

      get isFormValid(){
        const s = this.state;
        const basicOk = !!s.issueDate && !!s.supplierName && !!s.buyerName;
        const bizOk = validateBusinessNumber(s.supplierBizNo) && validateBusinessNumber(s.buyerBizNo);
        return basicOk && bizOk;
      },

      newRow(){
        return {
          _id: uid(),
          date: '',
          name: '',
          spec: '',
          qty: 0,
          unitPrice: 0,
          supplyAmount: 0,
          vatAmount: 0,
          totalAmount: 0,
          note: ''
        };
      },

      addRow(){
        this.state.lineItems.push(this.newRow());
        this.calculate();
      },

      removeRow(idx){
        this.state.lineItems.splice(idx, 1);
        this.calculate();
      },

      addSampleRows(){
        this.state.lineItems = [
          { ...this.newRow(), date: this.state.issueDate, name: 'ìƒí’ˆ A', spec: 'EA', qty: 2, unitPrice: 15000, note: '' },
          { ...this.newRow(), date: this.state.issueDate, name: 'ì„œë¹„ìŠ¤ B', spec: 'ê±´', qty: 1, unitPrice: 80000, note: 'ì›” ìœ ì§€ë³´ìˆ˜' },
          { ...this.newRow(), date: this.state.issueDate, name: 'ë°°ì†¡ë¹„', spec: '', qty: 1, unitPrice: 3000, note: '' }
        ];
        this.calculate();
      },

      onBizNoInput(field){
        // allow user typing; just recalc & validation display
        this.state[field] = safeText(this.state[field]);
        this.calculate();
      },

      validateBusinessNumber,
      formatCurrencyKRW,

      calculate(){
        // 1) normalize items
        const items = calculateLineItemAmounts(this.state.lineItems, this.state.taxMode, this.state.vatRate);
        this.state.lineItems = items;

        // 2) item totals
        const itemsSupplyAmount = items.reduce((acc, r) => acc + toNumber(r.supplyAmount), 0);
        const itemsVatAmount = items.reduce((acc, r) => acc + toNumber(r.vatAmount), 0);
        const itemsTotalAmount = items.reduce((acc, r) => acc + toNumber(r.totalAmount), 0);

        this.state.itemsSupplyAmount = Math.round(itemsSupplyAmount);
        this.state.itemsVatAmount = Math.round(itemsVatAmount);
        this.state.itemsTotalAmount = Math.round(itemsTotalAmount);

        // 3) final totals with discount/fee
        const finals = calculateTotals(
          this.state.itemsSupplyAmount,
          this.state.itemsVatAmount,
          this.state.discountAmount,
          this.state.extraFee,
          this.state.taxMode,
          this.state.vatRate
        );

        this.state.finalSupplyAmount = finals.finalSupplyAmount;
        this.state.finalVatAmount = finals.finalVatAmount;
        this.state.finalTotalAmount = finals.finalTotalAmount;

        // 4) preview html
        this.state.printPreviewHtml = renderPrintTemplate(this.state);
      },

      print(){
        // ensure preview up to date
        this.calculate();
        window.print();
      },

      resetAll(){
        if (!confirm('ëª¨ë“  ì…ë ¥ì„ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
        const keepDate = this.state.issueDate;
        this.state = {
          issueDate: keepDate,
          invoiceNo: '',
          supplierName: '',
          supplierBizNo: '',
          supplierAddress: '',
          supplierBizType: '',
          supplierBizItem: '',
          supplierContact: '',
          buyerName: '',
          buyerBizNo: '',
          buyerAddress: '',
          buyerContact: '',
          notes: '',
          taxMode: 'ê³¼ì„¸',
          vatRate: 10,
          lineItems: [this.newRow(), this.newRow(), this.newRow()],
          itemsSupplyAmount: 0,
          itemsVatAmount: 0,
          itemsTotalAmount: 0,
          discountAmount: 0,
          extraFee: 0,
          paymentDueDate: '',
          paymentMethod: 'ê³„ì¢Œì´ì²´',
          bankInfo: '',
          finalSupplyAmount: 0,
          finalVatAmount: 0,
          finalTotalAmount: 0,
          printPreviewHtml: ''
        };
        this.calculate();
      },

      downloadJson(){
        this.calculate();
        const data = {
          version: 1,
          exportedAt: new Date().toISOString(),
          state: this.state
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ê³„ì‚°ì„œ_${this.state.invoiceNo || 'ë¯¸ì§€ì •'}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      },

      async importJson(evt){
        const file = evt.target.files && evt.target.files[0];
        if (!file) return;
        try{
          const text = await file.text();
          const parsed = JSON.parse(text);
          if (!parsed || !parsed.state) throw new Error('stateê°€ ì—†ìŠµë‹ˆë‹¤.');

          // shallow merge with defaults for forward compatibility
          const incoming = parsed.state;
          const next = { ...this.state, ...incoming };

          // ensure rows have ids
          next.lineItems = (next.lineItems || []).map(r => ({ ...this.newRow(), ...r, _id: r._id || uid() }));
          this.state = next;
          this.calculate();
        }catch(e){
          alert('JSON ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + (e?.message || e));
        }finally{
          evt.target.value = '';
        }
      }
    };
  }
  </script>

<!-- í•´ì»¤í†¤ ì„ ì • ì •ë³´ -->
<div id="selection-banner" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 14px;
    z-index: 10000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
">
    <div>
        <strong>ğŸ“Š ê³„ì‚°ì„œ</strong>
        <span style="margin-left: 10px; opacity: 0.9;">| ì„¸ë¬´/íšŒê³„</span>
    </div>
    <div style="display: flex; align-items: center; gap: 15px;">
        <span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 12px;">
            0ê°œ ìˆ˜ì‹
        </span>
        <button onclick="document.getElementById('selection-info').style.display='block'"
                style="background: white; color: #667eea; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 500;">
            ì„ ì • ì´ìœ  ë³´ê¸°
        </button>
    </div>
</div>

<div id="selection-info" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 10001;
    display: none;
    justify-content: center;
    align-items: center;
" onclick="this.style.display='none'">
    <div style="
        background: white;
        padding: 30px;
        border-radius: 16px;
        max-width: 500px;
        margin: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    " onclick="event.stopPropagation()">
        <h2 style="margin: 0 0 15px; color: #333;">ğŸ† í•´ì»¤í†¤ ì„ ì • ì´ìœ </h2>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <strong style="color: #667eea;">ì„¸ë¬´/íšŒê³„</strong>
            <p style="margin: 10px 0 0; color: #555; line-height: 1.6;">ê¸°ë³¸ ì„¸ë¬´ ì–‘ì‹ - ë¹„ì¦ˆë‹ˆìŠ¤ ì‹¤ìš©ì„±</p>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            
        </div>
        <button onclick="document.getElementById('selection-info').style.display='none'"
                style="margin-top: 20px; width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
            ë‹«ê¸°
        </button>
    </div>
</div>

<style>
body { padding-top: 56px !important; }
</style>
</body>
</html>
