<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>기본교육 교육일지 작성/출력</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    :root{
      --font-sans: "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Malgun Gothic", "맑은 고딕", sans-serif;
      --ink:#111;
      --line:#000;
      --muted:#6c757d;
      --bg:#f6f7f9;
      --card:#fff;
      --required:#d63384;

      /* A4 */
      --a4-w: 210mm;
      --a4-h: 297mm;
      --margin-top: 0.75in;
      --margin-bottom: 0.75in;
      --margin-left: 0.7in;
      --margin-right: 0.7in;
    }

    html, body { height: 100%; }
    body{
      font-family: var(--font-sans);
      color: var(--ink);
      background: var(--bg);
    }

    .app-title{font-weight:700; letter-spacing:-0.02em;}

    .card{border:1px solid rgba(0,0,0,.08); box-shadow:0 1px 2px rgba(0,0,0,.04);}
    .card-header{background: #fff; font-weight: 700;}

    .required-mark{color:var(--required); font-weight:700; margin-left:.25rem;}

    .help-note{
      font-size:.875rem;
      color: var(--muted);
    }

    /* Preview container (screen) */
    .preview-shell{
      background: #e9ecef;
      border-radius: .5rem;
      padding: 1rem;
    }

    .preview-zoom{
      transform-origin: top left;
    }

    /* Printable area */
    #printArea{
      width: var(--a4-w);
      min-height: var(--a4-h);
      background:#fff;
      color: #000;
      margin: 0 auto;
      padding: var(--margin-top) var(--margin-right) var(--margin-bottom) var(--margin-left);
      box-sizing: border-box;
      border: 1px solid rgba(0,0,0,.15);
    }

    .doc-title{
      text-align:center;
      font-weight:800;
      font-size: 16pt;
      margin: 0 0 10mm 0;
      letter-spacing: .02em;
    }

    .doc-grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6mm;
      margin-bottom: 6mm;
    }

    .field{
      display:grid;
      grid-template-columns: 28mm 1fr;
      gap: 2mm;
      align-items: start;
    }

    .field .label{
      font-weight:700;
      font-size: 10.5pt;
      white-space: nowrap;
    }

    .field .value{
      font-size: 10.5pt;
      border-bottom: 1px solid var(--line);
      min-height: 6mm;
      padding: 0 1mm 1mm 1mm;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .section-title{
      font-weight:800;
      margin: 4mm 0 2mm 0;
      font-size: 11.5pt;
    }

    .block{
      border: 1px solid var(--line);
      padding: 3mm;
      min-height: 18mm;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 10.5pt;
    }

    table.attendee{
      width:100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 10.5pt;
    }
    table.attendee th, table.attendee td{
      border: 1px solid var(--line);
      padding: 2mm;
      vertical-align: middle;
      word-break: break-word;
      height: 10mm;
    }
    table.attendee th{font-weight:800; text-align:center;}

    .sign-box{height: 12mm;}

    .footer-sign{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 6mm;
      margin-top: 8mm;
    }

    .footer-sign .value{ text-align:center; }

    /* Inputs */
    .form-control, .form-select, textarea{
      border-radius: .5rem;
    }

    .toolbar .btn{border-radius: .75rem;}

    /* Print */
    @page{
      size: A4 portrait;
      margin: var(--margin-top) var(--margin-right) var(--margin-bottom) var(--margin-left);
    }

    @media print{
      body{ background:#fff; }
      .no-print{ display:none !important; }
      .preview-shell{ padding:0; background:transparent; }

      /* Print only the print area */
      body *{ visibility: hidden; }
      #printArea, #printArea *{ visibility: visible; }
      #printArea{
        position: absolute;
        left: 0;
        top: 0;
        width: calc(var(--a4-w) - 0mm);
        min-height: var(--a4-h);
        margin: 0;
        border: none;
        padding: 0; /* @page margin handles it */
      }
    }

    /* Screen scaling (fit into right column) */
    @media (max-width: 991.98px){
      #printArea{ width: 100%; min-height: unset; }
    }
  </style>
</head>
<body>
  <div class="container-fluid py-4" x-data="appData()" x-init="initializeForm()">
    <div class="row g-4">
      <!-- Left: Inputs -->
      <div class="col-12 col-lg-5 no-print">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <div>
            <h1 class="h4 app-title mb-1">기본교육 교육일지 작성/출력</h1>
            <div class="help-note">엑셀 ‘교육일지 양식’ 기반 템플릿입니다. 공용 PC 사용 시 <b>임시저장(LocalStorage)</b>에 개인정보가 남을 수 있으니 주의하세요.</div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header">버튼</div>
          <div class="card-body">
            <div class="toolbar d-flex flex-wrap gap-2">
              <button type="button" class="btn btn-primary" @click="onRefreshPreview()">미리보기 갱신</button>
              <button type="button" class="btn btn-outline-secondary" @click="saveDraft()">임시저장</button>
              <button type="button" class="btn btn-outline-secondary" @click="loadDraft(true)">불러오기</button>
              <button type="button" class="btn btn-outline-danger" @click="onReset()">초기화</button>
              <button type="button" class="btn btn-success" @click="exportToPDF()">인쇄/PDF 저장</button>
            </div>

            <div class="mt-3" x-show="ui.lastSavedAt" x-cloak>
              <div class="help-note">마지막 임시저장: <span x-text="ui.lastSavedAt"></span></div>
            </div>

            <template x-if="ui.errors.length">
              <div class="alert alert-danger mt-3 mb-0" role="alert" aria-live="polite">
                <div class="fw-bold mb-1">입력 오류</div>
                <ul class="mb-0">
                  <template x-for="(err, idx) in ui.errors" :key="idx">
                    <li x-text="err"></li>
                  </template>
                </ul>
              </div>
            </template>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header">교육일지 기본정보 입력</div>
          <div class="card-body">
            <form @submit.prevent>
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label" for="training_title">교육명<span class="required-mark" aria-hidden="true">*</span></label>
                  <input id="training_title" type="text" class="form-control" x-model.trim="form.training_title" :aria-describedby="'err_training_title'" placeholder="예: 신규입사자 기본교육" />
                  <div class="invalid-feedback d-block" id="err_training_title" x-show="fieldErrors.training_title" x-text="fieldErrors.training_title" x-cloak></div>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label" for="training_date">교육일자<span class="required-mark" aria-hidden="true">*</span></label>
                  <input id="training_date" type="date" class="form-control" x-model="form.training_date" :aria-describedby="'err_training_date'" />
                  <div class="invalid-feedback d-block" id="err_training_date" x-show="fieldErrors.training_date" x-text="fieldErrors.training_date" x-cloak></div>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label" for="training_time">교육시간</label>
                  <input id="training_time" type="text" class="form-control" x-model.trim="form.training_time" placeholder="예: 09:00~12:00 (3H)" />
                </div>

                <div class="col-12">
                  <label class="form-label" for="location">교육장소</label>
                  <input id="location" type="text" class="form-control" x-model.trim="form.location" placeholder="예: 3층 교육장" />
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label" for="instructor_name">강사/진행자</label>
                  <input id="instructor_name" type="text" class="form-control" x-model.trim="form.instructor_name" />
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label" for="department">부서</label>
                  <input id="department" type="text" class="form-control" x-model.trim="form.department" />
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label" for="participants_count">참석인원</label>
                  <input id="participants_count" type="number" class="form-control" min="0" step="1" x-model.number="form.participants_count" placeholder="예: 12" />
                </div>

                <div class="col-12">
                  <label class="form-label" for="training_goal">교육목표</label>
                  <textarea id="training_goal" class="form-control" rows="2" x-model.trim="form.training_goal" placeholder="교육 목표를 입력하세요"></textarea>
                </div>

                <div class="col-12">
                  <label class="form-label" for="training_content">교육내용</label>
                  <textarea id="training_content" class="form-control" rows="4" x-model.trim="form.training_content" placeholder="교육 내용을 입력하세요"></textarea>
                </div>

                <div class="col-12">
                  <label class="form-label" for="notes">비고</label>
                  <textarea id="notes" class="form-control" rows="2" x-model.trim="form.notes" placeholder="비고/특이사항"></textarea>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label" for="writer_name">작성자<span class="required-mark" aria-hidden="true">*</span></label>
                  <input id="writer_name" type="text" class="form-control" x-model.trim="form.writer_name" :aria-describedby="'err_writer_name'" />
                  <div class="invalid-feedback d-block" id="err_writer_name" x-show="fieldErrors.writer_name" x-text="fieldErrors.writer_name" x-cloak></div>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label" for="write_date">작성일<span class="required-mark" aria-hidden="true">*</span></label>
                  <input id="write_date" type="date" class="form-control" x-model="form.write_date" :aria-describedby="'err_write_date'" />
                  <div class="invalid-feedback d-block" id="err_write_date" x-show="fieldErrors.write_date" x-text="fieldErrors.write_date" x-cloak></div>
                </div>

                <div class="col-12">
                  <label class="form-label" for="approver_name">확인(승인자)</label>
                  <input id="approver_name" type="text" class="form-control" x-model.trim="form.approver_name" />
                </div>
              </div>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
            <span>교육 참석자 명단</span>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-outline-primary" @click="addAttendee()">행 추가</button>
              <button type="button" class="btn btn-sm btn-outline-secondary" @click="fillAttendeesTo10()">10행 맞춤</button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th style="width:70px;">No</th>
                    <th>성명</th>
                    <th style="width:140px;">사번</th>
                    <th style="width:160px;">부서</th>
                    <th style="width:140px;">서명</th>
                    <th style="width:90px;">삭제</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(row, idx) in form.attendees" :key="row._id">
                    <tr>
                      <td x-text="idx+1"></td>
                      <td><input type="text" class="form-control form-control-sm" x-model.trim="row.name" aria-label="참석자 성명" /></td>
                      <td><input type="text" class="form-control form-control-sm" x-model.trim="row.empId" aria-label="참석자 사번" /></td>
                      <td><input type="text" class="form-control form-control-sm" x-model.trim="row.dept" aria-label="참석자 부서" /></td>
                      <td><input type="text" class="form-control form-control-sm" x-model.trim="row.sign" aria-label="참석자 서명" /></td>
                      <td>
                        <button type="button" class="btn btn-sm btn-outline-danger" @click="removeAttendee(idx)" :disabled="form.attendees.length<=1">삭제</button>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
            <div class="help-note">인쇄 시에는 행 추가/삭제 버튼이 출력되지 않습니다.</div>
          </div>
        </div>
      </div>

      <!-- Right: Preview -->
      <div class="col-12 col-lg-7">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 no-print">
          <h2 class="h5 mb-0">인쇄 미리보기</h2>
          <div class="help-note">미리보기는 자동 반영됩니다(입력 변경 시). 인쇄 전 “미리보기 갱신”을 권장합니다.</div>
        </div>

        <div class="preview-shell mt-2">
          <div class="preview-zoom" :style="screenPreviewStyle()">
            <!-- PRINT AREA START -->
            <section id="printArea" aria-label="교육일지 인쇄 영역">
              <div class="doc-title">교육일지</div>

              <div class="doc-grid">
                <div class="field">
                  <div class="label">교육명</div>
                  <div class="value" id="pv_training_title" x-text="form.training_title"></div>
                </div>
                <div class="field">
                  <div class="label">부서</div>
                  <div class="value" id="pv_department" x-text="form.department"></div>
                </div>

                <div class="field">
                  <div class="label">교육일자</div>
                  <div class="value" id="pv_training_date" x-text="formatDateKor(form.training_date)"></div>
                </div>
                <div class="field">
                  <div class="label">교육시간</div>
                  <div class="value" id="pv_training_time" x-text="form.training_time"></div>
                </div>

                <div class="field">
                  <div class="label">교육장소</div>
                  <div class="value" id="pv_location" x-text="form.location"></div>
                </div>
                <div class="field">
                  <div class="label">강사/진행</div>
                  <div class="value" id="pv_instructor_name" x-text="form.instructor_name"></div>
                </div>

                <div class="field">
                  <div class="label">참석인원</div>
                  <div class="value" id="pv_participants_count" x-text="formatCount(form.participants_count)"></div>
                </div>
                <div class="field">
                  <div class="label">(비고)</div>
                  <div class="value" id="pv_notes_inline" x-text="''"></div>
                </div>
              </div>

              <div class="section-title">교육목표</div>
              <div class="block" id="pv_training_goal" x-text="form.training_goal"></div>

              <div class="section-title">교육내용</div>
              <div class="block" id="pv_training_content" x-text="form.training_content"></div>

              <div class="section-title">교육 참석자 명단</div>
              <table class="attendee" aria-label="교육 참석자 명단 표">
                <thead>
                  <tr>
                    <th style="width:12mm;">No</th>
                    <th style="width:40mm;">성명</th>
                    <th style="width:35mm;">사번</th>
                    <th>부서</th>
                    <th style="width:35mm;">서명</th>
                  </tr>
                </thead>
                <tbody id="pv_attendees_tbody">
                  <!-- JS renders rows -->
                </tbody>
              </table>

              <div class="section-title">비고</div>
              <div class="block" id="pv_notes" x-text="form.notes"></div>

              <div class="footer-sign">
                <div class="field" style="grid-template-columns: 20mm 1fr;">
                  <div class="label">작성자</div>
                  <div class="value" id="pv_writer_name" x-text="form.writer_name"></div>
                </div>
                <div class="field" style="grid-template-columns: 20mm 1fr;">
                  <div class="label">작성일</div>
                  <div class="value" id="pv_write_date" x-text="formatDateKor(form.write_date)"></div>
                </div>
                <div class="field" style="grid-template-columns: 28mm 1fr;">
                  <div class="label">확인(승인)</div>
                  <div class="value" id="pv_approver_name" x-text="form.approver_name"></div>
                </div>
              </div>
            </section>
            <!-- PRINT AREA END -->
          </div>
        </div>

        <div class="help-note mt-2 no-print">
          출력 범위: 엑셀 사용범위(A2:V34) 기준. 인쇄 시 A4(세로), 지정 마진이 적용됩니다.
        </div>
      </div>
    </div>
  </div>

  <script>
    // Excel formula helper functions (included per requirement; this app has no formulas)
    function _sum(...args) {
        return args.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
    }

    function _sumRange(rangeData) {
        if (Array.isArray(rangeData)) {
            return rangeData.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
        }
        return parseFloat(rangeData) || 0;
    }

    function _average(...args) {
        const flat = args.flat().filter(x => x !== null && x !== '' && !isNaN(x));
        return flat.length ? _sum(...flat) / flat.length : 0;
    }

    function _averageRange(rangeData) {
        if (Array.isArray(rangeData)) {
            const flat = rangeData.flat().filter(x => x !== null && x !== '' && !isNaN(x));
            return flat.length ? _sumRange(flat) / flat.length : 0;
        }
        return parseFloat(rangeData) || 0;
    }

    function _count(...args) {
        return args.flat().filter(x => typeof x === 'number' && !isNaN(x)).length;
    }

    function _counta(...args) {
        return args.flat().filter(x => x !== null && x !== '' && x !== undefined).length;
    }

    function _and(...args) {
        return args.every(x => Boolean(x));
    }

    function _or(...args) {
        return args.some(x => Boolean(x));
    }

    function _round(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.round(num * factor) / factor;
    }

    function _roundUp(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.ceil(num * factor) / factor;
    }

    function _roundDown(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.floor(num * factor) / factor;
    }

    function _len(text) {
        return String(text).length;
    }

    function _left(text, numChars = 1) {
        return String(text).substring(0, numChars);
    }

    function _right(text, numChars = 1) {
        const str = String(text);
        return str.substring(str.length - numChars);
    }

    function _mid(text, startNum, numChars) {
        return String(text).substring(startNum - 1, startNum - 1 + numChars);
    }

    function _trim(text) {
        return String(text).trim();
    }

    function _upper(text) {
        return String(text).toUpperCase();
    }

    function _lower(text) {
        return String(text).toLowerCase();
    }

    function _concat(...args) {
        return args.join('');
    }

    function formatNumber(num, decimals = 0) {
        return new Intl.NumberFormat('ko-KR', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(num);
    }

    function formatCurrency(num) {
        return new Intl.NumberFormat('ko-KR', {
            style: 'currency',
            currency: 'KRW',
            maximumFractionDigits: 0
        }).format(num);
    }

    function formatPercent(num, decimals = 1) {
        return new Intl.NumberFormat('ko-KR', {
            style: 'percent',
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(num / 100);
    }

    // App
    function appData(){
      const STORAGE_KEY = 'basic_training_log_draft_v1';

      const newRow = () => ({ _id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()), name:'', empId:'', dept:'', sign:'' });

      return {
        STORAGE_KEY,
        ui: {
          errors: [],
          lastSavedAt: '',
          previewScale: 1,
        },
        fieldErrors: {
          training_title: '',
          training_date: '',
          writer_name: '',
          write_date: ''
        },
        form: {
          training_title: '',
          training_date: '',
          training_time: '',
          location: '',
          instructor_name: '',
          department: '',
          participants_count: null,
          training_goal: '',
          training_content: '',
          notes: '',
          writer_name: '',
          write_date: '',
          approver_name: '',
          attendees: [newRow(), newRow(), newRow(), newRow(), newRow(), newRow(), newRow(), newRow(), newRow(), newRow()],
        },

        // --- formatting helpers
        formatDateKor(iso){
          if(!iso) return '';
          // iso expected YYYY-MM-DD
          const [y,m,d] = String(iso).split('-');
          if(!y||!m||!d) return String(iso);
          return `${y}.${m}.${d}`;
        },
        formatCount(n){
          if(n === null || n === undefined || n === '') return '';
          const num = Number(n);
          if(Number.isNaN(num)) return String(n);
          return `${formatNumber(num,0)}명`;
        },

        // --- required functions
        initializeForm(){
          // Defaults
          const today = new Date();
          const pad = (v)=> String(v).padStart(2,'0');
          const todayIso = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
          if(!this.form.write_date) this.form.write_date = todayIso;

          // Auto restore draft (silent)
          this.loadDraft(false);

          // First render
          this.renderPrintPreview();

          // Watch for changes -> rerender & autosave (debounced)
          let t;
          this.$watch('form', () => {
            clearTimeout(t);
            t = setTimeout(() => {
              this.renderPrintPreview();
              this.saveDraft(true); // silent autosave
            }, 250);
          }, { deep: true });

          // Fit preview scale on screen
          this.$nextTick(() => this.updatePreviewScale());
          window.addEventListener('resize', () => this.updatePreviewScale());
        },

        validateForm(){
          const errs = [];
          this.fieldErrors.training_title = '';
          this.fieldErrors.training_date = '';
          this.fieldErrors.writer_name = '';
          this.fieldErrors.write_date = '';

          const req = (key, label) => {
            const val = (this.form[key] ?? '').toString().trim();
            if(!val){
              errs.push(`${label}은(는) 필수 항목입니다.`);
              this.fieldErrors[key] = `${label}을(를) 입력하세요.`;
            }
          };

          req('training_title','교육명');
          req('training_date','교육일자');
          req('writer_name','작성자');
          req('write_date','작성일');

          const isIsoDate = (s) => /^\d{4}-\d{2}-\d{2}$/.test(String(s||''));
          if(this.form.training_date && !isIsoDate(this.form.training_date)){
            errs.push('교육일자 형식이 올바르지 않습니다.');
            this.fieldErrors.training_date = '날짜 형식을 확인하세요.';
          }
          if(this.form.write_date && !isIsoDate(this.form.write_date)){
            errs.push('작성일 형식이 올바르지 않습니다.');
            this.fieldErrors.write_date = '날짜 형식을 확인하세요.';
          }

          if(this.form.participants_count !== null && this.form.participants_count !== '' && this.form.participants_count !== undefined){
            const n = Number(this.form.participants_count);
            if(Number.isNaN(n) || n < 0 || !Number.isInteger(n)){
              errs.push('참석인원은 0 이상의 정수로 입력하세요.');
            }
          }

          this.ui.errors = errs;
          return errs;
        },

        renderPrintPreview(){
          // Rebuild attendee tbody to ensure print stability and fixed rows
          const tbody = document.getElementById('pv_attendees_tbody');
          if(!tbody) return;
          tbody.innerHTML = '';

          const rows = Array.isArray(this.form.attendees) ? this.form.attendees : [];
          // Excel range A22:V31 implies 10 rows; force 10 for print
          const PRINT_ROWS = 10;
          for(let i=0; i<PRINT_ROWS; i++){
            const r = rows[i] || {name:'', empId:'', dept:'', sign:''};
            const tr = document.createElement('tr');

            const tdNo = document.createElement('td');
            tdNo.textContent = String(i+1);
            tdNo.style.textAlign = 'center';

            const tdName = document.createElement('td');
            tdName.textContent = r.name || '';

            const tdId = document.createElement('td');
            tdId.textContent = r.empId || '';

            const tdDept = document.createElement('td');
            tdDept.textContent = r.dept || '';

            const tdSign = document.createElement('td');
            tdSign.textContent = r.sign || '';
            tdSign.className = 'sign-box';

            tr.appendChild(tdNo);
            tr.appendChild(tdName);
            tr.appendChild(tdId);
            tr.appendChild(tdDept);
            tr.appendChild(tdSign);
            tbody.appendChild(tr);
          }
        },

        exportToPDF(){
          const errs = this.validateForm();
          if(errs.length){
            // focus first invalid if possible
            const firstKey = Object.keys(this.fieldErrors).find(k => this.fieldErrors[k]);
            if(firstKey){
              const el = document.getElementById(firstKey);
              if(el) el.focus();
            }
            return;
          }
          this.renderPrintPreview();

          // Set document title for print/PDF
          const name = (this.form.training_title || '교육일지').replace(/[\\/:*?"<>|]/g,'_').slice(0,40);
          const date = this.form.training_date || '';
          const originalTitle = document.title;
          document.title = `교육일지_${name}${date ? '_' + date : ''}`;

          // Print
          setTimeout(() => {
            window.print();
            // Restore
            document.title = originalTitle;
          }, 50);
        },

        saveDraft(silent=false){
          try{
            const payload = {
              savedAt: new Date().toISOString(),
              form: this.form
            };
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(payload));
            this.ui.lastSavedAt = new Date().toLocaleString('ko-KR');
            if(!silent) this.ui.errors = [];
          }catch(e){
            if(!silent) this.ui.errors = ['임시저장에 실패했습니다. (브라우저 저장공간/권한을 확인하세요)'];
          }
        },

        loadDraft(withConfirm=true){
          try{
            const raw = localStorage.getItem(this.STORAGE_KEY);
            if(!raw) return;
            if(withConfirm && !confirm('임시저장 데이터를 불러올까요? 현재 입력 내용은 덮어쓰기 됩니다.')) return;

            const parsed = JSON.parse(raw);
            if(parsed && parsed.form){
              // Merge to keep new structure defaults
              const incoming = parsed.form;
              this.form = {
                ...this.form,
                ...incoming,
                attendees: Array.isArray(incoming.attendees) && incoming.attendees.length
                  ? incoming.attendees.map(r => ({ _id: r._id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())), name: r.name||'', empId: r.empId||'', dept: r.dept||'', sign: r.sign||'' }))
                  : this.form.attendees
              };
              this.ui.lastSavedAt = parsed.savedAt ? new Date(parsed.savedAt).toLocaleString('ko-KR') : this.ui.lastSavedAt;
              this.ui.errors = [];
              this.$nextTick(() => this.renderPrintPreview());
            }
          }catch(e){
            this.ui.errors = ['임시저장 데이터를 불러오지 못했습니다.'];
          }
        },

        clearDraft(){
          localStorage.removeItem(this.STORAGE_KEY);
          this.ui.lastSavedAt = '';
        },

        // --- UI actions
        onRefreshPreview(){
          this.ui.errors = [];
          this.renderPrintPreview();
          this.updatePreviewScale();
        },

        onReset(){
          if(!confirm('입력 내용을 초기화할까요? (임시저장 데이터는 유지)')) return;
          const today = new Date();
          const pad = (v)=> String(v).padStart(2,'0');
          const todayIso = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;

          const keep = { write_date: todayIso };
          this.form = {
            training_title: '',
            training_date: '',
            training_time: '',
            location: '',
            instructor_name: '',
            department: '',
            participants_count: null,
            training_goal: '',
            training_content: '',
            notes: '',
            writer_name: '',
            write_date: keep.write_date,
            approver_name: '',
            attendees: [
              { _id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())), name:'', empId:'', dept:'', sign:'' },
              { _id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())), name:'', empId:'', dept:'', sign:'' },
              { _id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())), name:'', empId:'', dept:'', sign:'' },
              { _id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())), name:'', empId:'', dept:'', sign:'' },
              { _id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())), name:'', empId:'', dept:'', sign:'' },
              { _id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())), name:'', empId:'', dept:'', sign:'' },
              { _id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())), name:'', empId:'', dept:'', sign:'' },
              { _id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())), name:'', empId:'', dept:'', sign:'' },
              { _id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())), name:'', empId:'', dept:'', sign:'' },
              { _id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())), name:'', empId:'', dept:'', sign:'' },
            ]
          };

          this.ui.errors = [];
          this.$nextTick(() => this.renderPrintPreview());
        },

        addAttendee(){
          this.form.attendees.push({ _id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())), name:'', empId:'', dept:'', sign:'' });
        },

        removeAttendee(idx){
          if(this.form.attendees.length <= 1) return;
          this.form.attendees.splice(idx, 1);
        },

        fillAttendeesTo10(){
          const PRINT_ROWS = 10;
          const cur = this.form.attendees.length;
          if(cur < PRINT_ROWS){
            for(let i=0;i<PRINT_ROWS-cur;i++) this.addAttendee();
          }else if(cur > PRINT_ROWS){
            if(!confirm('10행을 초과하는 참석자 행을 잘라낼까요? (인쇄 영역은 10행 기준입니다)')) return;
            this.form.attendees = this.form.attendees.slice(0, PRINT_ROWS);
          }
        },

        updatePreviewScale(){
          // Scale the A4 preview to fit column width on screen
          const shell = document.querySelector('.preview-shell');
          const area = document.getElementById('printArea');
          if(!shell || !area) return;

          // Available width inside shell
          const shellWidth = shell.clientWidth - 16; // padding buffer

          // area width in px
          const areaWidth = area.getBoundingClientRect().width;
          if(areaWidth <= 0) return;

          let scale = shellWidth / areaWidth;
          // Limit scale
          scale = Math.min(1, Math.max(0.5, scale));
          this.ui.previewScale = scale;
        },

        screenPreviewStyle(){
          return `transform: scale(${this.ui.previewScale});`;
        }
      };
    }
  </script>
</body>
</html>
