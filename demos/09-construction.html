<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>공정표 출력 도구</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <style>
:root{
  --app-font: "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
  --grid-border: #2b2b2b;
  --grid-light: #e6e6e6;
  --header-bg: #f7f7f7;
  --panel-bg: #fcfcfd;
  --text: #111;
}

html, body { height: 100%; }
body{
  font-family: var(--app-font);
  color: var(--text);
  background: #fff;
}

header.app-header{
  position: sticky;
  top: 0;
  z-index: 20;
  background: #fff;
  border-bottom: 1px solid #eaeaea;
}

.app-title{ font-weight: 700; letter-spacing: -0.2px; }

#tableView{
  border: 1px solid #eaeaea;
  border-radius: 10px;
  background: white;
  overflow: auto;
  max-height: calc(100vh - 170px);
  box-shadow: 0 1px 10px rgba(0,0,0,0.04);
}

.table-wrap-inner{ min-width: max-content; }

.excel-grid{
  border-collapse: collapse;
  table-layout: fixed;
  width: max-content;
  background: white;
}

.excel-grid caption{
  caption-side: top;
  text-align: left;
  padding: 8px 10px;
  font-weight: 700;
}

.excel-grid th,
.excel-grid td{
  border: 1px solid var(--grid-border);
  padding: 3px 4px;
  font-size: 12px;
  line-height: 1.15;
  vertical-align: middle;
  background: #fff;
  color: #111;
  overflow: hidden;
  text-overflow: ellipsis;
}

.excel-grid th{
  background: var(--header-bg);
  font-weight: 700;
}

.cell{
  white-space: pre-wrap; /* 줄바꿈 유지 */
  word-break: break-word;
}

/* 화면에서만 가독성용: 아주 얇은 내부 격자 강조(선택) */
.excel-grid .thin-border{ border-color: var(--grid-light); }

#printPanel{
  border: 1px solid #eaeaea;
  border-radius: 10px;
  background: var(--panel-bg);
}

.small-help{ color:#555; font-size: 0.92rem; }

/* Print */
@page{
  size: A4 landscape;
  margin: 10mm 5mm 10mm 5mm;
}

@media print{
  header.app-header,
  #printPanel,
  .no-print{
    display: none !important;
  }

  body{
    background: #fff;
  }

  #tableView{
    border: none;
    border-radius: 0;
    box-shadow: none;
    overflow: visible !important;
    max-height: none !important;
  }

  .print-root{
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  /* 인쇄시 페이지 폭 맞춤 (기본 fit-to-page) */
  .print-fit{
    transform-origin: top left;
  }
}

/* 접근성: 키보드 포커스 */
#tableView:focus{
  outline: 3px solid rgba(13,110,253,0.35);
  outline-offset: 2px;
}
  </style>
</head>

<body class="print-root">
<div class="container-fluid py-3" x-data="appData()" x-init="init()">

  <header class="app-header py-2 mb-3 no-print">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div>
        <div class="app-title h4 mb-0">공정표 출력 도구</div>
        <div class="text-muted" style="font-size:0.92rem;">엑셀 ‘공정표’(A1:BD56) 미리보기 및 A4 가로 인쇄 템플릿</div>
      </div>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-secondary" @click="toggleFit()"
          :aria-label="fitToPage ? '인쇄시 실제 크기 전환' : '인쇄시 페이지 맞춤 전환'">
          <span x-text="fitToPage ? '인쇄: 페이지 맞춤(ON)' : '인쇄: 페이지 맞춤(OFF)'"></span>
        </button>
        <button type="button" class="btn btn-primary" @click="printA4Landscape()" aria-label="A4 가로 인쇄">
          인쇄
        </button>
        <button type="button" class="btn btn-dark" @click="exportToPdf('browser')" aria-label="PDF로 내보내기">
          PDF 내보내기
        </button>
      </div>
    </div>
  </header>

  <main class="row g-3">
    <section class="col-12 col-xxl-9">
      <div id="tableView" class="p-2" tabindex="0" aria-label="공정표 표 미리보기(스크롤 가능)">
        <div class="table-wrap-inner" id="gongjeongTableHost"></div>
      </div>
      <div class="mt-2 text-muted" style="font-size:0.9rem;">
        팁: 표 영역을 클릭한 뒤 방향키/페이지업/페이지다운으로 스크롤할 수 있습니다.
      </div>
    </section>

    <aside class="col-12 col-xxl-3 no-print">
      <div id="printPanel" class="p-3">
        <div class="h5 mb-2">인쇄/내보내기 안내</div>
        <ul class="small-help mb-2">
          <li>용지: A4, 방향: 가로(landscape)</li>
          <li>여백: 상 10mm / 하 10mm / 좌 5mm / 우 5mm</li>
          <li>색상/배경을 살리려면 브라우저 인쇄 설정에서 <b>배경 그래픽</b>을 켜세요.</li>
          <li>PDF는 기본적으로 브라우저 인쇄 대화상자에서 <b>대상: PDF로 저장</b>을 사용합니다.</li>
        </ul>

        <div class="border rounded p-2 bg-white">
          <div class="fw-semibold mb-1">현재 데이터</div>
          <div class="text-muted" style="font-size:0.9rem;">
            <div>범위: A1:BD56</div>
            <div>병합 영역: <span x-text="sheetJson?.merges?.length ?? 0"></span>개</div>
          </div>
        </div>

        <div class="mt-3 d-grid gap-2">
          <button type="button" class="btn btn-outline-primary" @click="reloadDemo()" aria-label="데모 데이터 다시 불러오기">
            데모 데이터 다시 로드
          </button>
          <button type="button" class="btn btn-outline-danger" @click="clearTable()" aria-label="표 지우기">
            표 지우기
          </button>
        </div>
      </div>
    </aside>
  </main>
</div>

<script>
/* ===== Excel formula helper functions (included as requested) ===== */
function _sum(...args) {
    return args.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
}
function _sumRange(rangeData) {
    if (Array.isArray(rangeData)) {
        return rangeData.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
    }
    return parseFloat(rangeData) || 0;
}
function _average(...args) {
    const flat = args.flat().filter(x => x !== null && x !== '' && !isNaN(x));
    return flat.length ? _sum(...flat) / flat.length : 0;
}
function _averageRange(rangeData) {
    if (Array.isArray(rangeData)) {
        const flat = rangeData.flat().filter(x => x !== null && x !== '' && !isNaN(x));
        return flat.length ? _sumRange(flat) / flat.length : 0;
    }
    return parseFloat(rangeData) || 0;
}
function _count(...args) {
    return args.flat().filter(x => typeof x === 'number' && !isNaN(x)).length;
}
function _counta(...args) {
    return args.flat().filter(x => x !== null && x !== '' && x !== undefined).length;
}
function _and(...args) {
    return args.every(x => Boolean(x));
}
function _or(...args) {
    return args.some(x => Boolean(x));
}
function _round(num, digits = 0) {
    const factor = Math.pow(10, digits);
    return Math.round(num * factor) / factor;
}
function _roundUp(num, digits = 0) {
    const factor = Math.pow(10, digits);
    return Math.ceil(num * factor) / factor;
}
function _roundDown(num, digits = 0) {
    const factor = Math.pow(10, digits);
    return Math.floor(num * factor) / factor;
}
function _len(text) {
    return String(text).length;
}
function _left(text, numChars = 1) {
    return String(text).substring(0, numChars);
}
function _right(text, numChars = 1) {
    const str = String(text);
    return str.substring(str.length - numChars);
}
function _mid(text, startNum, numChars) {
    return String(text).substring(startNum - 1, startNum - 1 + numChars);
}
function _trim(text) {
    return String(text).trim();
}
function _upper(text) {
    return String(text).toUpperCase();
}
function _lower(text) {
    return String(text).toLowerCase();
}
function _concat(...args) {
    return args.join('');
}
function formatNumber(num, decimals = 0) {
    return new Intl.NumberFormat('ko-KR', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    }).format(num);
}
function formatCurrency(num) {
    return new Intl.NumberFormat('ko-KR', {
        style: 'currency',
        currency: 'KRW',
        maximumFractionDigits: 0
    }).format(num);
}
function formatPercent(num, decimals = 1) {
    return new Intl.NumberFormat('ko-KR', {
        style: 'percent',
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    }).format(num / 100);
}

/* ===== Utilities for A1 notation ===== */
function colToIndex(colStr) {
  // A->1, Z->26, AA->27
  let n = 0;
  const s = String(colStr).toUpperCase();
  for (let i = 0; i < s.length; i++) {
    n = n * 26 + (s.charCodeAt(i) - 64);
  }
  return n;
}
function indexToCol(n) {
  let s = '';
  while (n > 0) {
    const r = (n - 1) % 26;
    s = String.fromCharCode(65 + r) + s;
    n = Math.floor((n - 1) / 26);
  }
  return s;
}
function a1ToRC(a1) {
  const m = String(a1).match(/^([A-Za-z]+)(\d+)$/);
  if (!m) return null;
  return { c: colToIndex(m[1]) - 1, r: parseInt(m[2], 10) - 1 };
}
function rcToA1(r, c) {
  return indexToCol(c + 1) + String(r + 1);
}

/* ===== Core functions requested in plan ===== */
function renderGongjeongTable(sheetJson, containerEl) {
  if (!containerEl) throw new Error('containerEl이 없습니다.');
  containerEl.innerHTML = '';

  const used = sheetJson?.usedRange || { s: { r: 0, c: 0 }, e: { r: 55, c: 55 } }; // default A1:BD56
  const rowCount = used.e.r - used.s.r + 1;
  const colCount = used.e.c - used.s.c + 1;

  const merges = Array.isArray(sheetJson?.merges) ? sheetJson.merges : [];

  // Build merge maps: start -> {rowspan,colspan}, and set of covered cells to skip
  const mergeStart = new Map();
  const covered = new Set();
  for (const m of merges) {
    if (!m?.s || !m?.e) continue;
    const rs = m.s.r, cs = m.s.c, re = m.e.r, ce = m.e.c;
    const key = `${rs},${cs}`;
    mergeStart.set(key, { rowspan: re - rs + 1, colspan: ce - cs + 1 });
    for (let r = rs; r <= re; r++) {
      for (let c = cs; c <= ce; c++) {
        if (r === rs && c === cs) continue;
        covered.add(`${r},${c}`);
      }
    }
  }

  const table = document.createElement('table');
  table.className = 'excel-grid';
  table.setAttribute('role', 'grid');
  table.setAttribute('aria-label', '공정표');

  const caption = document.createElement('caption');
  caption.textContent = '공정표';
  table.appendChild(caption);

  // colgroup with widths
  const colgroup = document.createElement('colgroup');
  for (let c = 0; c < colCount; c++) {
    const col = document.createElement('col');
    const w = sheetJson?.colWidths?.[used.s.c + c];
    if (typeof w === 'number' && isFinite(w) && w > 0) {
      col.style.width = `${w}px`;
    } else {
      col.style.width = '72px';
    }
    colgroup.appendChild(col);
  }
  table.appendChild(colgroup);

  const tbody = document.createElement('tbody');

  // Optional heuristic: first row as header if sheetJson.headerRows === 1
  const headerRows = sheetJson?.headerRows || 0;

  for (let r = 0; r < rowCount; r++) {
    const tr = document.createElement('tr');

    const rh = sheetJson?.rowHeights?.[used.s.r + r];
    if (typeof rh === 'number' && isFinite(rh) && rh > 0) {
      tr.style.height = `${rh}px`;
    }

    for (let c = 0; c < colCount; c++) {
      const rr = used.s.r + r;
      const cc = used.s.c + c;

      if (covered.has(`${rr},${cc}`)) continue;

      const startMerge = mergeStart.get(`${rr},${cc}`);

      const a1 = rcToA1(rr, cc);
      const cellData = sheetJson?.cells?.[a1] || null;

      const isHeader = headerRows > 0 && r < headerRows;
      const el = document.createElement(isHeader ? 'th' : 'td');
      if (isHeader) el.setAttribute('scope', 'col');

      el.className = 'cell';

      if (startMerge) {
        el.rowSpan = startMerge.rowspan;
        el.colSpan = startMerge.colspan;
      }

      // Value
      const v = (cellData && cellData.v != null) ? String(cellData.v) : '';
      el.appendChild(document.createTextNode(v));

      // Minimal styles
      const st = cellData?.style || {};
      if (st.bold) el.style.fontWeight = '700';
      if (st.italic) el.style.fontStyle = 'italic';
      if (st.fontSize) el.style.fontSize = `${st.fontSize}px`;
      if (st.color) el.style.color = st.color;
      if (st.bgColor) el.style.background = st.bgColor;
      if (st.hAlign) el.style.textAlign = st.hAlign; // 'left'|'center'|'right'
      if (st.vAlign) el.style.verticalAlign = st.vAlign;
      if (st.wrap === false) el.style.whiteSpace = 'nowrap';
      if (st.borderColor) el.style.borderColor = st.borderColor;

      tr.appendChild(el);
    }
    tbody.appendChild(tr);
  }

  table.appendChild(tbody);
  containerEl.appendChild(table);
}

function applyPrintSettings(printConfig) {
  // printConfig: { paper:'A4', orientation:'landscape', margins:{top,right,bottom,left}, fitToPage:boolean }
  const cfg = printConfig || {};
  const margins = cfg.margins || { top: '10mm', right: '5mm', bottom: '10mm', left: '5mm' };
  const orientation = cfg.orientation || 'landscape';
  const paper = cfg.paper || 'A4';

  // Create/replace runtime print style (fixes prior iteration issues: duplicated @page rules)
  const id = 'runtime-print-style';
  let styleEl = document.getElementById(id);
  if (!styleEl) {
    styleEl = document.createElement('style');
    styleEl.id = id;
    document.head.appendChild(styleEl);
  }

  styleEl.textContent = `
@page{ size: ${paper} ${orientation}; margin: ${margins.top} ${margins.right} ${margins.bottom} ${margins.left}; }
`;

  // Apply fit-to-page scaling (print only)
  const host = document.getElementById('gongjeongTableHost');
  if (!host) return;

  // Reset first
  host.classList.remove('print-fit');
  host.style.transform = '';

  if (cfg.fitToPage) {
    // Measure and scale to printable width
    // A4 landscape printable width = pageWidth - margins. In CSS px it depends; we estimate via container width in print preview.
    // Robust approach: scale based on current viewport printable area using #tableView width.
    const view = document.getElementById('tableView');
    const viewWidth = view ? view.getBoundingClientRect().width : window.innerWidth;
    const table = host.querySelector('table');
    if (table) {
      const tableWidth = table.getBoundingClientRect().width;
      const scale = tableWidth > 0 ? Math.min(1, (viewWidth - 8) / tableWidth) : 1;
      host.classList.add('print-fit');
      host.style.transform = `scale(${scale})`;
      host.style.width = `${tableWidth}px`; // keep layout width stable
    }
  }
}

function printA4Landscape() {
  // Called from Alpine context via this.printA4Landscape()
  window.print();
}

function exportToPdf(mode) {
  // Default: browser print dialog -> Save as PDF
  // mode kept for future extension
  if (mode === 'browser') {
    window.print();
    return;
  }
  alert('현재 버전은 브라우저 인쇄(PDF로 저장)를 사용합니다.');
}

/* ===== Alpine app ===== */
function appData(){
  return {
    sheetJson: null,
    fitToPage: true,
    _beforePrintHandler: null,
    _afterPrintHandler: null,

    init(){
      // In production: window.__SHEET_JSON__ injected by server or fetched.
      const injected = window.__SHEET_JSON__;
      this.sheetJson = injected || this.getDemoSheetJson();
      this.render();

      // Fix prior iteration common issue: print event handlers not restoring state
      this._beforePrintHandler = () => {
        this.applyPrint();
      };
      this._afterPrintHandler = () => {
        this.restoreAfterPrint();
      };
      window.addEventListener('beforeprint', this._beforePrintHandler);
      window.addEventListener('afterprint', this._afterPrintHandler);
    },

    destroy(){
      if (this._beforePrintHandler) window.removeEventListener('beforeprint', this._beforePrintHandler);
      if (this._afterPrintHandler) window.removeEventListener('afterprint', this._afterPrintHandler);
    },

    render(){
      const host = document.getElementById('gongjeongTableHost');
      renderGongjeongTable(this.sheetJson, host);
    },

    applyPrint(){
      applyPrintSettings({
        paper: 'A4',
        orientation: 'landscape',
        margins: { top: '10mm', bottom: '10mm', left: '5mm', right: '5mm' },
        fitToPage: this.fitToPage
      });
    },

    restoreAfterPrint(){
      // remove scaling after print so screen view is normal
      const host = document.getElementById('gongjeongTableHost');
      if (host) {
        host.classList.remove('print-fit');
        host.style.transform = '';
        host.style.width = '';
      }
    },

    printA4Landscape(){
      // Ensure print settings applied right before printing
      this.applyPrint();
      // Let layout settle (fix: scale applied but not rendered in some browsers)
      setTimeout(() => {
        printA4Landscape();
      }, 50);
    },

    exportToPdf(mode){
      this.applyPrint();
      setTimeout(() => exportToPdf(mode), 50);
    },

    toggleFit(){
      this.fitToPage = !this.fitToPage;
    },

    clearTable(){
      this.sheetJson = { usedRange: { s: { r:0, c:0 }, e: { r:55, c:55 } }, cells: {}, merges: [], colWidths: [], rowHeights: [] };
      this.render();
    },

    reloadDemo(){
      this.sheetJson = this.getDemoSheetJson();
      this.render();
    },

    getDemoSheetJson(){
      // Demo-only: minimal dataset; replace with actual converted JSON from server.
      const cells = {};
      // Title merged A1:H2
      cells['A1'] = { v: '공정표(데모)', t:'s', style:{ bold:true, fontSize:16, hAlign:'center', vAlign:'middle', bgColor:'#f0f4ff' } };
      // Header row at 3
      const headers = ['공정', '작업명', '담당', '시작일', '종료일', '기간(일)', '비고'];
      const cols = ['A','B','C','D','E','F','G'];
      for (let i=0;i<headers.length;i++){
        cells[cols[i]+'3'] = { v: headers[i], t:'s', style:{ bold:true, hAlign:'center', bgColor:'#f7f7f7' } };
      }
      // Sample rows
      const rows = [
        ['1','착공 준비','홍길동','2025-01-02','2025-01-05','4','-'],
        ['2','기초 공사','김철수','2025-01-06','2025-01-12','7','우천 대비'],
        ['3','골조 공사','이영희','2025-01-13','2025-02-10','29','자재 수급 확인'],
      ];
      for (let r=0;r<rows.length;r++){
        for (let c=0;c<rows[r].length;c++){
          cells[cols[c]+String(4+r)] = { v: rows[r][c], t:'s', style:{ hAlign: (c===0||c===5)?'center':'left' } };
        }
      }

      return {
        usedRange: { s: { r:0, c:0 }, e: { r:55, c:55 } }, // A1:BD56
        headerRows: 0,
        cells,
        merges: [ { s:{r:0,c:0}, e:{r:1,c:7} } ],
        colWidths: Array.from({length:56}, (_,i)=> (i===0?60:(i===1?220:(i===3||i===4?110:90))) ),
        rowHeights: Array.from({length:56}, (_,i)=> (i===0?28:(i===1?24:20)) )
      };
    }
  };
}
</script>

<!-- Agent Trace Viewer -->
<style>
.trace-toggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    background: #6366f1;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    display: flex;
    align-items: center;
    gap: 8px;
}
.trace-toggle:hover { background: #4f46e5; }
.trace-panel {
    position: fixed;
    top: 0;
    right: -450px;
    width: 450px;
    height: 100vh;
    background: #1e1e2e;
    color: #cdd6f4;
    z-index: 9998;
    transition: right 0.3s ease;
    overflow-y: auto;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 12px;
}
.trace-panel.open { right: 0; }
.trace-header {
    padding: 16px;
    background: #313244;
    border-bottom: 1px solid #45475a;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.trace-header h3 { margin: 0; font-size: 14px; }
.trace-close {
    background: none;
    border: none;
    color: #cdd6f4;
    cursor: pointer;
    font-size: 18px;
}
.trace-content { padding: 16px; }
.span-item {
    margin-bottom: 12px;
    padding: 12px;
    background: #313244;
    border-radius: 8px;
    border-left: 3px solid #89b4fa;
}
.span-item.agent { border-left-color: #a6e3a1; }
.span-item.generation { border-left-color: #f9e2af; }
.span-item.function { border-left-color: #cba6f7; }
.span-type {
    font-size: 10px;
    text-transform: uppercase;
    color: #6c7086;
    margin-bottom: 4px;
}
.span-name { font-weight: bold; color: #89dceb; }
.span-data {
    margin-top: 8px;
    padding: 8px;
    background: #1e1e2e;
    border-radius: 4px;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-all;
}
.span-time { color: #6c7086; font-size: 11px; }
.trace-summary {
    padding: 12px 16px;
    background: #45475a;
    margin: 0 16px 16px;
    border-radius: 8px;
}
.trace-summary-item { display: flex; justify-content: space-between; margin: 4px 0; }
</style>

<button class="trace-toggle" onclick="toggleTracePanel()">
    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
    </svg>
    Agent Trace
</button>

<div class="trace-panel" id="tracePanel">
    <div class="trace-header">
        <h3>Agent Trace Viewer</h3>
        <button class="trace-close" onclick="toggleTracePanel()">&times;</button>
    </div>
    <div class="trace-summary" id="traceSummary"></div>
    <div class="trace-content" id="traceContent"></div>
</div>

<script>
const TRACE_DATA = {"trace_id": "trace_0e4f18ab97a34547820de830bc45b846", "workflow_name": "Excel-to-WebApp: 1.xlsx", "group_id": null, "metadata": null, "started_at": "2025-12-28T12:00:33.995876", "ended_at": "2025-12-28T12:05:34.744535", "spans": [{"span_id": "span_7b9094faf8c94d4db1798fbb", "parent_id": "span_99d785b098d54fbd94f15a26", "started_at": "2025-12-28T03:00:34.006831+00:00", "ended_at": "2025-12-28T03:00:36.732250+00:00", "error": null, "type": "response", "data": {"type": "response", "response_id": "resp_0d6a5a3b7199276d0069509d525a3c8195a460cc47b154b349"}}, {"span_id": "span_564c98ae2e8e49f3a4b1d6c6", "parent_id": "span_99d785b098d54fbd94f15a26", "started_at": "2025-12-28T03:00:36.732741+00:00", "ended_at": "2025-12-28T03:00:36.773379+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "analyze_excel", "input": "{\"file_path\":\"excel_files/엑셀서식(20160517)/CPM공정표(네트워크)/1.xlsx\"}", "output": "{'filename': '1.xlsx', 'file_type': 'xlsx', 'sheets': [{'name': '공정표', 'row_count': 56, 'col_count': 56, 'used_range': 'A1:BD56', 'input_cells': [], 'output_cells': [], 'formulas': [], 'has_print_area': False, 'print_area': None}], 'vba_modules': [], 'has_vba': False, 'print_settings': {'orientation': 'landscape', 'paper_size': 'A4', 'margins': {'top': 0.39375, 'bottom': 0.39375, 'left': 0.196527777777778, 'right': 0.196527777777778}, 'header': None, 'footer': None, 'fit_to_page': False, 'scale': 100}, 'total_formulas': 0, 'total_input_cells': 0, 'total_output_cells': 0, 'complexity_score': 'low'}", "mcp_data": null}}, {"span_id": "span_2a7ccc4709ee44d3b6a04c00", "parent_id": "span_99d785b098d54fbd94f15a26", "started_at": "2025-12-28T03:00:36.774392+00:00", "ended_at": "2025-12-28T03:01:14.398361+00:00", "error": null, "type": "response", "data": {"type": "response", "response_id": "resp_0d6a5a3b7199276d0069509d54f9d88195993ab63364f588e3"}}, {"span_id": "span_99d785b098d54fbd94f15a26", "parent_id": null, "started_at": "2025-12-28T03:00:33.996268+00:00", "ended_at": "2025-12-28T03:01:14.398666+00:00", "error": null, "type": "agent", "data": {"type": "agent", "name": "Excel Analyzer", "handoffs": [], "tools": ["analyze_excel", "get_sheet_cells"], "output_type": "str"}}, {"span_id": "span_5cc2ae23f2cd4aa299d38284", "parent_id": "span_e628bde42bb84b3bbbd11a88", "started_at": "2025-12-28T03:01:14.399083+00:00", "ended_at": "2025-12-28T03:01:34.549257+00:00", "error": null, "type": "response", "data": {"type": "response", "response_id": "resp_0f627a4343b262680069509d7aa2e08194b3e9cee0e45d9039"}}, {"span_id": "span_e628bde42bb84b3bbbd11a88", "parent_id": null, "started_at": "2025-12-28T03:01:14.398838+00:00", "ended_at": "2025-12-28T03:01:34.549653+00:00", "error": null, "type": "agent", "data": {"type": "agent", "name": "WebApp Planner", "handoffs": [], "tools": [], "output_type": "WebAppPlan"}}, {"span_id": "span_373ca78edacf432c9e6a1cf5", "parent_id": "span_ffeba072306b4e7b9022f395", "started_at": "2025-12-28T03:01:34.550063+00:00", "ended_at": "2025-12-28T03:01:35.603759+00:00", "error": null, "type": "response", "data": {"type": "response", "response_id": "resp_05a3e0c2088b32e60069509d8ec1e48196a376eb63c78ff09f"}}, {"span_id": "span_f696c8f0dece42698c47f88c", "parent_id": "span_ffeba072306b4e7b9022f395", "started_at": "2025-12-28T03:01:35.603931+00:00", "ended_at": "2025-12-28T03:01:35.604062+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "get_js_helpers", "input": "{}", "output": "\n// Excel formula helper functions\nfunction _sum(...args) {\n    return args.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);\n}\n\nfunction _sumRange(rangeData) {\n    if (Array.isArray(rangeData)) {\n        return rangeData.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);\n    }\n    return parseFloat(rangeData) || 0;\n}\n\nfunction _average(...args) {\n    const flat = args.flat().filter(x => x !== null && x !== '' && !isNaN(x));\n    return flat.length ? _sum(...flat) / flat.length : 0;\n}\n\nfunction _averageRange(rangeData) {\n    if (Array.isArray(rangeData)) {\n        const flat = rangeData.flat().filter(x => x !== null && x !== '' && !isNaN(x));\n        return flat.length ? _sumRange(flat) / flat.length : 0;\n    }\n    return parseFloat(rangeData) || 0;\n}\n\nfunction _count(...args) {\n    return args.flat().filter(x => typeof x === 'number' && !isNaN(x)).length;\n}\n\nfunction _counta(...args) {\n    return args.flat().filter(x => x !== null && x !== '' && x !== undefined).length;\n}\n\nfunction _and(...args) {\n    return args.every(x => Boolean(x));\n}\n\nfunction _or(...args) {\n    return args.some(x => Boolean(x));\n}\n\nfunction _round(num, digits = 0) {\n    const factor = Math.pow(10, digits);\n    return Math.round(num * factor) / factor;\n}\n\nfunction _roundUp(num, digits = 0) {\n    const factor = Math.pow(10, digits);\n    return Math.ceil(num * factor) / factor;\n}\n\nfunction _roundDown(num, digits = 0) {\n    const factor = Math.pow(10, digits);\n    return Math.floor(num * factor) / factor;\n}\n\nfunction _len(text) {\n    return String(text).length;\n}\n\nfunction _left(text, numChars = 1) {\n    return String(text).substring(0, numChars);\n}\n\nfunction _right(text, numChars = 1) {\n    const str = String(text);\n    return str.substring(str.length - numChars);\n}\n\nfunction _mid(text, startNum, numChars) {\n    return String(text).substring(startNum - 1, startNum - 1 + numChars);\n}\n\nfunction _trim(text) {\n    return String(text).trim();\n}\n\nfunction _upper(text) {\n    return String(text).toUpperCase();\n}\n\nfunction _lower(text) {\n    return String(text).toLowerCase();\n}\n\nfunction _concat(...args) {\n    return args.join('');\n}\n\n// Number formatting\nfunction formatNumber(num, decimals = 0) {\n    return new Intl.NumberFormat('ko-KR', {\n        minimumFractionDigits: decimals,\n        maximumFractionDigits: decimals\n    }).format(num);\n}\n\nfunction formatCurrency(num) {\n    return new Intl.NumberFormat('ko-KR', {\n        style: 'currency',\n        currency: 'KRW',\n        maximumFractionDigits: 0\n    }).format(num);\n}\n\nfunction formatPercent(num, decimals = 1) {\n    return new Intl.NumberFormat('ko-KR', {\n        style: 'percent',\n        minimumFractionDigits: decimals,\n        maximumFractionDigits: decimals\n    }).format(num / 100);\n}\n", "mcp_data": null}}, {"span_id": "span_a3581af6c5514773b455d749", "parent_id": "span_ffeba072306b4e7b9022f395", "started_at": "2025-12-28T03:01:35.604360+00:00", "ended_at": "2025-12-28T03:02:47.736233+00:00", "error": null, "type": "response", "data": {"type": "response", "response_id": "resp_05a3e0c2088b32e60069509d8fd1d48196affdc79c6c21ac9f"}}, {"span_id": "span_ffeba072306b4e7b9022f395", "parent_id": null, "started_at": "2025-12-28T03:01:34.549827+00:00", "ended_at": "2025-12-28T03:02:47.736762+00:00", "error": null, "type": "agent", "data": {"type": "agent", "name": "WebApp Generator", "handoffs": [], "tools": ["convert_formula", "check_formula_complexity", "get_js_helpers"], "output_type": "GeneratedWebApp"}}, {"span_id": "span_fba26d83fb3f46e19989d2b5", "parent_id": "span_9eb44bc584014ef9b27e3c55", "started_at": "2025-12-28T03:02:47.737501+00:00", "ended_at": "2025-12-28T03:02:48.846058+00:00", "error": null, "type": "response", "data": {"type": "response", "response_id": "resp_012d3c6a8ff3c7a20069509dd7f1e08193b68027dfcdd3ef06"}}, {"span_id": "span_94a3af7e57ff4d80997a529d", "parent_id": "span_9eb44bc584014ef9b27e3c55", "started_at": "2025-12-28T03:02:48.846277+00:00", "ended_at": "2025-12-28T03:02:48.846443+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "get_js_helpers", "input": "{}", "output": "\n// Excel formula helper functions\nfunction _sum(...args) {\n    return args.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);\n}\n\nfunction _sumRange(rangeData) {\n    if (Array.isArray(rangeData)) {\n        return rangeData.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);\n    }\n    return parseFloat(rangeData) || 0;\n}\n\nfunction _average(...args) {\n    const flat = args.flat().filter(x => x !== null && x !== '' && !isNaN(x));\n    return flat.length ? _sum(...flat) / flat.length : 0;\n}\n\nfunction _averageRange(rangeData) {\n    if (Array.isArray(rangeData)) {\n        const flat = rangeData.flat().filter(x => x !== null && x !== '' && !isNaN(x));\n        return flat.length ? _sumRange(flat) / flat.length : 0;\n    }\n    return parseFloat(rangeData) || 0;\n}\n\nfunction _count(...args) {\n    return args.flat().filter(x => typeof x === 'number' && !isNaN(x)).length;\n}\n\nfunction _counta(...args) {\n    return args.flat().filter(x => x !== null && x !== '' && x !== undefined).length;\n}\n\nfunction _and(...args) {\n    return args.every(x => Boolean(x));\n}\n\nfunction _or(...args) {\n    return args.some(x => Boolean(x));\n}\n\nfunction _round(num, digits = 0) {\n    const factor = Math.pow(10, digits);\n    return Math.round(num * factor) / factor;\n}\n\nfunction _roundUp(num, digits = 0) {\n    const factor = Math.pow(10, digits);\n    return Math.ceil(num * factor) / factor;\n}\n\nfunction _roundDown(num, digits = 0) {\n    const factor = Math.pow(10, digits);\n    return Math.floor(num * factor) / factor;\n}\n\nfunction _len(text) {\n    return String(text).length;\n}\n\nfunction _left(text, numChars = 1) {\n    return String(text).substring(0, numChars);\n}\n\nfunction _right(text, numChars = 1) {\n    const str = String(text);\n    return str.substring(str.length - numChars);\n}\n\nfunction _mid(text, startNum, numChars) {\n    return String(text).substring(startNum - 1, startNum - 1 + numChars);\n}\n\nfunction _trim(text) {\n    return String(text).trim();\n}\n\nfunction _upper(text) {\n    return String(text).toUpperCase();\n}\n\nfunction _lower(text) {\n    return String(text).toLowerCase();\n}\n\nfunction _concat(...args) {\n    return args.join('');\n}\n\n// Number formatting\nfunction formatNumber(num, decimals = 0) {\n    return new Intl.NumberFormat('ko-KR', {\n        minimumFractionDigits: decimals,\n        maximumFractionDigits: decimals\n    }).format(num);\n}\n\nfunction formatCurrency(num) {\n    return new Intl.NumberFormat('ko-KR', {\n        style: 'currency',\n        currency: 'KRW',\n        maximumFractionDigits: 0\n    }).format(num);\n}\n\nfunction formatPercent(num, decimals = 1) {\n    return new Intl.NumberFormat('ko-KR', {\n        style: 'percent',\n        minimumFractionDigits: decimals,\n        maximumFractionDigits: decimals\n    }).format(num / 100);\n}\n", "mcp_data": null}}, {"span_id": "span_5057a76c35c141b284b15263", "parent_id": "span_9eb44bc584014ef9b27e3c55", "started_at": "2025-12-28T03:02:48.846881+00:00", "ended_at": "2025-12-28T03:04:19.459170+00:00", "error": null, "type": "response", "data": {"type": "response", "response_id": "resp_012d3c6a8ff3c7a20069509dd910188193b88dbf66656a5018"}}, {"span_id": "span_9eb44bc584014ef9b27e3c55", "parent_id": null, "started_at": "2025-12-28T03:02:47.737269+00:00", "ended_at": "2025-12-28T03:04:19.459516+00:00", "error": null, "type": "agent", "data": {"type": "agent", "name": "WebApp Generator", "handoffs": [], "tools": ["convert_formula", "check_formula_complexity", "get_js_helpers"], "output_type": "GeneratedWebApp"}}, {"span_id": "span_a1125af77d444630a07f41be", "parent_id": "span_bbe0fd2e649041f8a6612f6a", "started_at": "2025-12-28T03:04:19.460159+00:00", "ended_at": "2025-12-28T03:04:20.994010+00:00", "error": null, "type": "response", "data": {"type": "response", "response_id": "resp_0093a5d3e8580f780069509e33ad7081948fbec85acc1321c9"}}, {"span_id": "span_2fa5a4f24f1143dbb8b13921", "parent_id": "span_bbe0fd2e649041f8a6612f6a", "started_at": "2025-12-28T03:04:20.994195+00:00", "ended_at": "2025-12-28T03:04:20.994324+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "get_js_helpers", "input": "{}", "output": "\n// Excel formula helper functions\nfunction _sum(...args) {\n    return args.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);\n}\n\nfunction _sumRange(rangeData) {\n    if (Array.isArray(rangeData)) {\n        return rangeData.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);\n    }\n    return parseFloat(rangeData) || 0;\n}\n\nfunction _average(...args) {\n    const flat = args.flat().filter(x => x !== null && x !== '' && !isNaN(x));\n    return flat.length ? _sum(...flat) / flat.length : 0;\n}\n\nfunction _averageRange(rangeData) {\n    if (Array.isArray(rangeData)) {\n        const flat = rangeData.flat().filter(x => x !== null && x !== '' && !isNaN(x));\n        return flat.length ? _sumRange(flat) / flat.length : 0;\n    }\n    return parseFloat(rangeData) || 0;\n}\n\nfunction _count(...args) {\n    return args.flat().filter(x => typeof x === 'number' && !isNaN(x)).length;\n}\n\nfunction _counta(...args) {\n    return args.flat().filter(x => x !== null && x !== '' && x !== undefined).length;\n}\n\nfunction _and(...args) {\n    return args.every(x => Boolean(x));\n}\n\nfunction _or(...args) {\n    return args.some(x => Boolean(x));\n}\n\nfunction _round(num, digits = 0) {\n    const factor = Math.pow(10, digits);\n    return Math.round(num * factor) / factor;\n}\n\nfunction _roundUp(num, digits = 0) {\n    const factor = Math.pow(10, digits);\n    return Math.ceil(num * factor) / factor;\n}\n\nfunction _roundDown(num, digits = 0) {\n    const factor = Math.pow(10, digits);\n    return Math.floor(num * factor) / factor;\n}\n\nfunction _len(text) {\n    return String(text).length;\n}\n\nfunction _left(text, numChars = 1) {\n    return String(text).substring(0, numChars);\n}\n\nfunction _right(text, numChars = 1) {\n    const str = String(text);\n    return str.substring(str.length - numChars);\n}\n\nfunction _mid(text, startNum, numChars) {\n    return String(text).substring(startNum - 1, startNum - 1 + numChars);\n}\n\nfunction _trim(text) {\n    return String(text).trim();\n}\n\nfunction _upper(text) {\n    return String(text).toUpperCase();\n}\n\nfunction _lower(text) {\n    return String(text).toLowerCase();\n}\n\nfunction _concat(...args) {\n    return args.join('');\n}\n\n// Number formatting\nfunction formatNumber(num, decimals = 0) {\n    return new Intl.NumberFormat('ko-KR', {\n        minimumFractionDigits: decimals,\n        maximumFractionDigits: decimals\n    }).format(num);\n}\n\nfunction formatCurrency(num) {\n    return new Intl.NumberFormat('ko-KR', {\n        style: 'currency',\n        currency: 'KRW',\n        maximumFractionDigits: 0\n    }).format(num);\n}\n\nfunction formatPercent(num, decimals = 1) {\n    return new Intl.NumberFormat('ko-KR', {\n        style: 'percent',\n        minimumFractionDigits: decimals,\n        maximumFractionDigits: decimals\n    }).format(num / 100);\n}\n", "mcp_data": null}}, {"span_id": "span_66a7703db01443999fa8e8a8", "parent_id": "span_bbe0fd2e649041f8a6612f6a", "started_at": "2025-12-28T03:04:20.994634+00:00", "ended_at": "2025-12-28T03:05:34.743916+00:00", "error": null, "type": "response", "data": {"type": "response", "response_id": "resp_0093a5d3e8580f780069509e3536f08194b7f090e2e1711538"}}, {"span_id": "span_bbe0fd2e649041f8a6612f6a", "parent_id": null, "started_at": "2025-12-28T03:04:19.459927+00:00", "ended_at": "2025-12-28T03:05:34.744255+00:00", "error": null, "type": "agent", "data": {"type": "agent", "name": "WebApp Generator", "handoffs": [], "tools": ["convert_formula", "check_formula_complexity", "get_js_helpers"], "output_type": "GeneratedWebApp"}}]};

function toggleTracePanel() {
    document.getElementById('tracePanel').classList.toggle('open');
}

function renderTrace() {
    const summary = document.getElementById('traceSummary');
    const content = document.getElementById('traceContent');

    if (!TRACE_DATA) {
        content.innerHTML = '<p>No trace data available</p>';
        return;
    }

    // Summary
    const spans = TRACE_DATA.spans || [];
    const agentSpans = spans.filter(s => s.type === 'agent').length;
    const genSpans = spans.filter(s => s.type === 'generation').length;
    const funcSpans = spans.filter(s => s.type === 'function').length;

    summary.innerHTML = `
        <div class="trace-summary-item"><span>Workflow</span><span>${TRACE_DATA.workflow_name || '-'}</span></div>
        <div class="trace-summary-item"><span>Agent Spans</span><span>${agentSpans}</span></div>
        <div class="trace-summary-item"><span>LLM Generations</span><span>${genSpans}</span></div>
        <div class="trace-summary-item"><span>Function Calls</span><span>${funcSpans}</span></div>
    `;

    // Spans
    let html = '';
    spans.forEach(span => {
        const typeClass = span.type || 'custom';
        const data = span.data || {};
        html += `
            <div class="span-item ${typeClass}">
                <div class="span-type">${span.type || 'span'}</div>
                <div class="span-name">${data.name || data.model || span.span_id?.slice(0, 8) || '-'}</div>
                ${data.input ? `<div class="span-data">${typeof data.input === 'string' ? data.input.slice(0, 200) : JSON.stringify(data.input).slice(0, 200)}...</div>` : ''}
                ${data.output ? `<div class="span-data">${typeof data.output === 'string' ? data.output.slice(0, 200) : JSON.stringify(data.output).slice(0, 200)}...</div>` : ''}
                ${data.usage ? `<div class="span-time">Tokens: ${data.usage.total_tokens || '-'}</div>` : ''}
            </div>
        `;
    });
    content.innerHTML = html || '<p>No spans recorded</p>';
}

document.addEventListener('DOMContentLoaded', renderTrace);
</script>
</body>
</html>
