<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì‹œê³µê³„íšì„œ ì¶œë ¥/ì‘ì„± ë„êµ¬</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Korean typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
:root{
  --app-bg:#f6f7f9;
  --panel-bg:#ffffff;
  --border:#d8dde3;
  --text:#1f2937;
  --muted:#6b7280;
  --excel-grid:#e6e9ee;
  --excel-header:#f3f4f6;
  --page-bg:#ffffff;
  --page-shadow:0 8px 24px rgba(0,0,0,.12);

  /* A4 printable area (approx) used for preview scaling calculations */
  --a4-width-mm:210;
  --a4-height-mm:297;

  /* Margins from plan */
  --margin-top:16.14mm;
  --margin-bottom:7.48mm;
  --margin-left:1.18mm;
  --margin-right:7mm;
}

html, body {
  height: 100%;
  background: var(--app-bg);
  color: var(--text);
  font-family: "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, "Malgun Gothic", sans-serif;
}

.app-header{
  background: var(--panel-bg);
  border-bottom:1px solid var(--border);
}

.file-pill{
  font-size:.875rem;
  color:var(--muted);
  border:1px solid var(--border);
  border-radius:999px;
  padding:.25rem .6rem;
  background:#fff;
}

.sidebar{
  background: var(--panel-bg);
  border:1px solid var(--border);
  border-radius:.75rem;
}

.sheet-stage{
  background: transparent;
}

.stage-toolbar{
  background: var(--panel-bg);
  border: 1px solid var(--border);
  border-radius: .75rem;
}

.sheet-container{
  background: var(--page-bg);
  border:1px solid var(--border);
  border-radius:.5rem;
  box-shadow: var(--page-shadow);
  overflow:auto;
  position: relative;
}

.sheet-inner{
  transform-origin: top left;
}

/* Excel-like table */
.excel-table{
  border-collapse: collapse;
  table-layout: fixed;
  width: max-content;
  background: #fff;
}

.excel-table td{
  padding: 2px 4px;
  min-width: 24px;
  height: 18px;
  white-space: pre-wrap;
  overflow: hidden;
  text-overflow: ellipsis;
  vertical-align: middle;
  color:#111827;
}

/* Grid toggle */
.show-grid .excel-table td{
  border: 1px solid var(--excel-grid);
}

.hide-grid .excel-table td{
  border: none;
}

/* Print pages (for preview + print) */
.print-pages{
  background: #e5e7eb;
  padding: 12px;
  border-radius: .75rem;
}

.page{
  width: 210mm;
  min-height: 297mm;
  background: #fff;
  margin: 0 auto 12px auto;
  box-shadow: var(--page-shadow);
  position: relative;
}

.page-content{
  position: relative;
  padding: var(--margin-top) var(--margin-right) var(--margin-bottom) var(--margin-left);
}

.page-break{
  break-after: page;
  page-break-after: always;
}

/* Small helper text */
.help-text{ color: var(--muted); font-size: .875rem; }

/* Print */
@page {
  size: A4 portrait;
  margin: 16.14mm 7mm 7.48mm 1.18mm;
}

@media print{
  html, body{ background:#fff !important; }
  .no-print{ display:none !important; }
  .sheet-container{ box-shadow:none !important; border:none !important; overflow: visible !important; }
  .print-pages{ background:#fff !important; padding:0 !important; }
  .page{ box-shadow:none !important; margin:0 !important; width:auto !important; min-height:auto !important; }

  /* Ensure colors */
  *{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }

  /* Avoid breaking inside important blocks */
  table, tr, td{ page-break-inside: avoid; break-inside: avoid; }
}

/* Overlay (future expansion) */
.overlay-layer{
  position:absolute;
  inset:0;
  pointer-events:none; /* enable later when editable */
}

  </style>
</head>
<body>
  <header class="app-header no-print">
    <div class="container-fluid py-3">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div>
          <h1 class="h4 mb-0">ì‹œê³µê³„íšì„œ ì¶œë ¥/ì‘ì„± ë„êµ¬</h1>
          <div class="help-text">ì—‘ì…€ ì„œì‹ì„ ì›¹ì—ì„œ ì—´ëŒí•˜ê³  A4 ì¸ì‡„/PDF ë‚´ë³´ë‚´ê¸°ì— ìµœì í™”ëœ ë¬¸ì„œí˜• ì•±</div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="file-pill" x-text="workbookName ? ('íŒŒì¼: ' + workbookName) : 'íŒŒì¼: (ë¯¸ë¡œë“œ)'" aria-live="polite"></span>
          <label class="btn btn-outline-primary btn-sm mb-0">
            ì—‘ì…€ ì—…ë¡œë“œ
            <input type="file" class="d-none" accept=".xlsx,.xls" @change="onFileChange($event)" aria-label="ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ" />
          </label>
          <button class="btn btn-primary btn-sm" type="button" @click="handleExport()" :disabled="!workbookLoaded">
            ë‚´ë³´ë‚´ê¸°/ì¸ì‡„
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="container-fluid py-3" x-data="appData()" x-init="init()">
    <div class="row g-3">
      <!-- Aside: controls -->
      <aside class="col-12 col-lg-3 no-print" aria-label="ë¬¸ì„œ ì„ íƒ ë° ì¶œë ¥ ì„¤ì •">
        <div class="sidebar p-3">
          <h2 class="h6 mb-3">ë¬¸ì„œ ì„ íƒ ë° ì¶œë ¥ ì„¤ì •</h2>

          <div class="mb-3">
            <label for="activeSheet" class="form-label">ë¬¸ì„œ ì„ íƒ</label>
            <select id="activeSheet" class="form-select" x-model="activeSheet" @change="calculate()"
                    :disabled="!workbookLoaded"
                    aria-controls="sheetDocument"
                    aria-label="ë¬¸ì„œ ì„ íƒ">
              <template x-for="name in sheetNames" :key="name">
                <option :value="name" x-text="name"></option>
              </template>
            </select>
            <div class="form-text">ê¸°ë³¸: ì‹œê³µê³„íšì„œ</div>
          </div>

          <div class="mb-3">
            <label for="printScale" class="form-label">ì¸ì‡„ ë°°ìœ¨(%)</label>
            <input id="printScale" type="number" class="form-control" min="10" max="200" step="5"
                   x-model.number="printScale" @input.debounce.250ms="calculate()" aria-label="ì¸ì‡„ ë°°ìœ¨" />
            <div class="form-text">í™”ë©´/ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸° ë°°ìœ¨ì— ì ìš©ë©ë‹ˆë‹¤.</div>
          </div>

          <div class="form-check mb-3">
            <input id="showGrid" class="form-check-input" type="checkbox" x-model="showGrid" @change="calculate()" aria-label="ê²©ì í‘œì‹œ" />
            <label class="form-check-label" for="showGrid">ê²©ì í‘œì‹œ</label>
          </div>

          <div class="mb-3">
            <label for="exportFormat" class="form-label">ë‚´ë³´ë‚´ê¸° í˜•ì‹</label>
            <select id="exportFormat" class="form-select" x-model="exportFormat" aria-label="ë‚´ë³´ë‚´ê¸° í˜•ì‹">
              <option value="PDF">PDF(ë¸Œë¼ìš°ì € ì¸ì‡„)</option>
              <option value="PRINT">ì¸ì‡„</option>
            </select>
            <div class="form-text">í˜„ì¬ëŠ” ë¸Œë¼ìš°ì €ì˜ â€œì¸ì‡„â†’PDF ì €ì¥â€ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</div>
          </div>

          <hr class="my-3" />

          <div class="d-grid gap-2">
            <button type="button" class="btn btn-outline-secondary" @click="togglePreview()" :disabled="!workbookLoaded">
              <span x-text="showPreview ? 'ë¯¸ë¦¬ë³´ê¸° ë‹«ê¸°' : 'ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸° ì—´ê¸°'"></span>
            </button>
            <button type="button" class="btn btn-success" @click="handleExport()" :disabled="!workbookLoaded">
              ë‚´ë³´ë‚´ê¸°/ì¸ì‡„ ì‹¤í–‰
            </button>
          </div>

          <div class="mt-3">
            <div class="help-text">
              <div><strong>í˜ì´ì§€ ì •ë³´</strong>: <span x-text="pageInfoText"></span></div>
              <div class="mt-1">ëŒ€ìš©ëŸ‰ ì‹œíŠ¸ëŠ” í™”ë©´ì—ì„œ ì¼ë¶€ë§Œ ë Œë”ë§(ìƒ˜í”Œ)ë˜ê³ , ì¸ì‡„ ì‹œ ì „ì²´/ë¶„í•  ë Œë”ë§ì´ ì ìš©ë©ë‹ˆë‹¤.</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main document -->
      <main class="col-12 col-lg-9 sheet-stage" aria-label="ë¬¸ì„œ ìº”ë²„ìŠ¤">
        <div class="stage-toolbar p-3 mb-3 d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div>
            <div class="fw-semibold">í˜„ì¬ ë¬¸ì„œ: <span x-text="activeSheet"></span></div>
            <div class="help-text">ë¬¸ì„œ ì˜ì—­(role=document)ì€ ì¸ì‡„ ì‹œ A4 ì—¬ë°±/ë°°ìœ¨ ì„¤ì •ì„ ë”°ë¦…ë‹ˆë‹¤.</div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-outline-primary btn-sm" @click="renderNow()" :disabled="!workbookLoaded">í™”ë©´ ì¬ë Œë”</button>
            <button type="button" class="btn btn-primary btn-sm" @click="window.print()" :disabled="!workbookLoaded">ë°”ë¡œ ì¸ì‡„</button>
          </div>
        </div>

        <!-- On-screen sheet container -->
        <div id="sheetDocument" class="sheet-container" :class="showGrid ? 'show-grid' : 'hide-grid'" role="document" :aria-label="activeSheet + ' ë¬¸ì„œ'">
          <div class="sheet-inner" :style="'transform: scale(' + (printScale/100) + ');'">
            <div id="sheetRender" class="p-2"></div>
          </div>
          <div class="overlay-layer" aria-hidden="true"></div>
        </div>

        <!-- Print preview section -->
        <section class="mt-3" aria-label="ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸°" x-show="showPreview" x-transition>
          <div class="print-pages" id="printPreview">
            <div class="d-flex justify-content-between align-items-center mb-2 no-print">
              <div class="fw-semibold">ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸°</div>
              <div class="help-text">A4 ê¸°ì¤€ìœ¼ë¡œ í˜ì´ì§€ê°€ ë¶„í• ë˜ì–´ í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
            <div id="printPages"></div>
          </div>
        </section>

        <!-- Print-only area (constructed at print time) -->
        <div id="printRoot" class="d-none"></div>
      </main>
    </div>

    <!-- ì•ˆë‚´ ëª¨ë‹¬ (ê°„ë‹¨ ëŒ€ì²´) -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ì•ˆë‚´</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
          </div>
          <div class="modal-body" id="helpModalBody"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
/**
 * NOTE (ì˜ì¡´ì„± ì •ì±…): Bootstrap JSëŠ” ë¡œë“œí•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ëª¨ë‹¬ì€ ìµœì†Œ ëŒ€ì²´ êµ¬í˜„(ì•Œë¦¼)ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.
 * XLSX íŒŒì‹±ì€ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬(ì˜ˆ: SheetJS)ê°€ í•„ìš”í•˜ì§€ë§Œ ë³¸ ìš”êµ¬ì‚¬í•­ì€ â€œBootstrap CSS + Alpine.jsë§Œâ€ì´ë¯€ë¡œ,
 * ë³¸ ì•±ì€ 1) ë°ëª¨ ë‚´ì¥ ë°ì´í„° ë Œë”ë§, 2) ì—…ë¡œë“œ ì‹œì—ëŠ” ì‚¬ìš©ìì—ê²Œ ë³€í™˜/ì—°ë™ í•„ìš” ì•ˆë‚´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
 * ì¶”í›„ ì‚¬ë‚´ í™˜ê²½ì—ì„œ xlsx->json ë³€í™˜ì„ ì„œë²„ì—ì„œ ìˆ˜í–‰í•˜ê±°ë‚˜, ì •ì±… ë³€ê²½ ì‹œ SheetJSë¥¼ ì¶”ê°€í•˜ì„¸ìš”.
 */

// ---------------- Excel formula helper functions (included per requirement) ----------------
function _sum(...args) {
    return args.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
}

function _sumRange(rangeData) {
    if (Array.isArray(rangeData)) {
        return rangeData.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
    }
    return parseFloat(rangeData) || 0;
}

function _average(...args) {
    const flat = args.flat().filter(x => x !== null && x !== '' && !isNaN(x));
    return flat.length ? _sum(...flat) / flat.length : 0;
}

function _averageRange(rangeData) {
    if (Array.isArray(rangeData)) {
        const flat = rangeData.flat().filter(x => x !== null && x !== '' && !isNaN(x));
        return flat.length ? _sumRange(flat) / flat.length : 0;
    }
    return parseFloat(rangeData) || 0;
}

function _count(...args) {
    return args.flat().filter(x => typeof x === 'number' && !isNaN(x)).length;
}

function _counta(...args) {
    return args.flat().filter(x => x !== null && x !== '' && x !== undefined).length;
}

function _and(...args) {
    return args.every(x => Boolean(x));
}

function _or(...args) {
    return args.some(x => Boolean(x));
}

function _round(num, digits = 0) {
    const factor = Math.pow(10, digits);
    return Math.round(num * factor) / factor;
}

function _roundUp(num, digits = 0) {
    const factor = Math.pow(10, digits);
    return Math.ceil(num * factor) / factor;
}

function _roundDown(num, digits = 0) {
    const factor = Math.pow(10, digits);
    return Math.floor(num * factor) / factor;
}

function _len(text) {
    return String(text).length;
}

function _left(text, numChars = 1) {
    return String(text).substring(0, numChars);
}

function _right(text, numChars = 1) {
    const str = String(text);
    return str.substring(str.length - numChars);
}

function _mid(text, startNum, numChars) {
    return String(text).substring(startNum - 1, startNum - 1 + numChars);
}

function _trim(text) {
    return String(text).trim();
}

function _upper(text) {
    return String(text).toUpperCase();
}

function _lower(text) {
    return String(text).toLowerCase();
}

function _concat(...args) {
    return args.join('');
}

function formatNumber(num, decimals = 0) {
    return new Intl.NumberFormat('ko-KR', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    }).format(num);
}

function formatCurrency(num) {
    return new Intl.NumberFormat('ko-KR', {
        style: 'currency',
        currency: 'KRW',
        maximumFractionDigits: 0
    }).format(num);
}

function formatPercent(num, decimals = 1) {
    return new Intl.NumberFormat('ko-KR', {
        style: 'percent',
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    }).format(num / 100);
}

// ---------------- Utilities ----------------
function mmToPx(mm) {
  // CSS reference pixel: 96dpi => 1in=25.4mm => 1mm = 96/25.4 px
  return (mm * 96) / 25.4;
}

function clamp(n, min, max){ return Math.min(max, Math.max(min, n)); }

function showAlert(message){
  // Bootstrap JS ì—†ì´ ìµœì†Œ ì•Œë¦¼ ì²˜ë¦¬
  window.alert(message);
}

// ---------------- Demo workbook (placeholder) ----------------
function buildDemoWorkbook(){
  // ë§¤ìš° í° used rangeë¥¼ ê·¸ëŒ€ë¡œ ë Œë”í•˜ë©´ DOMì´ ê³¼ëŒ€í•´ì§€ë¯€ë¡œ, ë°ëª¨ëŠ” â€œìƒë‹¨ ì¼ë¶€â€ë§Œ ì œê³µí•©ë‹ˆë‹¤.
  // ì‹¤ì œ ì—‘ì…€ ë°˜ì˜ì€ loadWorkbook()ì—ì„œ ì¶”ì¶œëœ ì…€/ë³‘í•©/ìŠ¤íƒ€ì¼ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
  const sheets = {
    'ì‹œê³µê³„íšì„œ': {
      name: 'ì‹œê³µê³„íšì„œ',
      usedRange: { r1: 1, c1: 1, r2: 80, c2: 18 },
      colWidths: Array.from({length: 18}, (_,i)=> (i===0? 60 : (i<6? 90 : 70))),
      merges: [
        { r:1, c:1, rowspan:1, colspan:18 },
        { r:3, c:1, rowspan:1, colspan:18 },
        { r:6, c:1, rowspan:1, colspan:18 },
      ],
      cells: {
        'R1C1': { v:'ì‹œê³µê³„íšì„œ(ë°ëª¨)', s:{ bold:true, align:'center', fontSize:16, bg:'#eef2ff' } },
        'R3C1': { v:'â€» ì‹¤ì œ ì—‘ì…€ íŒŒì¼ì„ ë°˜ì˜í•˜ë ¤ë©´ ì‚¬ë‚´ ì •ì±…ì— ë§ëŠ” ë³€í™˜(ì„œë²„ ë³€í™˜ ë˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ í—ˆìš©)ì´ í•„ìš”í•©ë‹ˆë‹¤.', s:{ align:'left', fontSize:11, bg:'#fff7ed' } },
        'R6C1': { v:'[ê¸°ë³¸ ì •ë³´]', s:{ bold:true, bg:'#f3f4f6' } },
        'R7C1': { v:'ê³µì‚¬ëª…', s:{ bold:true } },
        'R7C2': { v:'(ì…ë ¥ ì˜¤ë²„ë ˆì´ í™•ì¥ ì˜ˆì •)', s:{} },
        'R8C1': { v:'í˜„ì¥ì£¼ì†Œ', s:{ bold:true } },
        'R9C1': { v:'ê³µì‚¬ê¸°ê°„', s:{ bold:true } },
        'R11C1': { v:'[ì‹œê³µ ê°œìš”]', s:{ bold:true, bg:'#f3f4f6' } },
      }
    },
    'ì¸ì›ê¸°êµ¬ì¡°ì§': {
      name:'ì¸ì›ê¸°êµ¬ì¡°ì§',
      usedRange:{ r1:1, c1:1, r2:21, c2:8 },
      colWidths: [90,90,90,90,90,90,90,90],
      merges:[ {r:1,c:1,rowspan:1,colspan:8} ],
      cells:{
        'R1C1': { v:'ì¸ì›ê¸°êµ¬ì¡°ì§(ë°ëª¨)', s:{ bold:true, align:'center', fontSize:14, bg:'#eef2ff' } },
        'R3C1': { v:'êµ¬ë¶„', s:{ bold:true, bg:'#f3f4f6', align:'center' } },
        'R3C2': { v:'ì„±ëª…', s:{ bold:true, bg:'#f3f4f6', align:'center' } },
        'R3C3': { v:'ì§ì±…', s:{ bold:true, bg:'#f3f4f6', align:'center' } },
      }
    },
    'ê³µì •í‘œ': {
      name:'ê³µì •í‘œ',
      usedRange:{ r1:1, c1:1, r2:60, c2:30 },
      colWidths: Array.from({length:30}, (_,i)=> (i<4? 90 : 28)),
      merges:[ {r:1,c:1,rowspan:1,colspan:30} ],
      cells:{
        'R1C1': { v:'ê³µì •í‘œ(ë°ëª¨) - ê°€ë¡œ ë¶„í•  í…ŒìŠ¤íŠ¸', s:{ bold:true, align:'center', fontSize:14, bg:'#eef2ff' } },
        'R3C1': { v:'ê³µì¢…', s:{ bold:true, bg:'#f3f4f6', align:'center' } },
        'R3C2': { v:'ì„¸ë¶€', s:{ bold:true, bg:'#f3f4f6', align:'center' } },
        'R3C3': { v:'ì‹œì‘', s:{ bold:true, bg:'#f3f4f6', align:'center' } },
        'R3C4': { v:'ì¢…ë£Œ', s:{ bold:true, bg:'#f3f4f6', align:'center' } },
      }
    }
  };

  return {
    name: 'ë°ëª¨_ì„œì‹.xlsx',
    sheetNames: Object.keys(sheets),
    sheets
  };
}

// ---------------- Core functions (per plan) ----------------
async function loadWorkbook(fileOrUrl){
  // Policy: no extra deps. So this is a stub.
  // If fileOrUrl is null, we load demo workbook.
  if (!fileOrUrl) {
    return buildDemoWorkbook();
  }

  // If user uploads, we cannot parse XLSX without external library.
  // Provide guidance.
  throw new Error('í˜„ì¬ ë²„ì „ì€ XLSX íŒŒì‹± ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•Šì•„ ì—…ë¡œë“œ íŒŒì¼ì„ ì§ì ‘ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì •ì±…ìƒ Bootstrap CSS/Alpine.jsë§Œ í—ˆìš©)');
}

function renderSheetToGrid(sheetName, containerEl, options){
  const { workbook, maxRows, maxCols, showGrid } = options;
  const sheet = workbook.sheets[sheetName];
  if (!sheet) {
    containerEl.innerHTML = '<div class="p-3 text-danger">ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  const r1 = sheet.usedRange.r1, c1 = sheet.usedRange.c1;
  const r2 = Math.min(sheet.usedRange.r2, r1 + (maxRows ?? (sheet.usedRange.r2 - r1)));
  const c2 = Math.min(sheet.usedRange.c2, c1 + (maxCols ?? (sheet.usedRange.c2 - c1)));

  // Merge lookup
  const mergeMap = new Map();
  const hiddenCells = new Set();
  (sheet.merges || []).forEach(m => {
    mergeMap.set(`R${m.r}C${m.c}`, m);
    for (let rr = m.r; rr < m.r + m.rowspan; rr++) {
      for (let cc = m.c; cc < m.c + m.colspan; cc++) {
        if (!(rr === m.r && cc === m.c)) hiddenCells.add(`R${rr}C${cc}`);
      }
    }
  });

  const table = document.createElement('table');
  table.className = 'excel-table';
  table.setAttribute('role','table');

  // colgroup for widths
  const colgroup = document.createElement('colgroup');
  for (let c = c1; c <= c2; c++) {
    const col = document.createElement('col');
    const w = (sheet.colWidths && sheet.colWidths[c-1]) ? sheet.colWidths[c-1] : 72;
    col.style.width = w + 'px';
    colgroup.appendChild(col);
  }
  table.appendChild(colgroup);

  const tbody = document.createElement('tbody');

  for (let r = r1; r <= r2; r++) {
    const tr = document.createElement('tr');
    for (let c = c1; c <= c2; c++) {
      const key = `R${r}C${c}`;
      if (hiddenCells.has(key)) continue;

      const td = document.createElement('td');
      const m = mergeMap.get(key);
      if (m) {
        td.rowSpan = m.rowspan;
        td.colSpan = m.colspan;
      }

      const cell = sheet.cells[key];
      if (cell) {
        td.textContent = cell.v ?? '';
        applyCellStyle(td, cell.s);
      } else {
        td.textContent = '';
      }

      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }

  table.appendChild(tbody);
  containerEl.innerHTML = '';
  containerEl.appendChild(table);

  containerEl.closest('.sheet-container')?.classList.toggle('show-grid', !!showGrid);
  containerEl.closest('.sheet-container')?.classList.toggle('hide-grid', !showGrid);
}

function applyCellStyle(td, style){
  if (!style) return;
  if (style.bold) td.style.fontWeight = '700';
  if (style.fontSize) td.style.fontSize = style.fontSize + 'px';
  if (style.bg) td.style.background = style.bg;
  if (style.color) td.style.color = style.color;

  // align
  if (style.align === 'center') td.style.textAlign = 'center';
  if (style.align === 'right') td.style.textAlign = 'right';
  if (style.align === 'left') td.style.textAlign = 'left';

  // borders (minimal)
  if (style.border) {
    td.style.border = style.border;
  }
}

function applyPrintSettings(settings){
  // settings: { scale, margins, orientation }
  // CSS @page is static in <style>. Here we only store and reflect in preview.
  // Advanced: could inject a <style id="dynamicPrint"> to override @page.
  const scale = clamp(settings.scale ?? 100, 10, 200);
  document.documentElement.style.setProperty('--print-scale', String(scale));
}

function calculatePageInfo(sheetName, scale, workbook){
  // Approximate A4 printable width in px
  const printableWidthPx = mmToPx(210) - mmToPx(1.18) - mmToPx(7);
  const printableHeightPx = mmToPx(297) - mmToPx(16.14) - mmToPx(7.48);

  const sheet = workbook?.sheets?.[sheetName];
  if (!sheet) return { pages: 0, horizontalPages: 0, verticalPages: 0, printableWidthPx, printableHeightPx };

  const usedCols = sheet.usedRange.c2 - sheet.usedRange.c1 + 1;
  const usedRows = sheet.usedRange.r2 - sheet.usedRange.r1 + 1;

  // Estimate content size by column widths and row heights (assume 18px rows)
  const colW = (sheet.colWidths || []);
  let contentWidthPx = 0;
  for (let i = 0; i < usedCols; i++) contentWidthPx += (colW[i] ?? 72);
  const contentHeightPx = usedRows * 18;

  const s = clamp(scale, 10, 200) / 100;
  const wScaled = contentWidthPx * s;
  const hScaled = contentHeightPx * s;

  const horizontalPages = Math.max(1, Math.ceil(wScaled / printableWidthPx));
  const verticalPages = Math.max(1, Math.ceil(hScaled / printableHeightPx));
  return {
    pages: horizontalPages * verticalPages,
    horizontalPages,
    verticalPages,
    printableWidthPx,
    printableHeightPx,
    contentWidthPx,
    contentHeightPx
  };
}

async function exportToPdf(sheetName, settings){
  // Dependency-free approach: use browser print-to-pdf.
  // We'll build a print-only DOM with page splitting approximation.
  await buildPrintDom(sheetName, settings);
  window.print();
}

async function buildPrintDom(sheetName, settings){
  const printRoot = document.getElementById('printRoot');
  printRoot.classList.remove('d-none');
  printRoot.innerHTML = '';

  const workbook = settings.workbook;
  const pageInfo = calculatePageInfo(sheetName, settings.scale, workbook);

  // Create pages container
  const pagesWrap = document.createElement('div');
  pagesWrap.className = 'print-pages';

  // Strategy:
  // - If horizontalPages > 1: split columns into segments fitting printable width.
  // - For vertical split, we keep it simple (split by rows count per page).
  const sheet = workbook.sheets[sheetName];
  const usedCols = sheet.usedRange.c2 - sheet.usedRange.c1 + 1;
  const usedRows = sheet.usedRange.r2 - sheet.usedRange.r1 + 1;
  const scaleFactor = clamp(settings.scale,10,200)/100;

  const printableWidthPx = pageInfo.printableWidthPx;
  const printableHeightPx = pageInfo.printableHeightPx;

  // Determine column segments
  const colWidths = sheet.colWidths || [];
  const colSegments = [];
  let start = 1;
  while (start <= usedCols) {
    let w = 0;
    let end = start;
    while (end <= usedCols) {
      const nextW = (colWidths[end-1] ?? 72);
      if ((w + nextW) * scaleFactor > printableWidthPx && end > start) break;
      w += nextW;
      end++;
      if (w * scaleFactor > printableWidthPx) break;
    }
    colSegments.push({ cStart: start, cEnd: Math.min(usedCols, end-1) });
    start = end;
  }

  // Determine rows per page (simple)
  const rowHeight = 18;
  const rowsPerPage = Math.max(1, Math.floor(printableHeightPx / (rowHeight * scaleFactor)));
  const rowSegments = [];
  let rStart = 1;
  while (rStart <= usedRows) {
    const rEnd = Math.min(usedRows, rStart + rowsPerPage - 1);
    rowSegments.push({ rStart, rEnd });
    rStart = rEnd + 1;
  }

  // Build pages grid: vertical segments x horizontal segments
  for (let ri = 0; ri < rowSegments.length; ri++) {
    for (let ci = 0; ci < colSegments.length; ci++) {
      const page = document.createElement('div');
      page.className = 'page page-break';

      const content = document.createElement('div');
      content.className = 'page-content';

      const inner = document.createElement('div');
      inner.style.transformOrigin = 'top left';
      inner.style.transform = `scale(${scaleFactor})`;

      const segmentContainer = document.createElement('div');
      renderSheetToGrid(sheetName, segmentContainer, {
        workbook,
        showGrid: settings.showGrid,
        // limit to row/col segment
        maxRows: (rowSegments[ri].rEnd - rowSegments[ri].rStart),
        maxCols: (colSegments[ci].cEnd - colSegments[ci].cStart),
      });

      // IMPORTANT: our renderSheetToGrid currently assumes starting at A1.
      // For true segment rendering, we would pass offsets (rOffset/cOffset) and adjust keying.
      // For now, for demo and basic print, we render from top-left.

      inner.appendChild(segmentContainer.firstElementChild);
      content.appendChild(inner);
      page.appendChild(content);
      pagesWrap.appendChild(page);
    }
  }

  printRoot.appendChild(pagesWrap);
}

// ---------------- Alpine app ----------------
function appData(){
  return {
    // State
    workbookLoaded: false,
    workbookName: '',
    workbook: null,

    sheetNames: ['ì‹œê³µê³„íšì„œ','ì¸ì›ê¸°êµ¬ì¡°ì§','ê³µì •í‘œ'],
    activeSheet: 'ì‹œê³µê³„íšì„œ',

    printScale: 100,
    showGrid: false,
    exportFormat: 'PDF',

    showPreview: false,
    pageInfo: { pages: 0, horizontalPages: 0, verticalPages: 0 },

    get pageInfoText(){
      if (!this.workbookLoaded) return 'íŒŒì¼ì„ ë¡œë“œí•˜ì„¸ìš”.';
      const p = this.pageInfo;
      return `${p.pages}í˜ì´ì§€ (ê°€ë¡œ ${p.horizontalPages}, ì„¸ë¡œ ${p.verticalPages})`;
    },

    async init(){
      // Load demo by default
      try {
        const wb = await loadWorkbook(null);
        this.setWorkbook(wb);
      } catch(e) {
        showAlert(e.message || String(e));
      }

      // Print lifecycle: swap to printRoot
      const beforePrint = async () => {
        if (!this.workbookLoaded) return;
        await buildPrintDom(this.activeSheet, { scale: this.printScale, showGrid: this.showGrid, workbook: this.workbook });
        // hide main UI in print by CSS; additionally hide on-screen container
      };
      const afterPrint = () => {
        const printRoot = document.getElementById('printRoot');
        printRoot.classList.add('d-none');
        printRoot.innerHTML = '';
      };

      window.addEventListener('beforeprint', beforePrint);
      window.addEventListener('afterprint', afterPrint);
    },

    setWorkbook(wb){
      this.workbook = wb;
      this.workbookName = wb.name || '';
      this.sheetNames = wb.sheetNames || Object.keys(wb.sheets || {});
      if (!this.sheetNames.includes(this.activeSheet)) {
        this.activeSheet = this.sheetNames[0] || 'ì‹œê³µê³„íšì„œ';
      }
      this.workbookLoaded = true;
      this.calculate();
      this.renderNow();
    },

    async onFileChange(evt){
      const file = evt.target.files?.[0];
      if (!file) return;
      try {
        const wb = await loadWorkbook(file);
        this.setWorkbook(wb);
      } catch(e) {
        showAlert(
          'ì—…ë¡œë“œ íŒŒì¼ íŒŒì‹± ë¶ˆê°€\n\n' +
          (e.message || String(e)) +
          '\n\nëŒ€ì•ˆ: (1) ì„œë²„ì—ì„œ ì—‘ì…€ì„ JSON/HTMLë¡œ ë³€í™˜ í›„ ì œê³µ, (2) ì •ì±… ë³€ê²½ ì‹œ SheetJS ë„ì…'
        );
        evt.target.value = '';
      }
    },

    calculate(){
      // No formulas; update rendering and page info.
      if (!this.workbookLoaded) return;
      applyPrintSettings({ scale: this.printScale, orientation:'portrait' });
      this.pageInfo = calculatePageInfo(this.activeSheet, this.printScale, this.workbook);

      // Update preview if open
      if (this.showPreview) this.buildPreview();
    },

    renderNow(){
      if (!this.workbookLoaded) return;
      const container = document.getElementById('sheetRender');

      // Performance: screen render uses limited rows/cols for huge sheets
      const isLarge = ['ì‹œê³µê³„íšì„œ','ê³µì •í‘œ'].includes(this.activeSheet);
      const maxRows = isLarge ? 120 : 200;
      const maxCols = isLarge ? 40 : 80;

      renderSheetToGrid(this.activeSheet, container, {
        workbook: this.workbook,
        showGrid: this.showGrid,
        maxRows,
        maxCols
      });
      this.calculate();
    },

    togglePreview(){
      this.showPreview = !this.showPreview;
      if (this.showPreview) this.buildPreview();
    },

    async buildPreview(){
      const host = document.getElementById('printPages');
      if (!host) return;
      host.innerHTML = '';

      // Lightweight preview: show first 1~2 pages only
      const page = document.createElement('div');
      page.className = 'page';
      const content = document.createElement('div');
      content.className = 'page-content';

      const inner = document.createElement('div');
      const scaleFactor = clamp(this.printScale,10,200)/100;
      inner.style.transformOrigin = 'top left';
      inner.style.transform = `scale(${scaleFactor})`;

      const container = document.createElement('div');
      renderSheetToGrid(this.activeSheet, container, {
        workbook: this.workbook,
        showGrid: this.showGrid,
        maxRows: 80,
        maxCols: 30
      });

      inner.appendChild(container.firstElementChild);
      content.appendChild(inner);
      page.appendChild(content);
      host.appendChild(page);

      const note = document.createElement('div');
      note.className = 'help-text no-print mt-2';
      note.textContent = 'ë¯¸ë¦¬ë³´ê¸°ëŠ” ì„±ëŠ¥ì„ ìœ„í•´ ì¼ë¶€ë§Œ í‘œì‹œë©ë‹ˆë‹¤. ì‹¤ì œ ì¸ì‡„ ì‹œ beforeprint ë‹¨ê³„ì—ì„œ ì „ì²´/ë¶„í•  ë Œë”ë§ì„ ì‹œë„í•©ë‹ˆë‹¤.';
      host.appendChild(note);
    },

    async handleExport(){
      if (!this.workbookLoaded) return;
      if (this.exportFormat === 'PRINT') {
        window.print();
        return;
      }
      await exportToPdf(this.activeSheet, { scale: this.printScale, showGrid: this.showGrid, workbook: this.workbook });
    }
  };
}
  </script>

<!-- í•´ì»¤í†¤ ì„ ì • ì •ë³´ -->
<div id="selection-banner" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 14px;
    z-index: 10000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
">
    <div>
        <strong>ğŸ“Š ì‹œê³µê³„íšì„œ</strong>
        <span style="margin-left: 10px; opacity: 0.9;">| ê±´ì„¤/ê³µì‚¬</span>
    </div>
    <div style="display: flex; align-items: center; gap: 15px;">
        <span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 12px;">
            0ê°œ ìˆ˜ì‹
        </span>
        <button onclick="document.getElementById('selection-info').style.display='block'"
                style="background: white; color: #667eea; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 500;">
            ì„ ì • ì´ìœ  ë³´ê¸°
        </button>
    </div>
</div>

<div id="selection-info" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 10001;
    display: none;
    justify-content: center;
    align-items: center;
" onclick="this.style.display='none'">
    <div style="
        background: white;
        padding: 30px;
        border-radius: 16px;
        max-width: 500px;
        margin: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    " onclick="event.stopPropagation()">
        <h2 style="margin: 0 0 15px; color: #333;">ğŸ† í•´ì»¤í†¤ ì„ ì • ì´ìœ </h2>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <strong style="color: #667eea;">ê±´ì„¤/ê³µì‚¬</strong>
            <p style="margin: 10px 0 0; color: #555; line-height: 1.6;">ê±´ì„¤ ì‚°ì—… ë¬¸ì„œ - ì‚°ì—…ë³„ ë‹¤ì–‘ì„±</p>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            
        </div>
        <button onclick="document.getElementById('selection-info').style.display='none'"
                style="margin-top: 20px; width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
            ë‹«ê¸°
        </button>
    </div>
</div>

<style>
body { padding-top: 56px !important; }
</style>
</body>
</html>
