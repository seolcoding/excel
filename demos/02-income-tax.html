<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì¢…í•©ì†Œë“ì„¸ ê°„ì´ ê³„ì‚°ê¸°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    :root{
      --app-max-width: 900px;
      --font-size-base: 14px;
      --muted: #6c757d;
      --border: #dee2e6;
      --soft: #f8f9fa;
      --accent: #0d6efd;
      --danger: #c00;
      --good: #198754;
      --warn: #ffc107;
      --card-emph: #fff8e1;
      --card-emph-border: #ffe08a;
      --card-strong: #e7f1ff;
      --card-strong-border: #b6d4fe;
    }

    html, body { height: 100%; }
    body {
      font-family: "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      font-size: var(--font-size-base);
      color: #212529;
      background: #fff;
    }

    .app-shell{ max-width: var(--app-max-width); margin: 0 auto; }
    .money, .num { text-align: right; font-variant-numeric: tabular-nums; }

    .section-title{ font-weight: 700; letter-spacing: -0.2px; }
    .help-text{ color: var(--muted); font-size: 12px; }

    .form-control.money-input{ text-align: right; font-variant-numeric: tabular-nums; }

    input[aria-invalid='true'], select[aria-invalid='true'] { border-color: var(--danger) !important; }
    .field-error{ color: var(--danger); font-size: 12px; margin-top: 4px; }

    .result-card{ border: 1px solid var(--border); border-radius: 10px; background: #fff; }
    .result-card .result-row{ display:flex; align-items:baseline; justify-content:space-between; gap: 12px; padding: 10px 12px; border-top: 1px dashed #eee; }
    .result-card .result-row:first-child{ border-top: 0; }
    .result-label{ color:#212529; }
    .result-value{ font-variant-numeric: tabular-nums; text-align:right; white-space: nowrap; }

    .result-emph{ background: var(--card-emph); border: 1px solid var(--card-emph-border); }
    .result-strong{ background: var(--card-strong); border: 1px solid var(--card-strong-border); }

    .badge-k{ font-weight: 600; }

    .print-only{ display: none; }

    /* Print */
    @page {
      size: A4 portrait;
      margin: 19.05mm 17.78mm 19.05mm 17.78mm;
    }

    @media print{
      .no-print{ display:none !important; }
      .print-only{ display: inline !important; }
      .print-block{ display: block !important; }
      .app-shell{ max-width: none; }
      a[href]:after{ content: ""; }
      .result-card{ border-color: #999; }
      .page-break-before{ page-break-before: always; break-before: page; }

      /* Hide inputs, show print text */
      .print-hide-input{ display:none !important; }
      .print-show-text{ display:inline !important; }
    }

    /* Table */
    table.tax-table th, table.tax-table td{ font-variant-numeric: tabular-nums; }
    table.tax-table td{ vertical-align: middle; }
  </style>
</head>
<body>
  <div class="container py-4 app-shell" x-data="appData()" x-init="init()">
    <header class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-3">
      <div>
        <h1 class="h4 mb-1">ì¢…í•©ì†Œë“ì„¸ ê°„ì´ ê³„ì‚°ê¸°</h1>
        <div class="help-text">ì—‘ì…€ â€˜ì¢…í•©ì†Œë“ì„¸ ì—‘ì…€ ê°„ì´ ê³„ì‚°ê¸° v2.1â€™ì˜ í•µì‹¬ ì…ë ¥ê°’ìœ¼ë¡œ ì‚°ì¶œì„¸ì•¡/ê²°ì •ì„¸ì•¡ ë“±ì„ ê°„ë‹¨íˆ ì¶”ì •í•©ë‹ˆë‹¤. (ì°¸ê³ ìš©)</div>
      </div>
      <div class="d-flex gap-2 no-print">
        <button type="button" class="btn btn-outline-secondary" @click="resetAll()">ì´ˆê¸°í™”</button>
        <button type="button" class="btn btn-primary" @click="printReport()">ì¸ì‡„</button>
      </div>
    </header>

    <main>
      <!-- ì…ë ¥ í¼ ì„¹ì…˜ -->
      <section class="mb-4" aria-labelledby="sec-input">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h5 section-title mb-0" id="sec-input">ê¸°ë³¸ ì •ë³´ ë° ì†Œë“/ê³µì œ ì…ë ¥</h2>
          <span class="help-text no-print">ì…ë ¥ ì‹œ 0.15ì´ˆ í›„ ìë™ ê³„ì‚°</span>
        </div>

        <div class="card shadow-sm">
          <div class="card-body">
            <form class="row g-3" @submit.prevent>
              <div class="col-md-3">
                <label class="form-label" for="tax_year">ê·€ì†ì—°ë„</label>
                <input id="tax_year" type="number" inputmode="numeric" class="form-control" placeholder="ì˜ˆ: 2024"
                       :aria-invalid="errors.tax_year ? 'true' : 'false'"
                       x-model="inputs.tax_year" @input="onAnyInput()" />
                <div class="field-error" x-show="errors.tax_year" x-text="errors.tax_year"></div>
              </div>

              <div class="col-md-4">
                <label class="form-label" for="filing_type">ì‹ ê³ êµ¬ë¶„</label>
                <select id="filing_type" class="form-select"
                        :aria-invalid="errors.filing_type ? 'true' : 'false'"
                        x-model="inputs.filing_type" @change="onAnyInput()">
                  <option value="">ì„ íƒ</option>
                  <option value="ì •ê¸°ì‹ ê³ ">ì •ê¸°ì‹ ê³ </option>
                  <option value="ê¸°í•œí›„ì‹ ê³ ">ê¸°í•œí›„ì‹ ê³ </option>
                  <option value="ìˆ˜ì •ì‹ ê³ ">ìˆ˜ì •ì‹ ê³ </option>
                </select>
                <div class="field-error" x-show="errors.filing_type" x-text="errors.filing_type"></div>
              </div>

              <div class="col-md-5 d-flex align-items-end gap-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="local_income_tax_apply" x-model="inputs.local_income_tax_apply" @change="onAnyInput()">
                  <label class="form-check-label" for="local_income_tax_apply">ì§€ë°©ì†Œë“ì„¸(10%) ìë™ ê³„ì‚°</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="spouse_deduction_apply" x-model="inputs.spouse_deduction_apply" @change="onAnyInput()">
                  <label class="form-check-label" for="spouse_deduction_apply">ë°°ìš°ìê³µì œ ì ìš©</label>
                </div>
              </div>

              <hr class="my-2" />

              <div class="col-md-6">
                <label class="form-label" for="taxable_income_base">ì¢…í•©ì†Œë“ê¸ˆì•¡(ë˜ëŠ” ê³¼ì„¸ëŒ€ìƒ ì†Œë“) ì…ë ¥</label>
                <div class="input-group">
                  <input id="taxable_income_base" type="text" class="form-control money-input"
                         placeholder="0" inputmode="numeric" autocomplete="off"
                         :aria-invalid="errors.taxable_income_base ? 'true' : 'false'"
                         x-model="ui.taxable_income_base" @input="onMoneyInput('taxable_income_base')" />
                  <span class="input-group-text">ì›</span>
                </div>
                <div class="help-text">ì…€ C10</div>
                <div class="field-error" x-show="errors.taxable_income_base" x-text="errors.taxable_income_base"></div>
              </div>

              <div class="col-md-6">
                <label class="form-label" for="income_deduction_total">ì†Œë“ê³µì œ í•©ê³„</label>
                <div class="input-group">
                  <input id="income_deduction_total" type="text" class="form-control money-input"
                         placeholder="0" inputmode="numeric" autocomplete="off"
                         :aria-invalid="errors.income_deduction_total ? 'true' : 'false'"
                         x-model="ui.income_deduction_total" @input="onMoneyInput('income_deduction_total')" />
                  <span class="input-group-text">ì›</span>
                </div>
                <div class="help-text">ì…€ C11</div>
                <div class="field-error" x-show="errors.income_deduction_total" x-text="errors.income_deduction_total"></div>
              </div>

              <div class="col-md-6">
                <label class="form-label" for="tax_credit_total">ì„¸ì•¡ê³µì œ/ê°ë©´ í•©ê³„</label>
                <div class="input-group">
                  <input id="tax_credit_total" type="text" class="form-control money-input"
                         placeholder="0" inputmode="numeric" autocomplete="off"
                         :aria-invalid="errors.tax_credit_total ? 'true' : 'false'"
                         x-model="ui.tax_credit_total" @input="onMoneyInput('tax_credit_total')" />
                  <span class="input-group-text">ì›</span>
                </div>
                <div class="help-text">ì…€ C12</div>
                <div class="field-error" x-show="errors.tax_credit_total" x-text="errors.tax_credit_total"></div>
              </div>

              <div class="col-md-6">
                <label class="form-label" for="prepaid_tax">ê¸°ë‚©ë¶€ì„¸ì•¡(ì›ì²œì§•ìˆ˜/ì˜ˆë‚© ë“±)</label>
                <div class="input-group">
                  <input id="prepaid_tax" type="text" class="form-control money-input"
                         placeholder="0" inputmode="numeric" autocomplete="off"
                         :aria-invalid="errors.prepaid_tax ? 'true' : 'false'"
                         x-model="ui.prepaid_tax" @input="onMoneyInput('prepaid_tax')" />
                  <span class="input-group-text">ì›</span>
                </div>
                <div class="help-text">ì…€ C13</div>
                <div class="field-error" x-show="errors.prepaid_tax" x-text="errors.prepaid_tax"></div>
              </div>

              <div class="col-md-4">
                <label class="form-label" for="dependent_count">ë¶€ì–‘ê°€ì¡± ìˆ˜(ë°°ìš°ì ì œì™¸)</label>
                <input id="dependent_count" type="number" min="0" step="1" class="form-control num" inputmode="numeric"
                       :aria-invalid="errors.dependent_count ? 'true' : 'false'"
                       x-model="inputs.dependent_count" @input="onAnyInput()" />
                <div class="help-text">ì…€ K21 (ì°¸ê³ ìš©: ë³¸ ê°„ì´ ê³„ì‚° ë¡œì§ì—ëŠ” ë¯¸ë°˜ì˜)</div>
                <div class="field-error" x-show="errors.dependent_count" x-text="errors.dependent_count"></div>
              </div>

              <div class="col-md-8">
                <label class="form-label" for="other_adjustment">ê¸°íƒ€ ì¡°ì •ê¸ˆì•¡(ê°€ì‚°/ê°ì‚°)</label>
                <div class="input-group">
                  <input id="other_adjustment" type="text" class="form-control money-input"
                         placeholder="0" inputmode="numeric" autocomplete="off"
                         :aria-invalid="errors.other_adjustment ? 'true' : 'false'"
                         x-model="ui.other_adjustment" @input="onMoneyInput('other_adjustment', true)" />
                  <span class="input-group-text">ì›</span>
                </div>
                <div class="help-text">ì…€ F19 (ìŒìˆ˜ ê°€ëŠ¥)</div>
                <div class="field-error" x-show="errors.other_adjustment" x-text="errors.other_adjustment"></div>
              </div>
            </form>

            <div class="mt-3 no-print d-flex flex-wrap gap-2 align-items-center">
              <span class="badge text-bg-light badge-k">ìƒíƒœ</span>
              <span class="help-text" x-show="!isValid">ì…ë ¥ ì˜¤ë¥˜ê°€ ìˆìœ¼ë©´ ê³„ì‚° ê²°ê³¼ê°€ ì¼ë¶€ ë¶€ì •í™•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
              <span class="help-text" x-show="isValid">ì…ë ¥ê°’ì´ ì •ìƒì…ë‹ˆë‹¤.</span>
            </div>
          </div>
        </div>

      </section>

      <!-- ê²°ê³¼ ì„¹ì…˜ -->
      <section class="mb-4" aria-labelledby="sec-result">
        <h2 class="h5 section-title mb-2" id="sec-result">ê³„ì‚° ê²°ê³¼</h2>

        <div class="row g-3">
          <div class="col-lg-7">
            <div class="result-card shadow-sm" aria-live="polite" aria-atomic="true">
              <div class="p-3 border-bottom" style="background:var(--soft)">
                <div class="d-flex justify-content-between align-items-start gap-2">
                  <div>
                    <div class="fw-semibold">ìš”ì•½</div>
                    <div class="help-text">êµ­ì„¸(ì¢…í•©ì†Œë“ì„¸) + ì§€ë°©ì†Œë“ì„¸, ê·¸ë¦¬ê³  ê¸°ë‚©ë¶€ì„¸ì•¡ ì°¨ê° ê²°ê³¼</div>
                  </div>
                  <div class="text-end">
                    <div class="help-text">ê¸°ì¤€: ê³¼ì„¸ëŒ€ìƒ ì†Œë“(ì…ë ¥)</div>
                    <div class="fw-semibold" x-text="formatKRW(outputs.taxable_income_base_echo)"></div>
                  </div>
                </div>
              </div>

              <div class="result-row">
                <div class="result-label">ê³¼ì„¸í‘œì¤€</div>
                <div class="result-value" x-text="formatKRW(outputs.tax_base)"></div>
              </div>
              <div class="result-row">
                <div class="result-label">ì‚°ì¶œì„¸ì•¡(ëˆ„ì§„ì„¸ìœ¨)</div>
                <div class="result-value" x-text="formatKRW(outputs.progressive_tax)"></div>
              </div>
              <div class="result-row">
                <div class="result-label">ê³µì œ/ê°ë©´ ì „ ì„¸ì•¡(ì¡°ì • í¬í•¨)</div>
                <div class="result-value" x-text="formatKRW(outputs.tax_before_credits)"></div>
              </div>
              <div class="result-row">
                <div class="result-label">ì„¸ì•¡ê³µì œ/ê°ë©´ í›„ ì„¸ì•¡(êµ­ì„¸)</div>
                <div class="result-value" x-text="formatKRW(outputs.tax_after_credits)"></div>
              </div>
              <div class="result-row">
                <div class="result-label">ì§€ë°©ì†Œë“ì„¸</div>
                <div class="result-value" x-text="formatKRW(outputs.local_income_tax)"></div>
              </div>

              <div class="result-row result-strong" style="border-top: 1px solid #cfe2ff;">
                <div class="result-label fw-semibold">ì´ ë‚©ë¶€ì„¸ì•¡(êµ­ì„¸+ì§€ë°©ì„¸)</div>
                <div class="result-value fw-semibold" x-text="formatKRW(outputs.total_tax_due)"></div>
              </div>

              <div class="result-row">
                <div class="result-label">ì°¨ê°ë‚©ë¶€(í™˜ê¸‰)ì„¸ì•¡</div>
                <div class="result-value" x-text="formatKRW(outputs.final_payable_or_refund)"></div>
              </div>

              <div class="result-row result-emph">
                <div class="result-label fw-semibold">ë‚©ë¶€í•  ì„¸ì•¡</div>
                <div class="result-value fw-semibold" :class="outputs.payable_amount>0 ? 'text-danger' : ''" x-text="formatKRW(outputs.payable_amount)"></div>
              </div>
              <div class="result-row result-emph">
                <div class="result-label fw-semibold">í™˜ê¸‰ ë°›ì„ ì„¸ì•¡</div>
                <div class="result-value fw-semibold" :class="outputs.refund_amount>0 ? 'text-success' : ''" x-text="formatKRW(outputs.refund_amount)"></div>
              </div>

              <div class="result-row">
                <div class="result-label">ì‹¤íš¨ì„¸ìœ¨(ì°¸ê³ )</div>
                <div class="result-value" x-text="formatPercent01(outputs.effective_tax_rate)"></div>
              </div>
            </div>

            <!-- Print summary (shows inputs as text) -->
            <div class="mt-3 border rounded p-3 print-only print-block">
              <div class="fw-semibold mb-2">ì…ë ¥ê°’(ì¸ì‡„ìš©)</div>
              <div class="row g-2">
                <div class="col-6"><span class="text-muted">ê·€ì†ì—°ë„</span> <span class="float-end" x-text="inputs.tax_year || '-' "></span></div>
                <div class="col-6"><span class="text-muted">ì‹ ê³ êµ¬ë¶„</span> <span class="float-end" x-text="inputs.filing_type || '-' "></span></div>
                <div class="col-6"><span class="text-muted">ê³¼ì„¸ëŒ€ìƒ ì†Œë“</span> <span class="float-end" x-text="formatKRW(inputs.taxable_income_base)"></span></div>
                <div class="col-6"><span class="text-muted">ì†Œë“ê³µì œ í•©ê³„</span> <span class="float-end" x-text="formatKRW(inputs.income_deduction_total)"></span></div>
                <div class="col-6"><span class="text-muted">ì„¸ì•¡ê³µì œ/ê°ë©´</span> <span class="float-end" x-text="formatKRW(inputs.tax_credit_total)"></span></div>
                <div class="col-6"><span class="text-muted">ê¸°ë‚©ë¶€ì„¸ì•¡</span> <span class="float-end" x-text="formatKRW(inputs.prepaid_tax)"></span></div>
                <div class="col-6"><span class="text-muted">ê¸°íƒ€ ì¡°ì •ê¸ˆì•¡</span> <span class="float-end" x-text="formatKRW(inputs.other_adjustment)"></span></div>
                <div class="col-6"><span class="text-muted">ì§€ë°©ì†Œë“ì„¸ ì ìš©</span> <span class="float-end" x-text="inputs.local_income_tax_apply ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'"></span></div>
              </div>
            </div>
          </div>

          <div class="col-lg-5">
            <div class="card shadow-sm">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">ê³„ì‚° ê·¼ê±°(ê°„ì´)</div>
                  <div class="no-print">
                    <button type="button" class="btn btn-sm btn-outline-secondary" @click="showTaxTable = !showTaxTable" x-text="showTaxTable ? 'ì„¸ìœ¨í‘œ ì ‘ê¸°' : 'ì„¸ìœ¨í‘œ ë³´ê¸°'"></button>
                  </div>
                </div>
                <ul class="mt-2 mb-0 help-text">
                  <li>ê³¼ì„¸í‘œì¤€ = max(ì†Œë“ - ì†Œë“ê³µì œ, 0)</li>
                  <li>ì‚°ì¶œì„¸ì•¡ = ê³¼ì„¸í‘œì¤€ Ã— ì„¸ìœ¨ âˆ’ ëˆ„ì§„ê³µì œ</li>
                  <li>ì¡°ì • í¬í•¨: ê³µì œ/ê°ë©´ ì „ ì„¸ì•¡ = ì‚°ì¶œì„¸ì•¡ + ê¸°íƒ€ì¡°ì •</li>
                  <li>ê³µì œ/ê°ë©´ í›„ ì„¸ì•¡ = max(ì¡°ì • í›„ âˆ’ ì„¸ì•¡ê³µì œ/ê°ë©´, 0)</li>
                  <li>ì§€ë°©ì†Œë“ì„¸ = (êµ­ì„¸) Ã— 10% (ì˜µì…˜)</li>
                </ul>

                <div class="mt-3 p-2 rounded" style="background:var(--soft)">
                  <div class="help-text">ì„¸ìœ¨í‘œ ê¸°ì¤€(2023~2025ë…„ ì¼ë°˜ ê³¼ì„¸í‘œì¤€ êµ¬ê°„ ì˜ˆì‹œ). ì‹¤ì œ ì ìš©ì€ ë²•ë ¹/ê·€ì†ì—°ë„ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                </div>

                <div class="mt-3">
                  <div class="fw-semibold">ì„¸ìœ¨í‘œ ê³„ì‚°(ëˆ„ì ì„¸ì•¡/ëˆ„ì§„ê³µì œ) ì˜ì—­</div>
                  <div class="help-text">ì…€ M5â€¦ í˜•íƒœë¥¼ ì›¹ì—ì„œ ì •ê·œí™”í•˜ì—¬ ê³„ì‚°í•©ë‹ˆë‹¤.</div>
                  <div class="mt-2 d-flex justify-content-between">
                    <div class="text-muted">ì°¸ì¡° ê°’</div>
                    <div class="fw-semibold" x-text="formatKRW(outputs.bracket_table_note)"></div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ì„¸ìœ¨í‘œ ì„¹ì…˜ -->
      <section class="mb-2" aria-labelledby="sec-tax" :class="{'page-break-before': true}">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h5 section-title mb-0" id="sec-tax">ëˆ„ì§„ì„¸ìœ¨í‘œ(ì°¸ì¡°)</h2>
          <div class="help-text no-print">ì½ê¸° ì „ìš©</div>
        </div>

        <div class="card shadow-sm" x-show="showTaxTable" x-collapse>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm table-bordered tax-table align-middle">
                <thead class="table-light">
                  <tr>
                    <th scope="col">êµ¬ê°„</th>
                    <th scope="col" class="text-end">ê³¼ì„¸í‘œì¤€ í•˜í•œ</th>
                    <th scope="col" class="text-end">ê³¼ì„¸í‘œì¤€ ìƒí•œ</th>
                    <th scope="col" class="text-end">ì„¸ìœ¨</th>
                    <th scope="col" class="text-end">ëˆ„ì§„ê³µì œ</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(b, idx) in taxTable" :key="idx">
                    <tr>
                      <td x-text="idx+1"></td>
                      <td class="text-end" x-text="formatKRW(b.min)"></td>
                      <td class="text-end" x-text="b.max===Infinity ? 'ë¬´í•œëŒ€' : formatKRW(b.max)"></td>
                      <td class="text-end" x-text="(b.rate*100).toFixed(1) + '%'"></td>
                      <td class="text-end" x-text="formatKRW(b.quickDeduction)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
            <div class="help-text">* ìœ„ êµ¬ê°„/ëˆ„ì§„ê³µì œëŠ” ì˜ˆì‹œê°’ì´ë©°, ì‚¬ìš©ìëŠ” ê·€ì†ì—°ë„ì— ë§ëŠ” ì„¸ìœ¨í‘œë¥¼ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.</div>
          </div>
        </div>

        <!-- Print: always show tax table on new page -->
        <div class="card shadow-sm print-only print-block">
          <div class="card-body">
            <div class="fw-semibold mb-2">ëˆ„ì§„ì„¸ìœ¨í‘œ(ì¸ì‡„ìš©)</div>
            <div class="table-responsive">
              <table class="table table-sm table-bordered tax-table align-middle">
                <thead class="table-light">
                  <tr>
                    <th scope="col">êµ¬ê°„</th>
                    <th scope="col" class="text-end">í•˜í•œ</th>
                    <th scope="col" class="text-end">ìƒí•œ</th>
                    <th scope="col" class="text-end">ì„¸ìœ¨</th>
                    <th scope="col" class="text-end">ëˆ„ì§„ê³µì œ</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(b, idx) in taxTable" :key="'p'+idx">
                    <tr>
                      <td x-text="idx+1"></td>
                      <td class="text-end" x-text="formatKRW(b.min)"></td>
                      <td class="text-end" x-text="b.max===Infinity ? 'ë¬´í•œëŒ€' : formatKRW(b.max)"></td>
                      <td class="text-end" x-text="(b.rate*100).toFixed(1) + '%'"></td>
                      <td class="text-end" x-text="formatKRW(b.quickDeduction)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </section>

      <footer class="mt-4 no-print">
        <div class="help-text">
          ì£¼ì˜: ë³¸ ê³„ì‚°ê¸°ëŠ” ê°„ì´ ì¶”ì •ìš©ì…ë‹ˆë‹¤. ì‹¤ì œ ì‹ ê³  ì‹œì—ëŠ” ì„¸ë²•/í™ˆíƒìŠ¤ ê³„ì‚° ê²°ê³¼ì™€ ë°˜ë“œì‹œ ëŒ€ì¡°í•˜ì„¸ìš”.
        </div>
      </footer>
    </main>
  </div>

  <script>
    // ===== Excel formula helper functions (from tool) =====
    function _sum(...args) {
      return args.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
    }
    function _sumRange(rangeData) {
      if (Array.isArray(rangeData)) {
        return rangeData.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
      }
      return parseFloat(rangeData) || 0;
    }
    function _average(...args) {
      const flat = args.flat().filter(x => x !== null && x !== '' && !isNaN(x));
      return flat.length ? _sum(...flat) / flat.length : 0;
    }
    function _averageRange(rangeData) {
      if (Array.isArray(rangeData)) {
        const flat = rangeData.flat().filter(x => x !== null && x !== '' && !isNaN(x));
        return flat.length ? _sumRange(flat) / flat.length : 0;
      }
      return parseFloat(rangeData) || 0;
    }
    function _count(...args) {
      return args.flat().filter(x => typeof x === 'number' && !isNaN(x)).length;
    }
    function _counta(...args) {
      return args.flat().filter(x => x !== null && x !== '' && x !== undefined).length;
    }
    function _and(...args) {
      return args.every(x => Boolean(x));
    }
    function _or(...args) {
      return args.some(x => Boolean(x));
    }
    function _round(num, digits = 0) {
      const factor = Math.pow(10, digits);
      return Math.round(num * factor) / factor;
    }
    function _roundUp(num, digits = 0) {
      const factor = Math.pow(10, digits);
      return Math.ceil(num * factor) / factor;
    }
    function _roundDown(num, digits = 0) {
      const factor = Math.pow(10, digits);
      return Math.floor(num * factor) / factor;
    }
    function _len(text) {
      return String(text).length;
    }
    function _left(text, numChars = 1) {
      return String(text).substring(0, numChars);
    }
    function _right(text, numChars = 1) {
      const str = String(text);
      return str.substring(str.length - numChars);
    }
    function _mid(text, startNum, numChars) {
      return String(text).substring(startNum - 1, startNum - 1 + numChars);
    }
    function _trim(text) {
      return String(text).trim();
    }
    function _upper(text) {
      return String(text).toUpperCase();
    }
    function _lower(text) {
      return String(text).toLowerCase();
    }
    function _concat(...args) {
      return args.join('');
    }
    function formatNumber(num, decimals = 0) {
      return new Intl.NumberFormat('ko-KR', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      }).format(num);
    }
    function formatCurrency(num) {
      return new Intl.NumberFormat('ko-KR', {
        style: 'currency',
        currency: 'KRW',
        maximumFractionDigits: 0
      }).format(num);
    }
    function formatPercent(num, decimals = 1) {
      return new Intl.NumberFormat('ko-KR', {
        style: 'percent',
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      }).format(num / 100);
    }

    // ===== App code =====
    function appData(){
      return {
        showTaxTable: true,
        debounceTimer: null,
        isValid: true,
        errors: {},

        // UI string models for money inputs (to allow commas)
        ui: {
          taxable_income_base: '0',
          income_deduction_total: '0',
          tax_credit_total: '0',
          prepaid_tax: '0',
          other_adjustment: '0',
        },

        // Inputs (numbers stored as Number)
        inputs: {
          tax_year: '',
          filing_type: '',
          taxable_income_base: 0,
          income_deduction_total: 0,
          tax_credit_total: 0,
          prepaid_tax: 0,
          local_income_tax_apply: true,
          spouse_deduction_apply: false,
          dependent_count: 0,
          other_adjustment: 0,
        },

        // Default progressive tax table (example)
        // ì‚°ì¶œì„¸ì•¡ = ê³¼ì„¸í‘œì¤€ * rate - quickDeduction
        taxTable: [
          { min: 0,        max: 14000000,  rate: 0.06,  quickDeduction: 0 },
          { min: 14000000, max: 50000000,  rate: 0.15,  quickDeduction: 1260000 },
          { min: 50000000, max: 88000000,  rate: 0.24,  quickDeduction: 5760000 },
          { min: 88000000, max: 150000000, rate: 0.35,  quickDeduction: 15440000 },
          { min: 150000000,max: 300000000, rate: 0.38,  quickDeduction: 19940000 },
          { min: 300000000,max: 500000000, rate: 0.40,  quickDeduction: 25940000 },
          { min: 500000000,max: 1000000000,rate: 0.42,  quickDeduction: 35940000 },
          { min: 1000000000,max: Infinity,  rate: 0.45,  quickDeduction: 65940000 },
        ],

        outputs: {
          taxable_income_base_echo: 0,
          tax_base: 0,
          progressive_tax: 0,
          tax_before_credits: 0,
          tax_after_credits: 0,
          local_income_tax: 0,
          total_tax_due: 0,
          final_payable_or_refund: 0,
          payable_amount: 0,
          refund_amount: 0,
          effective_tax_rate: 0,
          bracket_table_note: 0,
        },

        init(){
          // sync UI strings
          this.ui.taxable_income_base = this.formatPlain(this.inputs.taxable_income_base);
          this.ui.income_deduction_total = this.formatPlain(this.inputs.income_deduction_total);
          this.ui.tax_credit_total = this.formatPlain(this.inputs.tax_credit_total);
          this.ui.prepaid_tax = this.formatPlain(this.inputs.prepaid_tax);
          this.ui.other_adjustment = this.formatPlain(this.inputs.other_adjustment);

          this.calculateAll();

          window.addEventListener('afterprint', () => {
            document.body.classList.remove('print-mode');
          });
        },

        // Formatting
        formatPlain(n){
          const v = Number(n);
          return (isFinite(v) ? String(v) : '0');
        },
        formatKRW(value){
          const v = Number(value);
          const n = isFinite(v) ? v : 0;
          // show negative with minus sign
          return new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(n) + 'ì›';
        },
        formatPercent01(ratio){
          const v = Number(ratio);
          const n = isFinite(v) ? v : 0;
          return new Intl.NumberFormat('ko-KR', { style:'percent', minimumFractionDigits: 1, maximumFractionDigits: 2 }).format(n);
        },

        // Parsing money input (allow commas, optional negative)
        parseMoney(str, allowNegative=false){
          const raw = String(str ?? '').trim();
          if(raw === '') return 0;
          const cleaned = raw.replace(/,/g,'');
          const n = Number(cleaned);
          if(!isFinite(n)) return NaN;
          if(!allowNegative && n < 0) return NaN;
          return n;
        },

        // Validation
        validate(){
          const e = {};

          // tax_year optional but if entered must be 4 digits-ish
          if(String(this.inputs.tax_year).trim() !== ''){
            const y = Number(this.inputs.tax_year);
            if(!Number.isInteger(y) || y < 2000 || y > 2100) e.tax_year = 'ê·€ì†ì—°ë„ëŠ” 2000~2100 ë²”ìœ„ì˜ ì—°ë„ë¡œ ì…ë ¥í•˜ì„¸ìš”.';
          }

          if(String(this.inputs.filing_type).trim() === ''){
            e.filing_type = 'ì‹ ê³ êµ¬ë¶„ì„ ì„ íƒí•˜ì„¸ìš”.';
          }

          const nonNegFields = [
            ['taxable_income_base','ì¢…í•©ì†Œë“ê¸ˆì•¡'],
            ['income_deduction_total','ì†Œë“ê³µì œ í•©ê³„'],
            ['tax_credit_total','ì„¸ì•¡ê³µì œ/ê°ë©´ í•©ê³„'],
            ['prepaid_tax','ê¸°ë‚©ë¶€ì„¸ì•¡'],
          ];
          for(const [k, label] of nonNegFields){
            const v = this.inputs[k];
            if(!isFinite(v) || v < 0) e[k] = `${label}ì€(ëŠ”) 0 ì´ìƒ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.`;
          }

          if(!Number.isInteger(Number(this.inputs.dependent_count)) || Number(this.inputs.dependent_count) < 0){
            e.dependent_count = 'ë¶€ì–‘ê°€ì¡± ìˆ˜ëŠ” 0 ì´ìƒì˜ ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.';
          }

          if(!isFinite(this.inputs.other_adjustment)){
            e.other_adjustment = 'ê¸°íƒ€ ì¡°ì •ê¸ˆì•¡ì´ ì˜¬ë°”ë¥¸ ìˆ«ìê°€ ì•„ë‹™ë‹ˆë‹¤.';
          }

          this.errors = e;
          this.isValid = Object.keys(e).length === 0;
          return this.isValid;
        },

        // Debounced calculation trigger
        onAnyInput(){
          this.scheduleCalc();
        },

        onMoneyInput(field, allowNegative=false){
          const parsed = this.parseMoney(this.ui[field], allowNegative);
          if(!isFinite(parsed)){
            // keep previous numeric value; mark invalid via validate()
          }else{
            this.inputs[field] = parsed;
          }
          this.scheduleCalc();
        },

        scheduleCalc(){
          if(this.debounceTimer) clearTimeout(this.debounceTimer);
          this.debounceTimer = setTimeout(() => {
            this.calculateAll();
          }, 150);
        },

        safeDivide(numerator, denominator, defaultValue=0){
          const n = Number(numerator);
          const d = Number(denominator);
          if(!isFinite(n) || !isFinite(d) || d === 0) return defaultValue;
          return n / d;
        },

        // ===== Core computations =====
        // Excel C14 ì¶”ì •: =MAX(C10-C11,0) (converted: Math.max(data['C10']-data['C11'],0))
        computeTaxBase(taxableIncomeBase, incomeDeductionTotal){
          return Math.max(Number(taxableIncomeBase||0) - Number(incomeDeductionTotal||0), 0);
        },

        computeProgressiveTax(taxBase, taxTable){
          const base = Math.max(Number(taxBase||0), 0);
          const bracket = (taxTable || []).find(b => base >= b.min && base < b.max) || (taxTable || [])[taxTable.length-1];
          if(!bracket) return 0;
          const tax = base * bracket.rate - bracket.quickDeduction;
          return Math.max(Math.floor(tax), 0); // match typical Excel integer KRW behavior
        },

        // Excel C20 ì¶”ì •: =IF(K10=1,C19*0.1,0)
        // Tool output had assignment bug; fixed to comparison.
        computeLocalIncomeTax(nationalTaxAfterCredits, applyLocalTax){
          const nat = Math.max(Number(nationalTaxAfterCredits||0), 0);
          return applyLocalTax ? Math.floor(nat * 0.1) : 0;
        },

        // M5.. style cumulative note (for reference only)
        computeBracketTableNote(){
          // Using the first bracket's formula sample: M5 = K5*L5-K5*L4
          // In our normalized table, we expose a single representative reference value:
          // "ì²« êµ¬ê°„ ìƒí•œ * ì²« êµ¬ê°„ ì„¸ìœ¨" (ëˆ„ì ì„¸ì•¡ì˜ ì‹œì‘ê°’ì— ê°€ê¹Œì›€)
          const first = this.taxTable[0];
          const second = this.taxTable[1];
          const K5 = first.max;
          const L5 = first.rate;
          const L4 = 0;
          const m5 = K5 * L5 - K5 * L4;
          // show as integer KRW
          return Math.floor(m5);
        },

        calculateAll(){
          // validate first
          this.validate();

          // echo
          this.outputs.taxable_income_base_echo = Number(this.inputs.taxable_income_base||0);

          // (1) tax base
          const taxBase = this.computeTaxBase(this.inputs.taxable_income_base, this.inputs.income_deduction_total);

          // (2) progressive tax
          const progressiveTax = this.computeProgressiveTax(taxBase, this.taxTable);

          // (3) before credits (adjustment included)
          const beforeCredits = Math.floor(Number(progressiveTax||0) + Number(this.inputs.other_adjustment||0));

          // (4) after credits (non-negative)
          const afterCredits = Math.max(Math.floor(beforeCredits - Number(this.inputs.tax_credit_total||0)), 0);

          // (5) local income tax
          const localTax = this.computeLocalIncomeTax(afterCredits, !!this.inputs.local_income_tax_apply);

          // (6) total due
          const totalDue = Math.max(Math.floor(afterCredits + localTax), 0);

          // (7) final payable or refund
          const finalPOR = Math.floor(totalDue - Number(this.inputs.prepaid_tax||0));

          // (8) split payable/refund
          const payable = Math.max(finalPOR, 0);
          const refund = Math.max(-finalPOR, 0);

          // (9) effective tax rate (totalDue / taxable_income_base)
          const effRate = this.safeDivide(totalDue, Number(this.inputs.taxable_income_base||0), 0);

          this.outputs.tax_base = taxBase;
          this.outputs.progressive_tax = progressiveTax;
          this.outputs.tax_before_credits = beforeCredits;
          this.outputs.tax_after_credits = afterCredits;
          this.outputs.local_income_tax = localTax;
          this.outputs.total_tax_due = totalDue;
          this.outputs.final_payable_or_refund = finalPOR;
          this.outputs.payable_amount = payable;
          this.outputs.refund_amount = refund;
          this.outputs.effective_tax_rate = effRate;
          this.outputs.bracket_table_note = this.computeBracketTableNote();
        },

        resetAll(){
          this.inputs = {
            tax_year: '',
            filing_type: '',
            taxable_income_base: 0,
            income_deduction_total: 0,
            tax_credit_total: 0,
            prepaid_tax: 0,
            local_income_tax_apply: true,
            spouse_deduction_apply: false,
            dependent_count: 0,
            other_adjustment: 0,
          };
          this.ui = {
            taxable_income_base: '0',
            income_deduction_total: '0',
            tax_credit_total: '0',
            prepaid_tax: '0',
            other_adjustment: '0',
          };
          this.errors = {};
          this.isValid = true;
          this.calculateAll();
        },

        printReport(){
          document.body.classList.add('print-mode');
          // ensure print-only table exists; open table section in UI too
          this.showTaxTable = true;
          setTimeout(() => window.print(), 50);
        },
      }
    }
  </script>

<!-- í•´ì»¤í†¤ ì„ ì • ì •ë³´ -->
<div id="selection-banner" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 14px;
    z-index: 10000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
">
    <div>
        <strong>ğŸ“Š ì¢…í•©ì†Œë“ì„¸ ê³„ì‚°ê¸°</strong>
        <span style="margin-left: 10px; opacity: 0.9;">| ì„¸ê¸ˆê³„ì‚°</span>
    </div>
    <div style="display: flex; align-items: center; gap: 15px;">
        <span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 12px;">
            24ê°œ ìˆ˜ì‹
        </span>
        <button onclick="document.getElementById('selection-info').style.display='block'"
                style="background: white; color: #667eea; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 500;">
            ì„ ì • ì´ìœ  ë³´ê¸°
        </button>
    </div>
</div>

<div id="selection-info" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 10001;
    display: none;
    justify-content: center;
    align-items: center;
" onclick="this.style.display='none'">
    <div style="
        background: white;
        padding: 30px;
        border-radius: 16px;
        max-width: 500px;
        margin: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    " onclick="event.stopPropagation()">
        <h2 style="margin: 0 0 15px; color: #333;">ğŸ† í•´ì»¤í†¤ ì„ ì • ì´ìœ </h2>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <strong style="color: #667eea;">ì„¸ê¸ˆê³„ì‚°</strong>
            <p style="margin: 10px 0 0; color: #555; line-height: 1.6;">ì„¸ê¸ˆ ê³„ì‚° ë¡œì§ â†’ JS í•¨ìˆ˜ ë³€í™˜ - ì‹¤ìš©ì  ë¹„ì¦ˆë‹ˆìŠ¤ ê°€ì¹˜</p>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <span style="background: #e3e8ff; color: #4c5fd5; padding: 4px 10px; border-radius: 12px; font-size: 12px;">VLOOKUP</span><span style="background: #e3e8ff; color: #4c5fd5; padding: 4px 10px; border-radius: 12px; font-size: 12px;">IFERROR</span><span style="background: #e3e8ff; color: #4c5fd5; padding: 4px 10px; border-radius: 12px; font-size: 12px;">MAX</span><span style="background: #e3e8ff; color: #4c5fd5; padding: 4px 10px; border-radius: 12px; font-size: 12px;">SUM</span>
        </div>
        <button onclick="document.getElementById('selection-info').style.display='none'"
                style="margin-top: 20px; width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
            ë‹«ê¸°
        </button>
    </div>
</div>

<style>
body { padding-top: 56px !important; }
</style>
</body>
</html>
