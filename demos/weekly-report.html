<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>주간업무보고 작성/출력</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    :root{
      --font-sans: "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      --excel-line: #2f2f2f;
      --excel-light-line: #8a8a8a;
      --excel-header-bg: #f2f2f2;
      --sheet-bg: #ffffff;
      --screen-bg: #f6f7fb;
      --muted: #6c757d;
    }

    html, body { height: 100%; }
    body{
      font-family: var(--font-sans);
      background: var(--screen-bg);
      color: #111;
    }

    .app-toolbar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid #e5e7eb;
    }

    .card-soft{
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.04);
      background: #fff;
    }

    .help-text{ font-size: .875rem; color: var(--muted); }

    .preview-wrap{
      background: transparent;
    }

    /* A4 landscape preview sizing (screen only) */
    .a4-landscape-frame{
      background: var(--sheet-bg);
      border: 1px solid #d0d5dd;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      padding: 10mm;
      width: 100%;
      max-width: 1120px; /* visually close to A4 landscape on typical screens */
      margin: 0 auto;
    }

    /* Excel-like table */
    .report-sheet{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      background: #fff;
    }

    .report-sheet td, .report-sheet th{
      border: 1px solid var(--excel-line);
      padding: 6px 8px;
      vertical-align: top;
      font-size: 11pt;
      line-height: 1.35;
      word-break: break-word;
    }

    .report-sheet .thin td, .report-sheet .thin th{
      border-color: var(--excel-light-line);
    }

    .report-title{
      font-weight: 800;
      font-size: 16pt;
      text-align: center;
      letter-spacing: 0.02em;
      padding: 10px 8px !important;
    }

    .section-h{
      background: var(--excel-header-bg);
      font-weight: 700;
      width: 22%;
      white-space: nowrap;
    }

    .meta-label{ background: var(--excel-header-bg); font-weight: 700; white-space: nowrap; }

    .prewrap{ white-space: pre-wrap; }

    .box-lg{ min-height: 70mm; }
    .box-md{ min-height: 40mm; }
    .box-sm{ min-height: 22mm; }

    .error-box{
      border: 1px solid #fecaca;
      background: #fff1f2;
      color: #7f1d1d;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: .95rem;
    }

    .required::after{ content: " *"; color: #dc3545; font-weight: 700; }

    /* Print */
    @page { size: A4 landscape; margin: 19mm 6mm; }

    @media print{
      body{ background: #fff !important; }
      .no-print{ display: none !important; }

      /* show only print area */
      body *{ visibility: hidden; }
      #print-area, #print-area *{ visibility: visible; }
      #print-area{ position: absolute; left: 0; top: 0; width: 100%; }

      .a4-landscape-frame{
        box-shadow: none !important;
        border: none !important;
        border-radius: 0 !important;
        padding: 0 !important;
        max-width: none !important;
        margin: 0 !important;
      }

      .report-sheet td, .report-sheet th{
        font-size: 10.5pt;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .section-h, .meta-label{ background: var(--excel-header-bg) !important; }
    }
  </style>
</head>

<body>
  <header class="app-toolbar no-print">
    <div class="container py-3" x-data>
      <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
        <div>
          <div class="fw-bold">주간업무보고 작성/출력</div>
          <div class="help-text">작성 → 미리보기 확인 → 인쇄(또는 PDF로 저장)</div>
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary" @click="$dispatch('draft-save')">임시저장</button>
          <button type="button" class="btn btn-outline-secondary" @click="$dispatch('draft-load')">불러오기</button>
          <button type="button" class="btn btn-primary" @click="$dispatch('do-print')">인쇄</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container py-4" x-data="appData()" x-init="init()" @draft-save.window="saveDraft()" @draft-load.window="loadDraft()" @do-print.window="handlePrint()">
    <div class="row g-3">
      <!-- 입력 폼 -->
      <div class="col-12 col-lg-5 no-print">
        <div class="card-soft p-3 p-md-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h2 class="h5 mb-0">입력</h2>
            <div class="help-text">* 표시는 권장 필수값</div>
          </div>

          <div class="mb-3" aria-live="polite">
            <template x-if="errors.length">
              <div class="error-box" role="status" aria-live="polite">
                <div class="fw-bold mb-1">확인 필요</div>
                <ul class="mb-0 ps-3">
                  <template x-for="(e, idx) in errors" :key="idx">
                    <li x-text="e"></li>
                  </template>
                </ul>
              </div>
            </template>
          </div>

          <form @submit.prevent="handlePrint()" novalidate>
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label required" for="report_title">보고서 제목</label>
                <input id="report_title" type="text" class="form-control" x-model.trim="form.report_title" aria-required="true" @input="onChange()" maxlength="60" placeholder="예) 주간업무보고" />
              </div>

              <div class="col-12">
                <label class="form-label required" for="report_week_range">보고 주간(기간)</label>
                <input id="report_week_range" type="text" class="form-control" x-model.trim="form.report_week_range" aria-required="true" @input="onChange()" maxlength="60" placeholder="예) 2025.01.01 ~ 2025.01.05" />
              </div>

              <div class="col-md-6">
                <label class="form-label" for="department">부서</label>
                <input id="department" type="text" class="form-control" x-model.trim="form.department" @input="onChange()" maxlength="40" placeholder="예) 개발팀" />
              </div>

              <div class="col-md-6">
                <label class="form-label required" for="name">작성자</label>
                <input id="name" type="text" class="form-control" x-model.trim="form.name" aria-required="true" @input="onChange()" maxlength="30" placeholder="예) 홍길동" />
              </div>

              <div class="col-md-6">
                <label class="form-label" for="position">직위/직급</label>
                <input id="position" type="text" class="form-control" x-model.trim="form.position" @input="onChange()" maxlength="30" placeholder="예) 선임/대리" />
              </div>

              <div class="col-md-6">
                <label class="form-label required" for="report_date">작성일</label>
                <input id="report_date" type="date" class="form-control" x-model="form.report_date" aria-required="true" @input="onChange()" />
              </div>

              <div class="col-12">
                <label class="form-label" for="summary">금주 업무 요약</label>
                <textarea id="summary" class="form-control" rows="3" x-model.trim="form.summary" @input="onChange()" maxlength="1200" placeholder="핵심 성과/진행사항 요약"></textarea>
                <div class="help-text">줄바꿈은 인쇄 시 그대로 반영됩니다.</div>
              </div>

              <div class="col-12">
                <label class="form-label" for="this_week_tasks">금주 업무 내역(업무/진행상태/이슈)</label>
                <textarea id="this_week_tasks" class="form-control" rows="8" x-model.trim="form.this_week_tasks" @input="onChange()" maxlength="6000" placeholder="- 업무1: 진행률/이슈\n- 업무2: ..."></textarea>
              </div>

              <div class="col-12">
                <label class="form-label" for="next_week_plan">차주 계획</label>
                <textarea id="next_week_plan" class="form-control" rows="5" x-model.trim="form.next_week_plan" @input="onChange()" maxlength="4000"></textarea>
              </div>

              <div class="col-12">
                <label class="form-label" for="issues_support">이슈/지원 요청</label>
                <textarea id="issues_support" class="form-control" rows="4" x-model.trim="form.issues_support" @input="onChange()" maxlength="4000"></textarea>
              </div>

              <div class="col-12">
                <label class="form-label" for="manager_comment">검토/코멘트(관리자)</label>
                <textarea id="manager_comment" class="form-control" rows="4" x-model.trim="form.manager_comment" @input="onChange()" maxlength="4000"></textarea>
              </div>

              <div class="col-12 d-flex flex-wrap gap-2 pt-2">
                <button type="button" class="btn btn-outline-secondary" @click="saveDraft()">임시저장</button>
                <button type="button" class="btn btn-outline-secondary" @click="loadDraft()">불러오기</button>
                <button type="submit" class="btn btn-primary">인쇄</button>
                <button type="button" class="btn btn-link" @click="exportToPdfHint('default')">PDF로 저장 안내</button>
              </div>
            </div>
          </form>

          <hr class="my-4" />
          <div class="help-text">
            <div class="fw-semibold mb-1">인쇄/저장 팁</div>
            <ul class="mb-0 ps-3">
              <li>브라우저 인쇄에서 <span class="fw-semibold">대상: PDF로 저장</span>을 선택하면 PDF로 저장할 수 있습니다.</li>
              <li>배경 그래픽 옵션은 필요 시 켜세요(헤더 음영 유지).</li>
              <li>인쇄는 미리보기 영역만 출력됩니다.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- 미리보기 -->
      <div class="col-12 col-lg-7">
        <div class="preview-wrap">
          <div class="d-flex align-items-center justify-content-between mb-2 no-print">
            <h2 class="h5 mb-0">인쇄 미리보기</h2>
            <div class="help-text">A4 가로 기준</div>
          </div>

          <section id="print-area">
            <div class="a4-landscape-frame">
              <!-- template is injected here (no unsanitized HTML) -->
              <div x-ref="previewRoot"></div>
            </div>
          </section>

          <div class="mt-2 no-print help-text">미리보기는 입력 변경 시 자동 반영됩니다.</div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ===== Excel formula helper functions (included per requirement) =====
    function _sum(...args) {
        return args.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
    }

    function _sumRange(rangeData) {
        if (Array.isArray(rangeData)) {
            return rangeData.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
        }
        return parseFloat(rangeData) || 0;
    }

    function _average(...args) {
        const flat = args.flat().filter(x => x !== null && x !== '' && !isNaN(x));
        return flat.length ? _sum(...flat) / flat.length : 0;
    }

    function _averageRange(rangeData) {
        if (Array.isArray(rangeData)) {
            const flat = rangeData.flat().filter(x => x !== null && x !== '' && !isNaN(x));
            return flat.length ? _sumRange(flat) / flat.length : 0;
        }
        return parseFloat(rangeData) || 0;
    }

    function _count(...args) {
        return args.flat().filter(x => typeof x === 'number' && !isNaN(x)).length;
    }

    function _counta(...args) {
        return args.flat().filter(x => x !== null && x !== '' && x !== undefined).length;
    }

    function _and(...args) {
        return args.every(x => Boolean(x));
    }

    function _or(...args) {
        return args.some(x => Boolean(x));
    }

    function _round(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.round(num * factor) / factor;
    }

    function _roundUp(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.ceil(num * factor) / factor;
    }

    function _roundDown(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.floor(num * factor) / factor;
    }

    function _len(text) {
        return String(text).length;
    }

    function _left(text, numChars = 1) {
        return String(text).substring(0, numChars);
    }

    function _right(text, numChars = 1) {
        const str = String(text);
        return str.substring(str.length - numChars);
    }

    function _mid(text, startNum, numChars) {
        return String(text).substring(startNum - 1, startNum - 1 + numChars);
    }

    function _trim(text) {
        return String(text).trim();
    }

    function _upper(text) {
        return String(text).toUpperCase();
    }

    function _lower(text) {
        return String(text).toLowerCase();
    }

    function _concat(...args) {
        return args.join('');
    }

    function formatNumber(num, decimals = 0) {
        return new Intl.NumberFormat('ko-KR', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(num);
    }

    function formatCurrency(num) {
        return new Intl.NumberFormat('ko-KR', {
            style: 'currency',
            currency: 'KRW',
            maximumFractionDigits: 0
        }).format(num);
    }

    function formatPercent(num, decimals = 1) {
        return new Intl.NumberFormat('ko-KR', {
            style: 'percent',
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(num / 100);
    }

    // ===== App Logic (no Excel formulas in this template) =====

    const DRAFT_KEY_DEFAULT = 'weekly_report_draft_v1';

    function escapeText(value){
      // For safety: we do not inject innerHTML; still keep a safe string helper.
      const s = String(value ?? '');
      return s;
    }

    function formatDateKorean(isoDate){
      if(!isoDate) return '';
      // isoDate = YYYY-MM-DD
      const d = new Date(isoDate + 'T00:00:00');
      if(Number.isNaN(d.getTime())) return '';
      return new Intl.DateTimeFormat('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' }).format(d);
    }

    function buildReportDOM(form){
      // Create DOM nodes to avoid XSS (no user-provided HTML).
      const table = document.createElement('table');
      table.className = 'report-sheet';

      const tbody = document.createElement('tbody');

      // Row: Title
      {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.className = 'report-title';
        td.textContent = escapeText(form.report_title || '주간업무보고');
        tr.appendChild(td);
        tbody.appendChild(tr);
      }

      // Meta row 1
      {
        const tr = document.createElement('tr');

        const td1 = document.createElement('td'); td1.className = 'meta-label'; td1.textContent = '보고 주간(기간)';
        const td2 = document.createElement('td'); td2.colSpan = 2; td2.textContent = escapeText(form.report_week_range);

        const td3 = document.createElement('td'); td3.className = 'meta-label'; td3.textContent = '작성일';
        const td4 = document.createElement('td'); td4.colSpan = 2; td4.textContent = formatDateKorean(form.report_date);

        tr.append(td1, td2, td3, td4);
        tbody.appendChild(tr);
      }

      // Meta row 2
      {
        const tr = document.createElement('tr');

        const td1 = document.createElement('td'); td1.className = 'meta-label'; td1.textContent = '부서';
        const td2 = document.createElement('td'); td2.colSpan = 2; td2.textContent = escapeText(form.department);

        const td3 = document.createElement('td'); td3.className = 'meta-label'; td3.textContent = '작성자 / 직위';
        const td4 = document.createElement('td'); td4.colSpan = 2;
        td4.textContent = [form.name, form.position].filter(Boolean).map(escapeText).join(' / ');

        tr.append(td1, td2, td3, td4);
        tbody.appendChild(tr);
      }

      // Section: Summary
      {
        const tr = document.createElement('tr');
        const th = document.createElement('td'); th.className = 'section-h'; th.textContent = '금주 업무 요약';
        const td = document.createElement('td'); td.colSpan = 5; td.className = 'prewrap box-sm'; td.textContent = escapeText(form.summary);
        tr.append(th, td);
        tbody.appendChild(tr);
      }

      // Section: This week tasks
      {
        const tr = document.createElement('tr');
        const th = document.createElement('td'); th.className = 'section-h'; th.textContent = '금주 업무 내역\n(업무/진행상태/이슈)';
        const td = document.createElement('td'); td.colSpan = 5; td.className = 'prewrap box-lg'; td.textContent = escapeText(form.this_week_tasks);
        tr.append(th, td);
        tbody.appendChild(tr);
      }

      // Section: Next week plan
      {
        const tr = document.createElement('tr');
        const th = document.createElement('td'); th.className = 'section-h'; th.textContent = '차주 계획';
        const td = document.createElement('td'); td.colSpan = 5; td.className = 'prewrap box-md'; td.textContent = escapeText(form.next_week_plan);
        tr.append(th, td);
        tbody.appendChild(tr);
      }

      // Section: Issues/support
      {
        const tr = document.createElement('tr');
        const th = document.createElement('td'); th.className = 'section-h'; th.textContent = '이슈/지원 요청';
        const td = document.createElement('td'); td.colSpan = 5; td.className = 'prewrap box-md'; td.textContent = escapeText(form.issues_support);
        tr.append(th, td);
        tbody.appendChild(tr);
      }

      // Section: Manager comment
      {
        const tr = document.createElement('tr');
        const th = document.createElement('td'); th.className = 'section-h'; th.textContent = '검토/코멘트\n(관리자)';
        const td = document.createElement('td'); td.colSpan = 5; td.className = 'prewrap box-sm'; td.textContent = escapeText(form.manager_comment);
        tr.append(th, td);
        tbody.appendChild(tr);
      }

      table.appendChild(tbody);
      return table;
    }

    function appData(){
      return {
        draftKey: DRAFT_KEY_DEFAULT,
        errors: [],
        form: {
          // Cell mapping (reference):
          // report_title -> B2
          // report_week_range -> B3
          // department -> B4
          // name -> H4
          // position -> N4
          // report_date(작성일) -> T4
          // summary -> B6
          // this_week_tasks -> B8
          // next_week_plan -> B18
          // issues_support -> B24
          // manager_comment -> B28
          report_title: '주간업무보고',
          report_week_range: '',
          department: '',
          name: '',
          position: '',
          report_date: '',
          summary: '',
          this_week_tasks: '',
          next_week_plan: '',
          issues_support: '',
          manager_comment: ''
        },

        init(){
          // initial render
          this.renderPreview(this.form);
          // best-effort auto-load if exists (non-intrusive): do not overwrite if already typed
          try{
            const raw = localStorage.getItem(this.draftKey);
            if(raw){
              const saved = JSON.parse(raw);
              if(saved && typeof saved === 'object'){
                // only fill fields that are empty
                for(const k of Object.keys(this.form)){
                  if((this.form[k] === '' || this.form[k] == null) && (saved[k] !== undefined)) this.form[k] = saved[k];
                }
              }
              this.onChange();
            }
          }catch(e){
            // ignore
          }
        },

        onChange(){
          this.errors = this.validateForm(this.form);
          this.renderPreview(this.form);
        },

        // renderPreview(formState): bind inputs to print template
        renderPreview(formState){
          const root = this.$refs.previewRoot;
          if(!root) return;
          root.innerHTML = ''; // safe because we append trusted DOM we created
          root.appendChild(buildReportDOM(formState));
        },

        // validateForm(formState): required/length/date format
        validateForm(formState){
          const errs = [];

          const title = (formState.report_title || '').trim();
          const week = (formState.report_week_range || '').trim();
          const name = (formState.name || '').trim();
          const date = (formState.report_date || '').trim();

          if(!title) errs.push('보고서 제목을 입력해 주세요.');
          if(title.length > 60) errs.push('보고서 제목은 60자 이내로 입력해 주세요.');

          if(!week) errs.push('보고 주간(기간)을 입력해 주세요.');
          if(week.length > 60) errs.push('보고 주간(기간)은 60자 이내로 입력해 주세요.');

          if(!name) errs.push('작성자를 입력해 주세요.');
          if(name.length > 30) errs.push('작성자는 30자 이내로 입력해 주세요.');

          if(!date) {
            errs.push('작성일을 선택해 주세요.');
          } else {
            const d = new Date(date + 'T00:00:00');
            if(Number.isNaN(d.getTime())) errs.push('작성일 형식이 올바르지 않습니다.');
          }

          // Soft limits for long text (already limited by maxlength; keep defensive)
          if((formState.summary || '').length > 1200) errs.push('금주 업무 요약이 너무 깁니다(1200자 이내).');
          if((formState.this_week_tasks || '').length > 6000) errs.push('금주 업무 내역이 너무 깁니다(6000자 이내).');
          if((formState.next_week_plan || '').length > 4000) errs.push('차주 계획이 너무 깁니다(4000자 이내).');
          if((formState.issues_support || '').length > 4000) errs.push('이슈/지원 요청이 너무 깁니다(4000자 이내).');
          if((formState.manager_comment || '').length > 4000) errs.push('검토/코멘트가 너무 깁니다(4000자 이내).');

          return errs;
        },

        // handlePrint(): apply print CSS and print dialog
        handlePrint(){
          this.errors = this.validateForm(this.form);
          this.renderPreview(this.form);
          if(this.errors.length){
            // focus first invalid-ish field for usability
            const first = document.querySelector('.no-print [aria-required="true"]');
            if(first) first.focus();
            return;
          }
          window.print();
        },

        // exportToPdfHint(mode): 안내/확장 포인트
        exportToPdfHint(mode='default'){
          const msg =
            'PDF로 저장하려면:\n' +
            '1) [인쇄] 클릭\n' +
            '2) 프린터 대상에서 [PDF로 저장] 선택\n' +
            '3) 용지: A4, 방향: 가로(landscape) 확인\n\n' +
            '확장 포인트: 필요 시 html2pdf 등 라이브러리를 연동할 수 있습니다.';
          alert(msg);
        },

        // saveDraftToLocalStorage(formState, key)
        saveDraftToLocalStorage(formState, key){
          const payload = {
            ...formState,
            _savedAt: new Date().toISOString()
          };
          localStorage.setItem(key, JSON.stringify(payload));
          return true;
        },

        // loadDraftFromLocalStorage(key)
        loadDraftFromLocalStorage(key){
          const raw = localStorage.getItem(key);
          if(!raw) return null;
          return JSON.parse(raw);
        },

        saveDraft(){
          try{
            this.saveDraftToLocalStorage(this.form, this.draftKey);
            alert('임시저장되었습니다. (이 브라우저에 저장됨)');
          }catch(e){
            alert('임시저장에 실패했습니다. 브라우저 저장공간/권한을 확인해 주세요.');
          }
        },

        loadDraft(){
          try{
            const data = this.loadDraftFromLocalStorage(this.draftKey);
            if(!data){
              alert('저장된 임시 데이터가 없습니다.');
              return;
            }
            // Keep schema stable
            for(const k of Object.keys(this.form)){
              if(data[k] !== undefined) this.form[k] = data[k];
            }
            this.onChange();
            alert('임시 데이터를 불러왔습니다.');
          }catch(e){
            alert('불러오기에 실패했습니다. 저장된 데이터 형식을 확인해 주세요.');
          }
        }
      }
    }
  </script>
</body>
</html>
