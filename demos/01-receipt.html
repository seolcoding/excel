<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê°„ì´ì˜ìˆ˜ì¦ í‘œì¤€ ì–‘ì‹</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    :root{
      --font-sans: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      --excel-border: #2f2f2f;
      --excel-grid: #c9c9c9;
      --paper-bg: #fff;
      --preview-shadow: 0 2px 16px rgba(0,0,0,.08);
    }

    html, body { height: 100%; }
    body{
      font-family: var(--font-sans);
      background: #f6f7f9;
      color:#111;
    }

    .app-title{ font-weight: 800; letter-spacing: -0.02em; }

    .panel{
      background:#fff;
      border:1px solid #e6e8ee;
      border-radius: 12px;
      box-shadow: 0 1px 8px rgba(0,0,0,.04);
    }

    .form-label{ font-weight: 600; }

    .table thead th{
      font-size: .9rem;
      white-space: nowrap;
    }

    .num{
      text-align:right;
      font-variant-numeric: tabular-nums;
    }

    .muted{ color:#6b7280; }

    /* Preview = print area sizing (A4 landscape 297mm x 210mm) minus margins */
    .preview-wrap{
      background: var(--paper-bg);
      border: 1px solid #d8dde6;
      border-radius: 10px;
      box-shadow: var(--preview-shadow);
      padding: 10mm;
      /* visible preview width close to printable width */
      width: calc(297mm - 18mm - 18mm);
      min-height: calc(210mm - 19mm - 19mm);
      max-width: 100%;
      overflow: hidden;
    }

    .receipt-sheet{
      width: 100%;
      border: 2px solid var(--excel-border);
      padding: 6mm;
    }

    .receipt-header{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 4mm;
    }

    .receipt-title{
      font-weight: 900;
      font-size: 22px;
      letter-spacing: -0.03em;
    }

    .receipt-meta{
      font-size: 13px;
      line-height: 1.35;
    }

    .receipt-grid{
      width:100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .receipt-grid th, .receipt-grid td{
      border: 1px solid var(--excel-grid);
      padding: 6px 8px;
      vertical-align: middle;
    }
    .receipt-grid th{ background: #fafafa; font-weight: 800; }

    .receipt-grid .w-qty{ width: 14%; }
    .receipt-grid .w-unit{ width: 22%; }
    .receipt-grid .w-amt{ width: 22%; }
    .receipt-grid .w-tax{ width: 22%; }

    .receipt-footer{
      margin-top: 4mm;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8mm;
      font-size: 13px;
    }

    .receipt-box{
      border: 1px solid var(--excel-grid);
      padding: 8px;
      min-height: 42px;
    }

    .sr-live{ min-height: 1.2em; }

    /* keep focus ring */
    :focus-visible{ outline: 3px solid rgba(13,110,253,.35); outline-offset: 2px; }

    @media print {
      @page {
        size: A4 landscape;
        margin: 19mm 18mm 19mm 18mm;
      }

      body{ background:#fff !important; }

      #appHeader, #controls, #inputArea { display:none !important; }

      #printArea {
        display:block !important;
      }

      .preview-wrap{
        box-shadow:none !important;
        border:none !important;
        border-radius: 0 !important;
        padding: 0 !important;
        width: auto !important;
        min-height: auto !important;
      }

      .receipt-sheet{
        border: 2px solid #000;
      }

      a[href]:after{ content: ""; }
    }
  </style>
</head>
<body>
  <header id="appHeader" class="container py-4">
    <div class="d-flex flex-wrap gap-2 align-items-end justify-content-between">
      <div>
        <h1 class="h3 mb-1 app-title">ê°„ì´ì˜ìˆ˜ì¦ í‘œì¤€ ì–‘ì‹</h1>
        <div class="muted">ê±°ë˜ì²˜ ì„ íƒ/ì…ë ¥, í’ˆëª©Â·ìˆ˜ëŸ‰Â·ë‹¨ê°€ ì…ë ¥ìœ¼ë¡œ ê°„ì´ì˜ìˆ˜ì¦ì„ ìë™ ê³„ì‚°í•˜ê³  A4 ê°€ë¡œ ì¸ì‡„ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</div>
      </div>
      <div id="controls" class="d-flex gap-2">
        <button type="button" class="btn btn-outline-secondary" @click="resetAll()">ì´ˆê¸°í™”</button>
        <button type="button" class="btn btn-primary" @click="printReceipt()">ì¸ì‡„</button>
      </div>
    </div>
  </header>

  <main class="container pb-4" x-data="appData()" x-init="init()">
    <div class="row g-3">
      <!-- Input area -->
      <section id="inputArea" class="col-12 col-lg-6">
        <div class="panel p-3 p-md-4">
          <h2 class="h5 mb-3">ê¸°ë³¸ ì •ë³´</h2>

          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label" for="customer_code">ê±°ë˜ì²˜ ì½”ë“œ</label>
              <select id="customer_code" class="form-select" aria-label="ê±°ë˜ì²˜ ì½”ë“œ" x-model="form.customer_code" @change="calculateReceipt()" :disabled="form.manual_mode_enabled">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <template x-for="opt in customerOptions" :key="opt.code">
                  <option :value="opt.code" x-text="opt.code + ' - ' + opt.name"></option>
                </template>
              </select>
              <div class="form-text">ì„ íƒ ì‹œ ê±°ë˜ì²˜ëª…ì´ ìë™ ì¡°íšŒë©ë‹ˆë‹¤.</div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="receipt_date">ì‘ì„±ì¼ì</label>
              <input id="receipt_date" type="date" class="form-control" x-model="form.receipt_date" @input="calculateReceipt()" required :disabled="form.manual_mode_enabled" />
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="receipt_no">ì˜ìˆ˜ì¦ ë²ˆí˜¸</label>
              <input id="receipt_no" type="text" class="form-control" x-model.trim="form.receipt_no" @input="calculateReceipt()" maxlength="30" placeholder="ì˜ˆ: 2025-0001" :disabled="form.manual_mode_enabled" />
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="issuer_tel">ì—°ë½ì²˜</label>
              <input id="issuer_tel" type="tel" class="form-control" x-model.trim="form.issuer_tel" @input="calculateReceipt()" placeholder="ì˜ˆ: 010-0000-0000" maxlength="20" :disabled="form.manual_mode_enabled" />
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="issuer_name">ë°œí–‰ì(ê³µê¸‰ì)ëª…</label>
              <input id="issuer_name" type="text" class="form-control" x-model.trim="form.issuer_name" @input="calculateReceipt()" maxlength="40" :disabled="form.manual_mode_enabled" />
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="payer_name">ê³µê¸‰ë°›ëŠ”ì(ê±°ë˜ì²˜ëª…)</label>
              <input id="payer_name" type="text" class="form-control" x-model.trim="form.payer_name" @input="calculateReceipt()" maxlength="60" :disabled="form.manual_mode_enabled ? false : false" />
              <div class="form-text">
                <label class="form-check-label">
                  <input class="form-check-input me-1" type="checkbox" x-model="ui.syncPayerName" @change="calculateReceipt()" :disabled="form.manual_mode_enabled">
                  ê±°ë˜ì²˜ëª… ìë™ ë°˜ì˜
                </label>
              </div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="payer_biz_no">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label>
              <input id="payer_biz_no" type="text" class="form-control" x-model.trim="form.payer_biz_no" @input="calculateReceipt()" maxlength="20" placeholder="ì˜ˆ: 000-00-00000" :disabled="form.manual_mode_enabled" />
            </div>

            <div class="col-12">
              <div class="form-check">
                <input id="manual_mode_enabled" class="form-check-input" type="checkbox" x-model="form.manual_mode_enabled" @change="handleManualModeToggle()" />
                <label class="form-check-label" for="manual_mode_enabled">ë¹ˆ ì„œì‹(ì§ì ‘ ê¸°ì… ëª¨ë“œ) ì‚¬ìš©</label>
              </div>
              <div class="form-text">ì§ì ‘ ê¸°ì… ëª¨ë“œì—ì„œëŠ” ê±°ë˜ì²˜ ì½”ë“œ ì„ íƒì„ ë¹„í™œì„±í™”í•˜ê³ , ì…ë ¥ê°’ì„ ê·¸ëŒ€ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.</div>
            </div>
          </div>

          <hr class="my-4" />

          <div class="d-flex flex-wrap align-items-end justify-content-between gap-2">
            <h2 class="h5 mb-0">í’ˆëª© ì…ë ¥(ì˜ìˆ˜ì¦DB)</h2>
            <div class="d-flex gap-2 align-items-center">
              <label class="form-check-label small">
                <input class="form-check-input me-1" type="checkbox" x-model="ui.taxEnabled" @change="calculateReceipt()" />
                ë¶€ê°€ì„¸(10%) ê³„ì‚°
              </label>
              <button type="button" class="btn btn-sm btn-outline-secondary" @click="fillDemo()">ì˜ˆì‹œ ì…ë ¥</button>
            </div>
          </div>

          <div class="table-responsive mt-2">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th scope="col" style="min-width: 220px">í’ˆëª©</th>
                  <th scope="col" class="num" style="min-width: 90px">ìˆ˜ëŸ‰</th>
                  <th scope="col" class="num" style="min-width: 120px">ë‹¨ê°€</th>
                  <th scope="col" class="num" style="min-width: 120px">ê¸ˆì•¡</th>
                  <th scope="col" class="num" style="min-width: 120px">ë¶€ê°€ì„¸</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="(row, idx) in items" :key="idx">
                  <tr>
                    <td>
                      <input type="text" class="form-control form-control-sm" :aria-label="(idx+1)+'í–‰ í’ˆëª©'" x-model.trim="row.name" @input="calculateReceipt()" maxlength="60" placeholder="í’ˆëª©ëª…" />
                    </td>
                    <td>
                      <input type="number" class="form-control form-control-sm num" :aria-label="(idx+1)+'í–‰ ìˆ˜ëŸ‰'" x-model.number="row.qty" @input="normalizeNumber(row,'qty'); calculateReceipt()" min="0" step="1" />
                    </td>
                    <td>
                      <input type="number" class="form-control form-control-sm num" :aria-label="(idx+1)+'í–‰ ë‹¨ê°€'" x-model.number="row.unitPrice" @input="normalizeNumber(row,'unitPrice'); calculateReceipt()" min="0" step="1" />
                    </td>
                    <td class="num">
                      <span x-text="formatCurrencyKRW(row.amount)"></span>
                    </td>
                    <td class="num">
                      <span x-text="formatCurrencyKRW(row.tax)"></span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-12 col-md-4">
              <div class="p-3 bg-light rounded">
                <div class="small muted">í•©ê³„ ê¸ˆì•¡</div>
                <div class="h5 mb-0 num" x-text="formatCurrencyKRW(totals.sumAmount)"></div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="p-3 bg-light rounded">
                <div class="small muted">í•©ê³„ ë¶€ê°€ì„¸</div>
                <div class="h5 mb-0 num" x-text="formatCurrencyKRW(totals.sumTax)"></div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="p-3 bg-light rounded">
                <div class="small muted">ì´ í•©ê³„</div>
                <div class="h5 mb-0 num" x-text="formatCurrencyKRW(totals.grandTotal)"></div>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <div class="sr-live text-danger small" aria-live="polite" x-text="ui.error"></div>
          </div>

        </div>
      </section>

      <!-- Preview/Print area -->
      <section class="col-12 col-lg-6">
        <div class="panel p-3 p-md-4">
          <div class="d-flex align-items-end justify-content-between">
            <h2 class="h5 mb-0">ì˜ìˆ˜ì¦ ë¯¸ë¦¬ë³´ê¸°/ì¶œë ¥</h2>
            <div class="muted small">A4 ê°€ë¡œ ì¸ì‡„</div>
          </div>

          <div class="d-flex justify-content-center mt-3">
            <section id="printArea" class="preview-wrap" aria-label="ì¸ì‡„ ì˜ì—­">
              <div class="receipt-sheet">
                <div class="receipt-header">
                  <div>
                    <div class="receipt-title">ê°„ì´ì˜ìˆ˜ì¦</div>
                    <div class="receipt-meta mt-2">
                      <div><strong>ê±°ë˜ì²˜ ì½”ë“œ</strong>: <span x-text="preview.preview_customer_code || '-'" class="ms-1"></span></div>
                      <div><strong>ì‘ì„±ì¼ì</strong>: <span x-text="preview.preview_date || '-'" class="ms-1"></span></div>
                      <div><strong>ì˜ìˆ˜ì¦ ë²ˆí˜¸</strong>: <span x-text="preview.preview_receipt_no || '-'" class="ms-1"></span></div>
                    </div>
                  </div>
                  <div class="text-end receipt-meta">
                    <div><strong>ê³µê¸‰ì</strong>: <span x-text="form.issuer_name || '-'" class="ms-1"></span></div>
                    <div><strong>ì—°ë½ì²˜</strong>: <span x-text="form.issuer_tel || '-'" class="ms-1"></span></div>
                  </div>
                </div>

                <div class="receipt-box mb-2">
                  <div class="d-flex flex-wrap gap-3">
                    <div><strong>ê³µê¸‰ë°›ëŠ”ì</strong>: <span x-text="preview.preview_payer_name || '-'" class="ms-1"></span></div>
                    <div><strong>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</strong>: <span x-text="form.payer_biz_no || '-'" class="ms-1"></span></div>
                    <div class="ms-auto"><strong>ê±°ë˜ì²˜ëª…(ì¡°íšŒ)</strong>: <span x-text="customer_name_lookup || '-'" class="ms-1"></span></div>
                  </div>
                </div>

                <table class="receipt-grid">
                  <thead>
                    <tr>
                      <th>í’ˆëª©</th>
                      <th class="w-qty num">ìˆ˜ëŸ‰</th>
                      <th class="w-unit num">ë‹¨ê°€</th>
                      <th class="w-amt num">ê¸ˆì•¡</th>
                      <th class="w-tax num">ë¶€ê°€ì„¸</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="(row, idx) in items" :key="'p'+idx">
                      <tr x-show="idx < 11">
                        <td x-text="row.name || ''"></td>
                        <td class="num" x-text="row.qty ? formatNumberKR(row.qty) : ''"></td>
                        <td class="num" x-text="row.unitPrice ? formatCurrencyKRW(row.unitPrice) : ''"></td>
                        <td class="num" x-text="row.amount ? formatCurrencyKRW(row.amount) : ''"></td>
                        <td class="num" x-text="row.tax ? formatCurrencyKRW(row.tax) : ''"></td>
                      </tr>
                    </template>
                  </tbody>
                </table>

                <div class="receipt-footer">
                  <div class="receipt-box">
                    <div class="d-flex justify-content-between">
                      <strong>í•©ê³„ ê¸ˆì•¡</strong>
                      <span class="num" x-text="formatCurrencyKRW(totals.sumAmount)"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                      <strong>í•©ê³„ ë¶€ê°€ì„¸</strong>
                      <span class="num" x-text="formatCurrencyKRW(totals.sumTax)"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                      <strong>ì´ í•©ê³„</strong>
                      <span class="num" x-text="formatCurrencyKRW(totals.grandTotal)"></span>
                    </div>
                  </div>
                  <div class="receipt-box">
                    <div class="muted">ë¹„ê³ </div>
                    <div style="min-height: 24px;">&nbsp;</div>
                    <div class="small muted">(ë³¸ ì˜ìˆ˜ì¦ì€ ì›¹ì•±ì—ì„œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.)</div>
                  </div>
                </div>
              </div>
            </section>
          </div>

        </div>
      </section>
    </div>
  </main>

  <script>
    // ===== Excel formula helper functions (from get_js_helpers) =====
    function _sum(...args) {
        return args.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
    }
    function _sumRange(rangeData) {
        if (Array.isArray(rangeData)) {
            return rangeData.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
        }
        return parseFloat(rangeData) || 0;
    }
    function _average(...args) {
        const flat = args.flat().filter(x => x !== null && x !== '' && !isNaN(x));
        return flat.length ? _sum(...flat) / flat.length : 0;
    }
    function _averageRange(rangeData) {
        if (Array.isArray(rangeData)) {
            const flat = rangeData.flat().filter(x => x !== null && x !== '' && !isNaN(x));
            return flat.length ? _sumRange(flat) / flat.length : 0;
        }
        return parseFloat(rangeData) || 0;
    }
    function _count(...args) {
        return args.flat().filter(x => typeof x === 'number' && !isNaN(x)).length;
    }
    function _counta(...args) {
        return args.flat().filter(x => x !== null && x !== '' && x !== undefined).length;
    }
    function _and(...args) {
        return args.every(x => Boolean(x));
    }
    function _or(...args) {
        return args.some(x => Boolean(x));
    }
    function _round(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.round(num * factor) / factor;
    }
    function _roundUp(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.ceil(num * factor) / factor;
    }
    function _roundDown(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.floor(num * factor) / factor;
    }
    function _len(text) {
        return String(text).length;
    }
    function _left(text, numChars = 1) {
        return String(text).substring(0, numChars);
    }
    function _right(text, numChars = 1) {
        const str = String(text);
        return str.substring(str.length - numChars);
    }
    function _mid(text, startNum, numChars) {
        return String(text).substring(startNum - 1, startNum - 1 + numChars);
    }
    function _trim(text) {
        return String(text).trim();
    }
    function _upper(text) {
        return String(text).toUpperCase();
    }
    function _lower(text) {
        return String(text).toLowerCase();
    }
    function _concat(...args) {
        return args.join('');
    }
    function formatNumber(num, decimals = 0) {
        return new Intl.NumberFormat('ko-KR', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(num);
    }
    function formatCurrency(num) {
        return new Intl.NumberFormat('ko-KR', {
            style: 'currency',
            currency: 'KRW',
            maximumFractionDigits: 0
        }).format(num);
    }
    function formatPercent(num, decimals = 1) {
        return new Intl.NumberFormat('ko-KR', {
            style: 'percent',
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(num / 100);
    }

    // ===== App =====
    function appData(){
      return {
        // UI state
        ui: {
          error: '',
          syncPayerName: true,
          taxEnabled: true,
        },

        // í‘œ1(ê±°ë˜ì²˜ ëª©ë¡) - ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì„œë²„/íŒŒì¼ ë¡œë“œ ê°€ëŠ¥
        customerTable: [
          // [code, name]
          ['C001', 'ìƒ˜í”Œìƒì‚¬'],
          ['C002', 'í•œë¹›ìœ í†µ'],
          ['C003', 'ë™í•´ë¬¼ì‚°'],
        ],

        customerOptions: [],

        // Inputs (cell mappings)
        form: {
          customer_code: '',      // ì˜ìˆ˜ì¦!C3
          receipt_date: '',       // ì˜ìˆ˜ì¦!F4
          receipt_no: '',         // ì˜ìˆ˜ì¦!F5
          issuer_name: '',        // ì˜ìˆ˜ì¦!F6
          issuer_tel: '',         // ì˜ìˆ˜ì¦!F7
          payer_name: '',         // ì˜ìˆ˜ì¦!M5
          payer_biz_no: '',       // ì˜ìˆ˜ì¦!M7
          manual_mode_enabled: false, // ì˜ìˆ˜ì¦(ë¹ˆ ì„œì‹)!B12
        },

        // Items table: 11 rows
        items: Array.from({length: 11}, () => ({
          name: '',
          qty: 0,
          unitPrice: 0,
          amount: 0,
          tax: 0,
        })),

        // Outputs
        customer_name_lookup: '', // ì˜ìˆ˜ì¦!AB3
        preview: {
          preview_customer_code: '', // ì˜ìˆ˜ì¦!U3 =C3
          preview_date: '',          // ì˜ìˆ˜ì¦!X4 =F4
          preview_receipt_no: '',    // ì˜ìˆ˜ì¦!X5 =F5
          preview_payer_name: '',    // ì˜ìˆ˜ì¦!AE5 =M5
        },

        totals: {
          sumAmount: 0,
          sumTax: 0,
          grandTotal: 0,
        },

        init(){
          this.loadCustomerOptions();
          // default date = today (Excel TODAY ëŒ€ì²´)
          if(!this.form.receipt_date){
            const d = new Date();
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth()+1).padStart(2,'0');
            const dd = String(d.getDate()).padStart(2,'0');
            this.form.receipt_date = `${yyyy}-${mm}-${dd}`;
          }
          this.calculateReceipt();
        },

        // ===== Formatting =====
        formatCurrencyKRW(value){
          const v = Number(value);
          if(!isFinite(v)) return '0ì›';
          return new Intl.NumberFormat('ko-KR').format(Math.round(v)) + 'ì›';
        },
        formatNumberKR(value){
          const v = Number(value);
          if(!isFinite(v)) return '';
          return new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(v);
        },

        // ===== Validation helpers =====
        normalizeNumber(obj, key){
          const v = Number(obj[key]);
          obj[key] = isFinite(v) && v >= 0 ? v : 0;
        },

        validate(){
          // Keep minimal but effective validation; show in aria-live
          this.ui.error = '';

          // receipt_no optional, issuer/payer optional in this template
          // If manual mode is off, customer_code recommended (not hard required)
          if(!this.form.manual_mode_enabled && this.form.customer_code && !this.customer_name_lookup){
            this.ui.error = 'ì„ íƒí•œ ê±°ë˜ì²˜ ì½”ë“œë¥¼ ê±°ë˜ì²˜ ëª©ë¡ì—ì„œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
            return false;
          }

          // Items sanity
          for(const [i, row] of this.items.entries()){
            if(row.qty < 0 || row.unitPrice < 0){
              this.ui.error = `í’ˆëª© ${i+1}í–‰ì˜ ìˆ˜ëŸ‰/ë‹¨ê°€ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.`;
              return false;
            }
          }
          return true;
        },

        // ===== Excel-like functions =====
        loadCustomerOptions(){
          // í‘œ1(ê±°ë˜ì²˜ ëª©ë¡) ë¡œë“œí•˜ì—¬ select êµ¬ì„±
          this.customerOptions = this.customerTable.map(r => ({ code: r[0], name: r[1] }));
        },

        vlookupExact(lookupValue, table, colIndex){
          // Excel VLOOKUP(...,0) exact match
          if(lookupValue === null || lookupValue === undefined || lookupValue === '') return '';
          const key = String(lookupValue).trim();
          for(const row of table){
            if(String(row[0]).trim() === key){
              // colIndex is 1-based in Excel
              return row[colIndex-1] ?? '';
            }
          }
          return '';
        },

        calculateItemAmounts(items){
          // Excel: ì˜ìˆ˜ì¦DB!G2 = F2*E2 etc.
          // Converted formula example: =F2*E2 -> data['F2']*data['E2']
          // In this web app we compute amount = unitPrice * qty

          // Array formula(Iì—´) ì›ë³¸ ë¯¸í™•ë³´ -> ëŒ€ì²´ ê·œì¹™(ì˜µì…˜): tax = ROUND(amount*0.1, 0)
          const taxRate = this.ui.taxEnabled ? 0.1 : 0;

          let sumAmount = 0;
          let sumTax = 0;

          for(const row of items){
            const qty = isFinite(Number(row.qty)) ? Number(row.qty) : 0;
            const unit = isFinite(Number(row.unitPrice)) ? Number(row.unitPrice) : 0;
            const amount = unit * qty;
            const tax = _round(amount * taxRate, 0);

            row.amount = isFinite(amount) ? amount : 0;
            row.tax = isFinite(tax) ? tax : 0;

            sumAmount += row.amount;
            sumTax += row.tax;
          }

          this.totals.sumAmount = sumAmount;
          this.totals.sumTax = sumTax;
          this.totals.grandTotal = sumAmount + sumTax;
        },

        calculateReceipt(){
          // Dependecy order:
          // (1) ê±°ë˜ì²˜ ì¡°íšŒ (J3=VLOOKUP)
          // (2) í’ˆëª© ê³„ì‚° (Gì—´, Iì—´)
          // (3) ë¯¸ë¦¬ë³´ê¸° ë‹¨ìˆœ ì°¸ì¡° (U3=C3, X4=F4, X5=F5, AE5=M5)

          // (1) VLOOKUP(C3,í‘œ1,2,0)
          const lookedName = this.vlookupExact(this.form.customer_code, this.customerTable, 2);
          this.customer_name_lookup = lookedName;

          // optional sync payer_name
          if(!this.form.manual_mode_enabled && this.ui.syncPayerName && lookedName){
            this.form.payer_name = lookedName;
          }

          // (2) items
          this.calculateItemAmounts(this.items);

          // (3) preview bindings
          // Using converted formulas (direct):
          // U3:=C3 -> data['C3']
          // X4:=F4 -> data['F4']
          // X5:=F5 -> data['F5']
          // AE5:=M5 -> data['M5']
          // Here we map to form fields.
          this.preview.preview_customer_code = this.form.customer_code; // =C3
          this.preview.preview_date = this.form.receipt_date;          // =F4
          this.preview.preview_receipt_no = this.form.receipt_no;      // =F5
          this.preview.preview_payer_name = this.form.payer_name;      // =M5

          this.validate();
        },

        handleManualModeToggle(){
          // manual mode on: stop syncing payer name; keep current text
          if(this.form.manual_mode_enabled){
            this.ui.syncPayerName = false;
          }
          this.calculateReceipt();
        },

        printReceipt(){
          // ensure calculations are up to date
          this.calculateReceipt();
          // If there is a blocking validation error, still allow printing? Here: allow but show error.
          window.print();
        },

        resetAll(){
          this.form.customer_code = '';
          this.form.receipt_no = '';
          this.form.issuer_name = '';
          this.form.issuer_tel = '';
          this.form.payer_name = '';
          this.form.payer_biz_no = '';
          this.form.manual_mode_enabled = false;
          this.ui.syncPayerName = true;
          this.ui.taxEnabled = true;

          for(const row of this.items){
            row.name = '';
            row.qty = 0;
            row.unitPrice = 0;
            row.amount = 0;
            row.tax = 0;
          }

          // keep date as today
          const d = new Date();
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth()+1).padStart(2,'0');
          const dd = String(d.getDate()).padStart(2,'0');
          this.form.receipt_date = `${yyyy}-${mm}-${dd}`;

          this.calculateReceipt();
        },

        fillDemo(){
          this.form.customer_code = 'C001';
          this.form.receipt_no = '2025-0001';
          this.form.issuer_name = 'í™ê¸¸ë™';
          this.form.issuer_tel = '010-1234-5678';
          this.form.payer_biz_no = '123-45-67890';

          const demo = [
            ['ìƒí’ˆA', 2, 12000],
            ['ìƒí’ˆB', 1, 35000],
            ['ì„œë¹„ìŠ¤C', 3, 8000],
          ];
          for(let i=0;i<this.items.length;i++){
            this.items[i].name = demo[i]?.[0] ?? '';
            this.items[i].qty = demo[i]?.[1] ?? 0;
            this.items[i].unitPrice = demo[i]?.[2] ?? 0;
          }
          this.calculateReceipt();
        }
      }
    }
  </script>

<!-- í•´ì»¤í†¤ ì„ ì • ì •ë³´ -->
<div id="selection-banner" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 14px;
    z-index: 10000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
">
    <div>
        <strong>ğŸ“Š ê°„ì´ì˜ìˆ˜ì¦</strong>
        <span style="margin-left: 10px; opacity: 0.9;">| ìˆ˜ì‹í’ë¶€ (XLSX)</span>
    </div>
    <div style="display: flex; align-items: center; gap: 15px;">
        <span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 12px;">
            233ê°œ ìˆ˜ì‹
        </span>
        <button onclick="document.getElementById('selection-info').style.display='block'"
                style="background: white; color: #667eea; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 500;">
            ì„ ì • ì´ìœ  ë³´ê¸°
        </button>
    </div>
</div>

<div id="selection-info" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 10001;
    display: none;
    justify-content: center;
    align-items: center;
" onclick="this.style.display='none'">
    <div style="
        background: white;
        padding: 30px;
        border-radius: 16px;
        max-width: 500px;
        margin: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    " onclick="event.stopPropagation()">
        <h2 style="margin: 0 0 15px; color: #333;">ğŸ† í•´ì»¤í†¤ ì„ ì • ì´ìœ </h2>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <strong style="color: #667eea;">ìˆ˜ì‹í’ë¶€ (XLSX)</strong>
            <p style="margin: 10px 0 0; color: #555; line-height: 1.6;">233ê°œ ìˆ˜ì‹, VLOOKUP/IF/SUM ë“± í•µì‹¬ í•¨ìˆ˜ - ë³€í™˜ ê¸°ìˆ ë ¥ ì‹œì—°ì— ìµœì </p>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <span style="background: #e3e8ff; color: #4c5fd5; padding: 4px 10px; border-radius: 12px; font-size: 12px;">IF</span><span style="background: #e3e8ff; color: #4c5fd5; padding: 4px 10px; border-radius: 12px; font-size: 12px;">SUM</span><span style="background: #e3e8ff; color: #4c5fd5; padding: 4px 10px; border-radius: 12px; font-size: 12px;">TEXT</span><span style="background: #e3e8ff; color: #4c5fd5; padding: 4px 10px; border-radius: 12px; font-size: 12px;">TODAY</span><span style="background: #e3e8ff; color: #4c5fd5; padding: 4px 10px; border-radius: 12px; font-size: 12px;">VLOOKUP</span>
        </div>
        <button onclick="document.getElementById('selection-info').style.display='none'"
                style="margin-top: 20px; width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
            ë‹«ê¸°
        </button>
    </div>
</div>

<style>
body { padding-top: 56px !important; }
</style>
</body>
</html>
