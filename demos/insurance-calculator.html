<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4대보험 자동계산기</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap');

    :root{
      --app-max-width: 720px;
      --excel-grid: #e9ecef;
      --ink: #111827;
      --muted: #6b7280;
      --card: #ffffff;
      --accent: #0d6efd;
      --good: #198754;
      --warn: #b45309;
    }

    html, body { height: 100%; }
    body{
      font-family: "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      color: var(--ink);
      background: #f6f7fb;
    }

    .app-wrap{ max-width: var(--app-max-width); }

    .app-header h1{ letter-spacing: -0.02em; }

    .card{
      border: 1px solid rgba(17,24,39,.08);
      box-shadow: 0 6px 24px rgba(17,24,39,.06);
      background: var(--card);
    }

    .hint{ color: var(--muted); font-size: .9rem; }

    .result-table{
      border-collapse: collapse;
      width: 100%;
    }
    .result-table th,
    .result-table td{
      border: 1px solid var(--excel-grid);
      padding: 10px 12px;
      vertical-align: middle;
      background: #fff;
    }
    .result-table th{
      width: 62%;
      font-weight: 600;
      text-align: left;
      background: #fbfbfd;
    }
    .result-table td{ text-align: right; font-variant-numeric: tabular-nums; }

    .row-strong th,
    .row-strong td{ font-weight: 700; }

    .money{ white-space: nowrap; }

    .toolbar .btn{ min-width: 96px; }

    /* Accessibility focus */
    :focus-visible{ outline: 3px solid rgba(13,110,253,.35); outline-offset: 2px; }

    /* Print */
    @page {
      size: A4 portrait;
      margin: 25.4mm 19.05mm 25.4mm 19.05mm;
    }

    @media print{
      body{ background: #fff; }
      .no-print{ display: none !important; }
      .card{ box-shadow: none; border: 1px solid #d1d5db; }
      .container{ max-width: none !important; }
      .app-wrap{ max-width: none; }

      /* Make input look like plain text */
      input, select, textarea{
        border: 0 !important;
        box-shadow: none !important;
        padding-left: 0 !important;
      }
      .form-text, .hint{ display: none !important; }

      a[href]:after{ content: ""; }
    }
  </style>
</head>

<body>
  <div class="container py-4" x-data="appData()" x-init="init()">
    <div class="app-wrap mx-auto">
      <header class="app-header mb-3">
        <h1 class="h3 mb-1">4대보험 자동계산기</h1>
        <p class="mb-0 text-secondary">월 급여(과세 기준)를 입력하면 근로자 부담 기준 4대보험을 자동 계산합니다.</p>
      </header>

      <!-- Alert area -->
      <div class="mb-3" role="alert" aria-live="polite" x-show="errorMessage" x-cloak>
        <div class="alert alert-warning mb-0" x-text="errorMessage"></div>
      </div>

      <main>
        <!-- Input Section -->
        <section class="card mb-3" aria-labelledby="input-title">
          <div class="card-body">
            <div class="d-flex align-items-start justify-content-between gap-3">
              <div>
                <h2 class="h5 mb-1" id="input-title">입력</h2>
                <div class="hint">기본 계산식(Excel): C4=C3*0.045, C5=C3*0.03545, C6=C5*0.1281, C7=C3*0.009</div>
              </div>
              <div class="toolbar no-print d-flex gap-2 flex-wrap justify-content-end">
                <button type="button" class="btn btn-outline-secondary" @click="resetAll()">초기화</button>
                <button type="button" class="btn btn-primary" @click="calculateAll(monthlySalary)">계산</button>
                <button type="button" class="btn btn-outline-primary" @click="print()">인쇄</button>
              </div>
            </div>

            <hr class="my-3" />

            <form class="row g-3" @submit.prevent="calculateAll(monthlySalary)" novalidate>
              <div class="col-12">
                <label for="monthly_salary" class="form-label fw-semibold">월 급여(과세 기준)</label>
                <div class="input-group">
                  <input
                    type="number"
                    class="form-control"
                    id="monthly_salary"
                    name="monthly_salary"
                    inputmode="decimal"
                    min="0"
                    step="1000"
                    placeholder="예: 3000000"
                    x-model.number="monthlySalary"
                    @input="onSalaryInput($event)"
                    aria-describedby="salary_help salary_preview"
                  />
                  <span class="input-group-text">원</span>
                </div>
                <div class="form-text" id="salary_help">숫자만 입력 (0 이상). 입력 후 자동 계산됩니다.</div>
                <div class="mt-1 text-secondary" id="salary_preview" aria-live="polite">
                  <span class="me-1">표시:</span>
                  <strong class="money" x-text="formatKRW(monthlySalary, 0)"></strong>
                </div>
              </div>

              <!-- Rounding option -->
              <div class="col-12">
                <label for="round_mode" class="form-label fw-semibold">반올림 규칙(표시/계산)</label>
                <select id="round_mode" class="form-select" x-model="roundMode" @change="calculateAll(monthlySalary)" aria-describedby="round_help">
                  <option value="round">원 단위 반올림(기본)</option>
                  <option value="floor">원 단위 절사</option>
                  <option value="ceil">원 단위 올림</option>
                  <option value="none">반올림 없음(소수 유지)</option>
                </select>
                <div class="form-text" id="round_help">원본 Excel 수식에는 ROUND/INT가 없으므로 기본값은 원 단위 반올림으로 설정했습니다.</div>
              </div>
            </form>
          </div>
        </section>

        <!-- Result Section -->
        <section class="card" aria-labelledby="result-title">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <h2 class="h5 mb-0" id="result-title">계산 결과</h2>
              <div class="text-secondary small">근로자 부담 기준</div>
            </div>

            <hr class="my-3" />

            <div aria-live="polite">
              <table class="result-table" aria-describedby="result_caption">
                <caption class="visually-hidden" id="result_caption">4대보험 계산 결과</caption>
                <tbody>
                  <tr>
                    <th scope="row">국민연금(근로자 부담)</th>
                    <td><output class="money" x-text="formatKRW(nationalPension, 0)"></output></td>
                  </tr>
                  <tr>
                    <th scope="row">건강보험(근로자 부담)</th>
                    <td><output class="money" x-text="formatKRW(healthInsurance, 0)"></output></td>
                  </tr>
                  <tr>
                    <th scope="row">장기요양보험(근로자 부담)</th>
                    <td><output class="money" x-text="formatKRW(longTermCare, 0)"></output></td>
                  </tr>
                  <tr>
                    <th scope="row">고용보험(근로자 부담)</th>
                    <td><output class="money" x-text="formatKRW(employmentInsurance, 0)"></output></td>
                  </tr>
                  <tr class="row-strong">
                    <th scope="row">4대보험 합계(근로자 부담)</th>
                    <td><output class="money" x-text="formatKRW(totalInsurance, 0)"></output></td>
                  </tr>
                  <tr class="row-strong">
                    <th scope="row">예상 실수령(급여-4대보험)</th>
                    <td><output class="money" x-text="formatKRW(netPayEstimate, 0)"></output></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="mt-3 hint">
              참고: 본 계산기는 제공된 Excel 수식을 그대로 적용한 단순 추정치입니다. 실제 고지 금액은 기준소득월액/요율 변경, 보험료 산정·원단위 처리 규정 등에 따라 달라질 수 있습니다.
            </div>
          </div>
        </section>

        <footer class="mt-3 text-secondary small">
          <div>인쇄: A4 세로, 여백(상/하 25.4mm, 좌/우 19.05mm)</div>
        </footer>
      </main>
    </div>
  </div>

  <script>
    // Excel formula helper functions
    function _sum(...args) {
        return args.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
    }

    function _sumRange(rangeData) {
        if (Array.isArray(rangeData)) {
            return rangeData.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
        }
        return parseFloat(rangeData) || 0;
    }

    function _average(...args) {
        const flat = args.flat().filter(x => x !== null && x !== '' && !isNaN(x));
        return flat.length ? _sum(...flat) / flat.length : 0;
    }

    function _averageRange(rangeData) {
        if (Array.isArray(rangeData)) {
            const flat = rangeData.flat().filter(x => x !== null && x !== '' && !isNaN(x));
            return flat.length ? _sumRange(flat) / flat.length : 0;
        }
        return parseFloat(rangeData) || 0;
    }

    function _count(...args) {
        return args.flat().filter(x => typeof x === 'number' && !isNaN(x)).length;
    }

    function _counta(...args) {
        return args.flat().filter(x => x !== null && x !== '' && x !== undefined).length;
    }

    function _and(...args) {
        return args.every(x => Boolean(x));
    }

    function _or(...args) {
        return args.some(x => Boolean(x));
    }

    function _round(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.round(num * factor) / factor;
    }

    function _roundUp(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.ceil(num * factor) / factor;
    }

    function _roundDown(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.floor(num * factor) / factor;
    }

    function _len(text) {
        return String(text).length;
    }

    function _left(text, numChars = 1) {
        return String(text).substring(0, numChars);
    }

    function _right(text, numChars = 1) {
        const str = String(text);
        return str.substring(str.length - numChars);
    }

    function _mid(text, startNum, numChars) {
        return String(text).substring(startNum - 1, startNum - 1 + numChars);
    }

    function _trim(text) {
        return String(text).trim();
    }

    function _upper(text) {
        return String(text).toUpperCase();
    }

    function _lower(text) {
        return String(text).toLowerCase();
    }

    function _concat(...args) {
        return args.join('');
    }

    // Number formatting
    function formatNumber(num, decimals = 0) {
        return new Intl.NumberFormat('ko-KR', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(num);
    }

    function formatCurrency(num) {
        return new Intl.NumberFormat('ko-KR', {
            style: 'currency',
            currency: 'KRW',
            maximumFractionDigits: 0
        }).format(num);
    }

    function formatPercent(num, decimals = 1) {
        return new Intl.NumberFormat('ko-KR', {
            style: 'percent',
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(num / 100);
    }

    // App
    function appData(){
      return {
        // Input (C3)
        monthlySalary: 0,

        // Outputs (C4~C9)
        nationalPension: 0,
        healthInsurance: 0,
        longTermCare: 0,
        employmentInsurance: 0,
        totalInsurance: 0,
        netPayEstimate: 0,

        // UI state
        roundMode: 'round',
        errorMessage: '',
        _debounceTimer: null,

        init(){
          this.calculateAll(this.monthlySalary);
        },

        onSalaryInput(e){
          // debounce 150ms
          clearTimeout(this._debounceTimer);
          this._debounceTimer = setTimeout(() => {
            this.calculateAll(this.monthlySalary);
          }, 150);
        },

        // 원화 포맷
        formatKRW(value, decimals = 0){
          const n = Number(value);
          if (!isFinite(n)) return '0원';
          return new Intl.NumberFormat('ko-KR', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
          }).format(n) + '원';
        },

        // 보험료 반올림 정책
        roundPolicy(value, mode = 'round'){
          const n = Number(value);
          if (!isFinite(n)) return 0;
          switch(mode){
            case 'floor': return Math.floor(n);
            case 'ceil': return Math.ceil(n);
            case 'none': return n;
            case 'round':
            default: return Math.round(n);
          }
        },

        // Excel 수식(C4~C9) 기반 전체 계산
        calculateAll(monthlySalary){
          // Validation
          const salary = Number(monthlySalary);
          if (!isFinite(salary) || salary < 0){
            this.errorMessage = '월 급여는 0 이상의 숫자여야 합니다.';
            this.resetOutputs();
            return;
          }
          this.errorMessage = '';

          // Represent sheet cells as a map (Excel conversion output uses data['C?'])
          const data = {
            'C3': salary,
            'C4': 0,
            'C5': 0,
            'C6': 0,
            'C7': 0,
            'C8': 0,
            'C9': 0,
          };

          // Converted formulas:
          // C4: =C3*0.045
          data['C4'] = data['C3']*0.045;
          // C5: =C3*0.03545
          data['C5'] = data['C3']*0.03545;
          // C6: =C5*0.1281
          data['C6'] = data['C5']*0.1281;
          // C7: =C3*0.009
          data['C7'] = data['C3']*0.009;
          // C8: =C4+C5+C6+C7
          data['C8'] = data['C4']+data['C5']+data['C6']+data['C7'];
          // C9: =C3-C8
          data['C9'] = data['C3']-data['C8'];

          // Apply rounding policy (optional). Default: 원 단위 반올림.
          const m = this.roundMode;
          const C4 = this.roundPolicy(data['C4'], m);
          const C5 = this.roundPolicy(data['C5'], m);
          const C6 = this.roundPolicy(data['C6'], m);
          const C7 = this.roundPolicy(data['C7'], m);
          const C8 = this.roundPolicy(C4 + C5 + C6 + C7, m);
          const C9 = this.roundPolicy(salary - C8, m);

          // Bind to UI state
          this.nationalPension = C4;
          this.healthInsurance = C5;
          this.longTermCare = C6;
          this.employmentInsurance = C7;
          this.totalInsurance = C8;
          this.netPayEstimate = C9;
        },

        resetOutputs(){
          this.nationalPension = 0;
          this.healthInsurance = 0;
          this.longTermCare = 0;
          this.employmentInsurance = 0;
          this.totalInsurance = 0;
          this.netPayEstimate = 0;
        },

        resetAll(){
          this.monthlySalary = 0;
          this.roundMode = 'round';
          this.errorMessage = '';
          this.calculateAll(this.monthlySalary);
          // focus back to input (nice UX)
          requestAnimationFrame(() => document.getElementById('monthly_salary')?.focus());
        },

        print(){
          window.print();
        }
      }
    }
  </script>

<!-- Agent Trace Viewer -->
<style>
.trace-toggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    background: #6366f1;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    display: flex;
    align-items: center;
    gap: 8px;
}
.trace-toggle:hover { background: #4f46e5; }
.trace-panel {
    position: fixed;
    top: 0;
    right: -450px;
    width: 450px;
    height: 100vh;
    background: #1e1e2e;
    color: #cdd6f4;
    z-index: 9998;
    transition: right 0.3s ease;
    overflow-y: auto;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 12px;
}
.trace-panel.open { right: 0; }
.trace-header {
    padding: 16px;
    background: #313244;
    border-bottom: 1px solid #45475a;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.trace-header h3 { margin: 0; font-size: 14px; }
.trace-close {
    background: none;
    border: none;
    color: #cdd6f4;
    cursor: pointer;
    font-size: 18px;
}
.trace-content { padding: 16px; }
.span-item {
    margin-bottom: 12px;
    padding: 12px;
    background: #313244;
    border-radius: 8px;
    border-left: 3px solid #89b4fa;
}
.span-item.agent { border-left-color: #a6e3a1; }
.span-item.generation { border-left-color: #f9e2af; }
.span-item.function { border-left-color: #cba6f7; }
.span-type {
    font-size: 10px;
    text-transform: uppercase;
    color: #6c7086;
    margin-bottom: 4px;
}
.span-name { font-weight: bold; color: #89dceb; }
.span-data {
    margin-top: 8px;
    padding: 8px;
    background: #1e1e2e;
    border-radius: 4px;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-all;
}
.span-time { color: #6c7086; font-size: 11px; }
.trace-summary {
    padding: 12px 16px;
    background: #45475a;
    margin: 0 16px 16px;
    border-radius: 8px;
}
.trace-summary-item { display: flex; justify-content: space-between; margin: 4px 0; }
</style>

<button class="trace-toggle" onclick="toggleTracePanel()">
    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
    </svg>
    Agent Trace
</button>

<div class="trace-panel" id="tracePanel">
    <div class="trace-header">
        <h3>Agent Trace Viewer</h3>
        <button class="trace-close" onclick="toggleTracePanel()">&times;</button>
    </div>
    <div class="trace-summary" id="traceSummary"></div>
    <div class="trace-content" id="traceContent"></div>
</div>

<script>
const TRACE_DATA = {"trace_id": "trace_34f00c8d88474e21a3ea3a948c613a64", "workflow_name": "Excel-to-WebApp: 4대보험_자동계산기_엑셀템플릿.xlsx", "group_id": null, "metadata": null, "started_at": "2025-12-28T09:53:46.191640", "ended_at": "2025-12-28T09:54:55.566448", "spans": [{"span_id": "span_ed6dd2d628644b5baf39288c", "parent_id": "span_1ff6155e773e420282fa4faf", "started_at": "2025-12-28T00:53:46.206548+00:00", "ended_at": "2025-12-28T00:54:06.855110+00:00", "error": null, "type": "response", "data": {"type": "response", "response_id": "resp_079e200e57aacad70069507f9b0d608194aa317ef65d53617d"}}, {"span_id": "span_1ff6155e773e420282fa4faf", "parent_id": null, "started_at": "2025-12-28T00:53:46.195604+00:00", "ended_at": "2025-12-28T00:54:06.855872+00:00", "error": null, "type": "agent", "data": {"type": "agent", "name": "WebApp Planner", "handoffs": [], "tools": [], "output_type": "WebAppPlan"}}, {"span_id": "span_af7baff763114dd0a9fb2806", "parent_id": "span_46ebbda3aa694976891ec450", "started_at": "2025-12-28T00:54:06.856457+00:00", "ended_at": "2025-12-28T00:54:08.848353+00:00", "error": null, "type": "response", "data": {"type": "response", "response_id": "resp_0ce73d1f17234c360069507faf4a4c819683132b391c80be6b"}}, {"span_id": "span_cda54f5301d1413491878762", "parent_id": "span_46ebbda3aa694976891ec450", "started_at": "2025-12-28T00:54:08.848667+00:00", "ended_at": "2025-12-28T00:54:08.849306+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "check_formula_complexity", "input": "{\"formula\":\"=C3*0.045\"}", "output": "formula='=C3*0.045' is_simple=True conversion_method='direct'", "mcp_data": null}}, {"span_id": "span_c6590ae0d9e946d080bae81a", "parent_id": "span_46ebbda3aa694976891ec450", "started_at": "2025-12-28T00:54:08.848715+00:00", "ended_at": "2025-12-28T00:54:08.849336+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "check_formula_complexity", "input": "{\"formula\":\"=C3*0.03545\"}", "output": "formula='=C3*0.03545' is_simple=True conversion_method='direct'", "mcp_data": null}}, {"span_id": "span_0c4e265c3b34471988d0cb38", "parent_id": "span_46ebbda3aa694976891ec450", "started_at": "2025-12-28T00:54:08.848731+00:00", "ended_at": "2025-12-28T00:54:08.849348+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "check_formula_complexity", "input": "{\"formula\":\"=C5*0.1281\"}", "output": "formula='=C5*0.1281' is_simple=True conversion_method='direct'", "mcp_data": null}}, {"span_id": "span_b162a12851e74119b84e6701", "parent_id": "span_46ebbda3aa694976891ec450", "started_at": "2025-12-28T00:54:08.848743+00:00", "ended_at": "2025-12-28T00:54:08.849356+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "check_formula_complexity", "input": "{\"formula\":\"=C3*0.009\"}", "output": "formula='=C3*0.009' is_simple=True conversion_method='direct'", "mcp_data": null}}, {"span_id": "span_551029e7b2d0478997f487a4", "parent_id": "span_46ebbda3aa694976891ec450", "started_at": "2025-12-28T00:54:08.848753+00:00", "ended_at": "2025-12-28T00:54:08.849362+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "check_formula_complexity", "input": "{\"formula\":\"=C4+C5+C6+C7\"}", "output": "formula='=C4+C5+C6+C7' is_simple=True conversion_method='direct'", "mcp_data": null}}, {"span_id": "span_514cd207449b4c389d8b9eb5", "parent_id": "span_46ebbda3aa694976891ec450", "started_at": "2025-12-28T00:54:08.848763+00:00", "ended_at": "2025-12-28T00:54:08.849368+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "check_formula_complexity", "input": "{\"formula\":\"=C3-C8\"}", "output": "formula='=C3-C8' is_simple=True conversion_method='direct'", "mcp_data": null}}, {"span_id": "span_26952f9a2a304648a91d7b0f", "parent_id": "span_46ebbda3aa694976891ec450", "started_at": "2025-12-28T00:54:08.848832+00:00", "ended_at": "2025-12-28T00:54:08.849374+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "get_js_helpers", "input": "{}", "output": "\n// Excel formula helper functions\nfunction _sum(...args) {\n    return args.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);\n}\n\nfunction _sumRange(rangeData) {\n    if (Array.isArray(rangeData)) {\n        return rangeData.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);\n    }\n    return parseFloat(rangeData) || 0;\n}\n\nfunction _average(...args) {\n    const flat = args.flat().filter(x => x !== null && x !== '' && !isNaN(x));\n    return flat.length ? _sum(...flat) / flat.length : 0;\n}\n\nfunction _averageRange(rangeData) {\n    if (Array.isArray(rangeData)) {\n        const flat = rangeData.flat().filter(x => x !== null && x !== '' && !isNaN(x));\n        return flat.length ? _sumRange(flat) / flat.length : 0;\n    }\n    return parseFloat(rangeData) || 0;\n}\n\nfunction _count(...args) {\n    return args.flat().filter(x => typeof x === 'number' && !isNaN(x)).length;\n}\n\nfunction _counta(...args) {\n    return args.flat().filter(x => x !== null && x !== '' && x !== undefined).length;\n}\n\nfunction _and(...args) {\n    return args.every(x => Boolean(x));\n}\n\nfunction _or(...args) {\n    return args.some(x => Boolean(x));\n}\n\nfunction _round(num, digits = 0) {\n    const factor = Math.pow(10, digits);\n    return Math.round(num * factor) / factor;\n}\n\nfunction _roundUp(num, digits = 0) {\n    const factor = Math.pow(10, digits);\n    return Math.ceil(num * factor) / factor;\n}\n\nfunction _roundDown(num, digits = 0) {\n    const factor = Math.pow(10, digits);\n    return Math.floor(num * factor) / factor;\n}\n\nfunction _len(text) {\n    return String(text).length;\n}\n\nfunction _left(text, numChars = 1) {\n    return String(text).substring(0, numChars);\n}\n\nfunction _right(text, numChars = 1) {\n    const str = String(text);\n    return str.substring(str.length - numChars);\n}\n\nfunction _mid(text, startNum, numChars) {\n    return String(text).substring(startNum - 1, startNum - 1 + numChars);\n}\n\nfunction _trim(text) {\n    return String(text).trim();\n}\n\nfunction _upper(text) {\n    return String(text).toUpperCase();\n}\n\nfunction _lower(text) {\n    return String(text).toLowerCase();\n}\n\nfunction _concat(...args) {\n    return args.join('');\n}\n\n// Number formatting\nfunction formatNumber(num, decimals = 0) {\n    return new Intl.NumberFormat('ko-KR', {\n        minimumFractionDigits: decimals,\n        maximumFractionDigits: decimals\n    }).format(num);\n}\n\nfunction formatCurrency(num) {\n    return new Intl.NumberFormat('ko-KR', {\n        style: 'currency',\n        currency: 'KRW',\n        maximumFractionDigits: 0\n    }).format(num);\n}\n\nfunction formatPercent(num, decimals = 1) {\n    return new Intl.NumberFormat('ko-KR', {\n        style: 'percent',\n        minimumFractionDigits: decimals,\n        maximumFractionDigits: decimals\n    }).format(num / 100);\n}\n", "mcp_data": null}}, {"span_id": "span_afac457164a44c99889a8801", "parent_id": "span_46ebbda3aa694976891ec450", "started_at": "2025-12-28T00:54:08.850027+00:00", "ended_at": "2025-12-28T00:54:12.369360+00:00", "error": null, "type": "response", "data": {"type": "response", "response_id": "resp_0ce73d1f17234c360069507fb184f081968acd3a358715570c"}}, {"span_id": "span_05f6d4c77416490690e25312", "parent_id": "span_46ebbda3aa694976891ec450", "started_at": "2025-12-28T00:54:12.369619+00:00", "ended_at": "2025-12-28T00:54:12.370459+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "convert_formula", "input": "{\"formula\":\"=C3*0.045\"}", "output": "success=True js_code=\"data['C3']*0.045\" requires_llm=False error=None", "mcp_data": null}}, {"span_id": "span_77c6b6e9a33042e18d16816f", "parent_id": "span_46ebbda3aa694976891ec450", "started_at": "2025-12-28T00:54:12.369646+00:00", "ended_at": "2025-12-28T00:54:12.370481+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "convert_formula", "input": "{\"formula\":\"=C3*0.03545\"}", "output": "success=True js_code=\"data['C3']*0.03545\" requires_llm=False error=None", "mcp_data": null}}, {"span_id": "span_f0e272a4d5d249ddb5760f5b", "parent_id": "span_46ebbda3aa694976891ec450", "started_at": "2025-12-28T00:54:12.369659+00:00", "ended_at": "2025-12-28T00:54:12.370490+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "convert_formula", "input": "{\"formula\":\"=C5*0.1281\"}", "output": "success=True js_code=\"data['C5']*0.1281\" requires_llm=False error=None", "mcp_data": null}}, {"span_id": "span_3ee03510d77b46e3a3340f4a", "parent_id": "span_46ebbda3aa694976891ec450", "started_at": "2025-12-28T00:54:12.369672+00:00", "ended_at": "2025-12-28T00:54:12.370497+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "convert_formula", "input": "{\"formula\":\"=C3*0.009\"}", "output": "success=True js_code=\"data['C3']*0.009\" requires_llm=False error=None", "mcp_data": null}}, {"span_id": "span_430ab97d54cb436a82ab908f", "parent_id": "span_46ebbda3aa694976891ec450", "started_at": "2025-12-28T00:54:12.369683+00:00", "ended_at": "2025-12-28T00:54:12.370503+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "convert_formula", "input": "{\"formula\":\"=C4+C5+C6+C7\"}", "output": "success=True js_code=\"data['C4']+data['C5']+data['C6']+data['C7']\" requires_llm=False error=None", "mcp_data": null}}, {"span_id": "span_a901060aa98048338c55c584", "parent_id": "span_46ebbda3aa694976891ec450", "started_at": "2025-12-28T00:54:12.369693+00:00", "ended_at": "2025-12-28T00:54:12.370508+00:00", "error": null, "type": "function", "data": {"type": "function", "name": "convert_formula", "input": "{\"formula\":\"=C3-C8\"}", "output": "success=True js_code=\"data['C3']-data['C8']\" requires_llm=False error=None", "mcp_data": null}}, {"span_id": "span_dc95b3fb7e7a4e39ba953787", "parent_id": "span_46ebbda3aa694976891ec450", "started_at": "2025-12-28T00:54:12.370889+00:00", "ended_at": "2025-12-28T00:54:55.565866+00:00", "error": null, "type": "response", "data": {"type": "response", "response_id": "resp_0ce73d1f17234c360069507fb48bf48196a990072f3efda72b"}}, {"span_id": "span_46ebbda3aa694976891ec450", "parent_id": null, "started_at": "2025-12-28T00:54:06.856163+00:00", "ended_at": "2025-12-28T00:54:55.566219+00:00", "error": null, "type": "agent", "data": {"type": "agent", "name": "WebApp Generator", "handoffs": [], "tools": ["convert_formula", "check_formula_complexity", "get_js_helpers"], "output_type": "GeneratedWebApp"}}]};

function toggleTracePanel() {
    document.getElementById('tracePanel').classList.toggle('open');
}

function renderTrace() {
    const summary = document.getElementById('traceSummary');
    const content = document.getElementById('traceContent');

    if (!TRACE_DATA) {
        content.innerHTML = '<p>No trace data available</p>';
        return;
    }

    // Summary
    const spans = TRACE_DATA.spans || [];
    const agentSpans = spans.filter(s => s.type === 'agent').length;
    const genSpans = spans.filter(s => s.type === 'generation').length;
    const funcSpans = spans.filter(s => s.type === 'function').length;

    summary.innerHTML = `
        <div class="trace-summary-item"><span>Workflow</span><span>${TRACE_DATA.workflow_name || '-'}</span></div>
        <div class="trace-summary-item"><span>Agent Spans</span><span>${agentSpans}</span></div>
        <div class="trace-summary-item"><span>LLM Generations</span><span>${genSpans}</span></div>
        <div class="trace-summary-item"><span>Function Calls</span><span>${funcSpans}</span></div>
    `;

    // Spans
    let html = '';
    spans.forEach(span => {
        const typeClass = span.type || 'custom';
        const data = span.data || {};
        html += `
            <div class="span-item ${typeClass}">
                <div class="span-type">${span.type || 'span'}</div>
                <div class="span-name">${data.name || data.model || span.span_id?.slice(0, 8) || '-'}</div>
                ${data.input ? `<div class="span-data">${typeof data.input === 'string' ? data.input.slice(0, 200) : JSON.stringify(data.input).slice(0, 200)}...</div>` : ''}
                ${data.output ? `<div class="span-data">${typeof data.output === 'string' ? data.output.slice(0, 200) : JSON.stringify(data.output).slice(0, 200)}...</div>` : ''}
                ${data.usage ? `<div class="span-time">Tokens: ${data.usage.total_tokens || '-'}</div>` : ''}
            </div>
        `;
    });
    content.innerHTML = html || '<p>No spans recorded</p>';
}

document.addEventListener('DOMContentLoaded', renderTrace);
</script>
</body>
</html>
