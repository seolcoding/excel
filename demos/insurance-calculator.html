<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4대보험 자동계산기</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    :root {
      --app-max-width: 820px;
      --excel-border: #1f2937;
      --excel-grid: #d1d5db;
      --excel-header-bg: #f3f4f6;
      --excel-accent: #0d6efd;
      --text: #111827;
      --muted: #6b7280;
    }

    /* Typography */
    body {
      color: var(--text);
      background: #ffffff;
      font-family: "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
    }

    .app-shell {
      max-width: var(--app-max-width);
      margin: 0 auto;
    }

    .app-title {
      font-weight: 800;
      letter-spacing: -0.02em;
      font-size: 1.5rem;
      line-height: 1.2;
    }

    .app-subtitle {
      color: var(--muted);
      font-size: 0.95rem;
    }

    /* Form layout */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }

    @media (min-width: 576px) {
      .form-grid {
        grid-template-columns: 1fr 1fr;
        align-items: end;
      }
    }

    .help-text {
      color: var(--muted);
      font-size: 0.875rem;
    }

    /* Excel-like table */
    .result-card {
      border: 1px solid var(--excel-grid);
      border-radius: 0.5rem;
      overflow: hidden;
    }

    .result-card .card-header {
      background: var(--excel-header-bg);
      border-bottom: 1px solid var(--excel-grid);
    }

    table.result-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    table.result-table th,
    table.result-table td {
      border: 1px solid var(--excel-grid);
      padding: 0.6rem 0.75rem;
      vertical-align: middle;
    }

    table.result-table thead th {
      background: var(--excel-header-bg);
      font-weight: 700;
      text-align: center;
    }

    table.result-table td.item {
      font-weight: 600;
    }

    table.result-table td.formula {
      color: var(--muted);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
    }

    table.result-table td.amount {
      text-align: right;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }

    tr.total-row td {
      font-weight: 800;
      border-top: 2px solid var(--excel-border);
      background: #fafafa;
    }

    .meta-row {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      color: var(--muted);
      font-size: 0.875rem;
    }

    .badge-note {
      background: rgba(13, 110, 253, 0.08);
      color: #084298;
      border: 1px solid rgba(13, 110, 253, 0.25);
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      font-size: 0.8rem;
    }

    /* Print */
    @page {
      size: A4 portrait;
      margin: 25.4mm 19.05mm 25.4mm 19.05mm;
    }

    @media print {
      body {
        background: #fff !important;
      }

      .no-print {
        display: none !important;
      }

      .result-card {
        border-radius: 0;
        border: 0;
      }

      .result-card .card-header {
        background: #fff !important;
        border-bottom: 0;
        padding-left: 0;
        padding-right: 0;
      }

      table.result-table th,
      table.result-table td {
        border-color: #000 !important;
      }

      .app-title {
        font-size: 1.1rem;
      }

      .app-subtitle {
        font-size: 0.85rem;
      }

      .print-small {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <main class="container py-4" x-data="appData()" x-init="init()">
    <div class="app-shell">
      <!-- Header -->
      <header class="mb-3">
        <div class="d-flex justify-content-between align-items-start gap-3">
          <div>
            <h1 class="app-title mb-1">4대보험 자동계산기</h1>
            <p class="app-subtitle mb-0">월 급여(보수월액)를 입력하면 국민연금/건강보험/장기요양/고용보험 및 합계를 자동 계산합니다.</p>
          </div>
          <div class="no-print d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary" @click="resetAll()">초기화</button>
            <button type="button" class="btn btn-primary" @click="printReport()">인쇄</button>
          </div>
        </div>
      </header>

      <!-- Input -->
      <section class="mb-4" aria-labelledby="input-section-title">
        <h2 id="input-section-title" class="h5 mb-3">입력</h2>

        <form class="p-3 border rounded-3" @submit.prevent>
          <div class="form-grid">
            <div>
              <label for="monthly_salary" class="form-label fw-semibold">월 급여(보수월액)</label>
              <input
                id="monthly_salary"
                name="monthly_salary"
                type="number"
                class="form-control"
                inputmode="numeric"
                step="1"
                min="0"
                placeholder="예: 3500000"
                x-model="monthlySalaryInput"
                @input="onMonthlySalaryInput($event.target.value)"
                aria-describedby="monthly_salary_help monthly_salary_error"
                autocomplete="off"
              />
              <div id="monthly_salary_help" class="help-text mt-2 no-print">숫자만 입력하세요. (원 단위, 예: 3,500,000)</div>
              <div id="monthly_salary_error" class="text-danger mt-2" x-show="errorMsg" x-text="errorMsg" role="alert"></div>
            </div>

            <div class="no-print">
              <label class="form-label fw-semibold">빠른 입력</label>
              <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-sm btn-outline-primary" @click="setSalary(1000000)">1,000,000</button>
                <button type="button" class="btn btn-sm btn-outline-primary" @click="setSalary(3500000)">3,500,000</button>
                <button type="button" class="btn btn-sm btn-outline-primary" @click="setSalary(5000000)">5,000,000</button>
              </div>
              <div class="help-text mt-2">입력 즉시 자동 계산됩니다.</div>
            </div>
          </div>
        </form>
      </section>

      <!-- Results -->
      <section class="result-card" aria-labelledby="result-section-title">
        <div class="card-header p-3">
          <div class="d-flex justify-content-between align-items-start gap-3">
            <div>
              <h2 id="result-section-title" class="h5 mb-1">계산 결과</h2>
              <div class="meta-row print-small">
                <div>
                  <span class="badge-note">표시 금액은 원 단위 반올림</span>
                </div>
                <div>
                  <span class="me-2">인쇄 일시:</span>
                  <span x-text="printedAt || '—'" aria-live="polite"></span>
                </div>
              </div>
            </div>
            <div class="no-print">
              <button type="button" class="btn btn-outline-primary btn-sm" @click="recalculateNow()">계산하기</button>
            </div>
          </div>
        </div>

        <div class="p-3" aria-live="polite" aria-label="계산 결과 영역">
          <div class="table-responsive">
            <table class="result-table" aria-describedby="result-section-title">
              <thead>
                <tr>
                  <th scope="col" style="width: 30%">항목</th>
                  <th scope="col" style="width: 35%">산출식</th>
                  <th scope="col" style="width: 35%">금액</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="item">월 급여(보수월액)</td>
                  <td class="formula">C3</td>
                  <td class="amount" x-text="formatKRW(display.monthlySalary)"></td>
                </tr>
                <tr>
                  <td class="item">국민연금</td>
                  <td class="formula">=C3*0.045</td>
                  <td class="amount" x-text="formatKRW(display.nationalPension)"></td>
                </tr>
                <tr>
                  <td class="item">건강보험</td>
                  <td class="formula">=C3*0.03545</td>
                  <td class="amount" x-text="formatKRW(display.healthInsurance)"></td>
                </tr>
                <tr>
                  <td class="item">장기요양보험</td>
                  <td class="formula">=C5*0.1281</td>
                  <td class="amount" x-text="formatKRW(display.longTermCare)"></td>
                </tr>
                <tr>
                  <td class="item">고용보험</td>
                  <td class="formula">=C3*0.009</td>
                  <td class="amount" x-text="formatKRW(display.employmentInsurance)"></td>
                </tr>
                <tr class="total-row">
                  <td class="item">4대보험 합계</td>
                  <td class="formula">=C4+C5+C6+C7</td>
                  <td class="amount" x-text="formatKRW(display.totalInsurance)"></td>
                </tr>
                <tr>
                  <td class="item">보험 공제 후 금액</td>
                  <td class="formula">=C3-C8</td>
                  <td class="amount" x-text="formatKRW(display.netAfterInsurance)"></td>
                </tr>
              </tbody>
            </table>
          </div>

          <p class="help-text mt-3 mb-0 no-print">
            참고: 이 계산기는 요청서에 포함된 엑셀 수식을 그대로 변환했습니다. 실제 고지/정산 기준(상한/하한, 사업장/근로자 부담분 등)은 기관 고시에 따라 달라질 수 있습니다.
          </p>
        </div>
      </section>

      <footer class="mt-4 no-print">
        <div class="help-text">
          입력 셀 매핑: monthly_salary → C3 / 출력 셀 매핑: C4~C9
        </div>
      </footer>
    </div>
  </main>

  <script>
    /* ===== Excel formula helper functions (tool-provided) ===== */
    function _sum(...args) {
        return args.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
    }

    function _sumRange(rangeData) {
        if (Array.isArray(rangeData)) {
            return rangeData.flat().reduce((a, b) => (parseFloat(a) || 0) + (parseFloat(b) || 0), 0);
        }
        return parseFloat(rangeData) || 0;
    }

    function _average(...args) {
        const flat = args.flat().filter(x => x !== null && x !== '' && !isNaN(x));
        return flat.length ? _sum(...flat) / flat.length : 0;
    }

    function _averageRange(rangeData) {
        if (Array.isArray(rangeData)) {
            const flat = rangeData.flat().filter(x => x !== null && x !== '' && !isNaN(x));
            return flat.length ? _sumRange(flat) / flat.length : 0;
        }
        return parseFloat(rangeData) || 0;
    }

    function _count(...args) {
        return args.flat().filter(x => typeof x === 'number' && !isNaN(x)).length;
    }

    function _counta(...args) {
        return args.flat().filter(x => x !== null && x !== '' && x !== undefined).length;
    }

    function _and(...args) {
        return args.every(x => Boolean(x));
    }

    function _or(...args) {
        return args.some(x => Boolean(x));
    }

    function _round(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.round(num * factor) / factor;
    }

    function _roundUp(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.ceil(num * factor) / factor;
    }

    function _roundDown(num, digits = 0) {
        const factor = Math.pow(10, digits);
        return Math.floor(num * factor) / factor;
    }

    function _len(text) {
        return String(text).length;
    }

    function _left(text, numChars = 1) {
        return String(text).substring(0, numChars);
    }

    function _right(text, numChars = 1) {
        const str = String(text);
        return str.substring(str.length - numChars);
    }

    function _mid(text, startNum, numChars) {
        return String(text).substring(startNum - 1, startNum - 1 + numChars);
    }

    function _trim(text) {
        return String(text).trim();
    }

    function _upper(text) {
        return String(text).toUpperCase();
    }

    function _lower(text) {
        return String(text).toLowerCase();
    }

    function _concat(...args) {
        return args.join('');
    }

    // Number formatting
    function formatNumber(num, decimals = 0) {
        return new Intl.NumberFormat('ko-KR', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(num);
    }

    function formatCurrency(num) {
        return new Intl.NumberFormat('ko-KR', {
            style: 'currency',
            currency: 'KRW',
            maximumFractionDigits: 0
        }).format(num);
    }

    function formatPercent(num, decimals = 1) {
        return new Intl.NumberFormat('ko-KR', {
            style: 'percent',
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(num / 100);
    }

    /* ===== App logic ===== */

    // Debounce helper
    function debounce(fn, wait = 150) {
      let t = null;
      return function(...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    // Function: formatKRW(value:number)
    function formatKRW(value) {
      const n = Number(value);
      if (!isFinite(n)) return '—';
      // Display as rounded KRW with suffix "원" (per spec)
      return `${new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(Math.round(n))}원`;
    }

    // Function: calculateInsurance(monthlySalary:number)
    // Excel mapping: C3 input, outputs C4~C9
    // Converted formulas (tool output):
    //  C4: data['C3']*0.045
    //  C5: data['C3']*0.03545
    //  C6: data['C5']*0.1281
    //  C7: data['C3']*0.009
    //  C8: data['C4']+data['C5']+data['C6']+data['C7']
    //  C9: data['C3']-data['C8']
    function calculateInsurance(monthlySalary) {
      const ms = Number(monthlySalary);
      const data = {
        'C3': isFinite(ms) ? ms : 0,
        'C4': 0,
        'C5': 0,
        'C6': 0,
        'C7': 0,
        'C8': 0,
        'C9': 0,
      };

      // Compute in dependency order
      data['C4'] = data['C3'] * 0.045;
      data['C5'] = data['C3'] * 0.03545;
      data['C6'] = data['C5'] * 0.1281;
      data['C7'] = data['C3'] * 0.009;
      data['C8'] = data['C4'] + data['C5'] + data['C6'] + data['C7'];
      // NOTE: 요청서/원본 엑셀 수식에 따라 C9는 =C3-C8 로 확정 기재되어 있어 그대로 반영
      data['C9'] = data['C3'] - data['C8'];

      return {
        monthlySalary: data['C3'],
        nationalPension: data['C4'],
        healthInsurance: data['C5'],
        longTermCare: data['C6'],
        employmentInsurance: data['C7'],
        totalInsurance: data['C8'],
        netAfterInsurance: data['C9'],
        _cells: data,
      };
    }

    function appData() {
      return {
        // Raw input (string to preserve empty state)
        monthlySalaryInput: '',

        // Validation / state
        errorMsg: '',
        printedAt: '',

        // Calculated numeric values (not rounded)
        calc: {
          monthlySalary: 0,
          nationalPension: 0,
          healthInsurance: 0,
          longTermCare: 0,
          employmentInsurance: 0,
          totalInsurance: 0,
          netAfterInsurance: 0,
        },

        // Display values (numeric, may mirror calc; formatted in template)
        display: {
          monthlySalary: 0,
          nationalPension: 0,
          healthInsurance: 0,
          longTermCare: 0,
          employmentInsurance: 0,
          totalInsurance: 0,
          netAfterInsurance: 0,
        },

        init() {
          // initial compute (all zeros)
          this.applyCalculation(0);
        },

        formatKRW,

        setSalary(v) {
          this.monthlySalaryInput = String(v);
          this.onMonthlySalaryInput(this.monthlySalaryInput);
        },

        resetAll() {
          this.monthlySalaryInput = '';
          this.errorMsg = '';
          this.printedAt = '';
          this.applyCalculation(0);
          // focus for accessibility
          const el = document.getElementById('monthly_salary');
          if (el) el.focus();
        },

        recalculateNow() {
          // Force immediate calculation from current input
          this.handleMonthlySalary(this.monthlySalaryInput);
        },

        onMonthlySalaryInput: debounce(function(value) {
          this.handleMonthlySalary(value);
        }, 150),

        handleMonthlySalary(value) {
          // Empty input: clear error, show zeros
          if (value === '' || value === null || typeof value === 'undefined') {
            this.errorMsg = '월 급여를 입력하세요.';
            this.applyCalculation(0);
            return;
          }

          const n = Number(value);
          if (!isFinite(n) || isNaN(n)) {
            this.errorMsg = '유효한 숫자를 입력하세요.';
            this.applyCalculation(0);
            return;
          }

          if (n < 0) {
            this.errorMsg = '월 급여는 0 이상이어야 합니다.';
            this.applyCalculation(0);
            return;
          }

          this.errorMsg = '';
          this.applyCalculation(n);
        },

        applyCalculation(monthlySalaryNumber) {
          const result = calculateInsurance(monthlySalaryNumber);
          this.calc = { ...result };

          // Keep display values as numeric (rounding is applied in formatting)
          this.display.monthlySalary = result.monthlySalary;
          this.display.nationalPension = result.nationalPension;
          this.display.healthInsurance = result.healthInsurance;
          this.display.longTermCare = result.longTermCare;
          this.display.employmentInsurance = result.employmentInsurance;
          this.display.totalInsurance = result.totalInsurance;
          this.display.netAfterInsurance = result.netAfterInsurance;
        },

        printReport() {
          // printedAt injected just before printing
          const d = new Date();
          const pad = (x) => String(x).padStart(2, '0');
          this.printedAt = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
          // allow DOM update
          setTimeout(() => window.print(), 50);
        },
      };
    }
  </script>
</body>
</html>
